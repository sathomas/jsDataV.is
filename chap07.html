<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="Cache-Control" content="no-transform">
        <!--[if lte IE 8]>
            <script>window.location.href='http://browsehappy.com';</script>
        <![endif]-->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Stephen Thomas <stephen@sathomas.me>">
        <meta name="mobile-web-app-capable" content="yes">
        <link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon.png">
        <link rel="shortcut icon" href="favicon.ico">
        <link rel="stylesheet" href="css/styles.min.css">
        <title>Data Visualization with JavaScript</title>
        <script>
            var chartStyles = {
                color: {
                    text:               "#444444",
                    primary:            "#CA0000",
                    primaryLightest:    "#FE4C4C",
                    primaryLight:       "#F71515",
                    primaryDark:        "#A50000",
                    primaryDarkest:     "#7B0000",
                    secondary:          "#007979",
                    secondaryLightest:  "#2D9999",
                    secondaryLight:     "#0D9494",
                    secondaryDark:      "#006363",
                    secondaryDarkest:   "#004A4A",
                    alternate:          "#7EBD00",
                    alternateLightest:  "#B6ED47",
                    alternateLight:     "#A0E714",
                    alternateDark:      "#679A00",
                    alternateDarkest:   "#4D7300",
                    tertiary:           "#CA5C00",
                    tertiaryLightest:   "#FE9D4C",
                    tertiaryLight:      "#F77B15",
                    tertiaryDark:       "#A54B00",
                    tertiaryDarkest:    "#7B3800",
                    quaternary:         "#A2005C",
                    quaternaryLightest: "#CC3D8E",
                    quaternaryLight:    "#C61177",
                    quaternaryDark:     "#85004B",
                    quaternaryDarkest:  "#630038",
                    blockBackground:    "#F5F5F5"
                },
                font: {
                    family:             "Varela, sans-serif"
                }
            };
        </script>

<!--
    Adjustments to styles and JavaScript just for screen
    captures to be used in printed book.
 -->

<script>

    // Adjustments only active if page is loaded from
    // the local file system.

    if (window.location.protocol === "file:") {

        // Update the properties used by JavaScript code
        // to create the live visualizations.

        chartStyles.color.text = "#000000";
        chartStyles.font.family = "Avenir";

        var css = document.createElement('style');
        css.type = 'text/css';
        var styles = "figure, .no-font-feature-settings figure, .no-font-feature-settings figure .lgcp {color: black; font-family: Avenir;}";

        if (css.styleSheet) { css.styleSheet.cssText = styles; }
        else                { css.appendChild(document.createTextNode(styles)); }

        document.getElementsByTagName("head")[0].appendChild(css);

        document.getElementsByTagName('html')[0].classList.add("localfile");

    }

</script>

    </head>
    <body class="fade fadeOut">
        <div id="nav-target"></div>
        <nav>
            <ul>
                <li>
                    <a href="index.html" alt="jsDataV.is" title="jsDataV.is">
                        <svg width="32px" height="32px" viewBox="0 0 32 32">
                            <title>jsDataV.is</title>
                            <g class="jsdatavis-logo">
                                <path d="M22.5,2.5 L16.5,15.5" ></path>
                                <path d="M28.5,24.5 L16.5,15.5"></path>
                                <path d="M9.5,28.5 L16.5,15.5" ></path>
                                <path d="M2.5,18.5 L16.5,15.5" ></path>
                                <circle cx="9"  cy="29" r="3"></circle>
                                <circle cx="3"  cy="18" r="3"></circle>
                                <circle cx="29" cy="25" r="3"></circle>
                                <circle cx="22" cy="3"  r="3"></circle>
                                <circle cx="17" cy="15" r="6"></circle>
                            </g>
                        </svg>
                    </a>
                </li>
                <li id="contents">Contents ▾
                    <ol>
                        <li><a href="intro.html" >Introduction</a></li>
                        <li><a href="chap01.html"><span class="lgcp">1</span>: Graphing Data</a></li>
                        <li><a href="chap02.html"><span class="lgcp">2</span>: Making Charts Interactive</a></li>
                        <li><a href="chap03.html"><span class="lgcp">3</span>: Integrating Charts on a Page</a></li>
                        <li><a href="chap04.html"><span class="lgcp">4</span>: Creating Specialized Graphs</a></li>
                        <li><a href="chap05.html"><span class="lgcp">5</span>: Showing Timelines</a></li>
                        <li><a href="chap06.html"><span class="lgcp">6</span>: Visualizing Geographic Data</a></li>
                        <li><a href="chap07.html"><span class="lgcp">7</span>: Custom Visualizations with D3.js</a></li>
                        <li><a href="apndA.html" ><span class="lgcp">A</span>: Managing Data in the Browser</a></li>
                        <li><a href="apndB.html" ><span class="lgcp">B</span>: Building Data-Driven Applications</a></li>
                    </ol>
                </li>
            </ul>
        </nav>
        <main>

<style>
body { counter-reset: chapter 7; }
</style>

<h1 id="chapter-7-custom-visualizations-with-d3.js">Chapter 7: Custom Visualizations with D3.js</h1>
<p>In this book we’ve looked at many different JavaScript libraries that were designed for specific types of visualizations. If you need a certain type visualization for your web page and there’s a library that can create it, using that library is often the quickest and easiest way to create your visualization. There are drawbacks to such libraries, however. They all make assumptions about how the visualization should look and act, and despite the configuration options they provide, you don’t have complete control over the results. Sometimes that’s not an acceptable trade-off.</p>
<p>In this chapter we’ll look at an entirely different approach to JavaScript visualizations, one that allows us to be creative and to retain complete control over the results. As you might expect, that approach isn’t always as easy as, for example, adding a charting library and feeding it data. Fortunately, there is a very powerful JavaScript library that can help: <a href="http://d3js.org"><span class="smcp">D3</span>.js</a>. <span class="lgcp">D3</span>.js doesn’t provide predefined visualizations such as charts, graphs, or maps. Instead, it’s a toolbox for data visualization, and it gives you the tools to create <em>your own</em> charts, graphs, maps, and more.</p>
<p>To see some of the powerful features of <span class="smcp">D3</span>.js, we’ll take a whirlwind tour. This chapter’s examples include:</p>
<ul>
<li>Creating a custom chart not available in an off-the-shelf library.</li>
<li>Building a force-directed graph that responds to user interactions.</li>
<li>Displaying map-based data using high-quality Scalable Vector Graphics.</li>
</ul>
<h2 id="creating-a-custom-chart">Creating a Custom Chart</h2>
<p>The most significant difference between <span class="smcp">D3</span>.js and other JavaScript libraries is its philosophy. <span class="lgcp">D3</span>.js is not a tool for creating predefined types of charts and visualizations. Instead, it’s a library to help your create any visualization, including custom and unique presentations. It takes more effort to create a standard chart with <span class="smcp">D3</span>.js, but by using it we’re not limited to standard charts. To get a sense of how <span class="smcp">D3</span>.js works, we can create a custom chart that wouldn’t be possible with a typical charting library.</p>
<p>For this example, we’ll visualize one of the most important findings in modern physics—Hubble’s Law. According to that law, the universe is expanding, and as a result, the speed at which we perceive distant galaxies to be moving varies according to their distance from us. More precisely, Hubble’s Law proposes that the variation, or shift, in this speed is a linear function of distance. To visualize the law, we can chart the speed variation (known as <em>red shift velocity</em>) versus distance for several galaxies. If Hubble is right the chart should look like a line. For our data, we’ll use galaxies and clusters from Hubble’s original <a href="http://www.pnas.org/content/15/3/168.full">1929 paper</a> but updated with current values for distance and red shift velocities.</p>
<p>So far this task seems like a good match for a scatter plot. Distance could serve as the x-axis and velocity the y-axis. There’s a twist, though: physicists don’t actually know the distances or velocities that we want to chart, at least not exactly. The best they can do is estimate those values, and there is potential for error in both. But that’s no reason to abandon the effort. In fact, potential errors in the values might be an important aspect for us to highlight in our visualization. To do that, we won’t draw each value as a point. Rather, we’ll show it as a box, and the box dimensions will correspond to the potential errors in the value.</p>
<h3 id="step-1-prepare-the-data">Step 1: Prepare the Data</h3>
<p>Here is the data for our chart according to recent estimates.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Nebulae/Cluster</th>
<th style="text-align: left;">Distance</th>
<th style="text-align: left;">Red Shift Velocity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">NGC 6822</td>
<td style="text-align: left;">0.500±0.010 Mpc</td>
<td style="text-align: left;">57±2 km/s</td>
</tr>
<tr class="even">
<td style="text-align: left;">NGC 221</td>
<td style="text-align: left;">0.763±0.024 Mpc</td>
<td style="text-align: left;">200±6 km/s</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NGC 598</td>
<td style="text-align: left;">0.835±0.105 Mpc</td>
<td style="text-align: left;">179±3 km/s</td>
</tr>
<tr class="even">
<td style="text-align: left;">NGC 4736</td>
<td style="text-align: left;">4.900±0.400 Mpc</td>
<td style="text-align: left;">308±1 km/s</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NGC 5457</td>
<td style="text-align: left;">6.400±0.500 Mpc</td>
<td style="text-align: left;">241±2 km/s</td>
</tr>
<tr class="even">
<td style="text-align: left;">NGC 4258</td>
<td style="text-align: left;">7.000±0.500 Mpc</td>
<td style="text-align: left;">448±3 km/s</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NGC 5194</td>
<td style="text-align: left;">7.100±1.200 Mpc</td>
<td style="text-align: left;">463±3 km/s</td>
</tr>
<tr class="even">
<td style="text-align: left;">NGC 4826</td>
<td style="text-align: left;">7.400±0.610 Mpc</td>
<td style="text-align: left;">408±4 km/s</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NGC 3627</td>
<td style="text-align: left;">11.000±1.500 Mpc</td>
<td style="text-align: left;">727±3 km/s</td>
</tr>
<tr class="even">
<td style="text-align: left;">NGC 7331</td>
<td style="text-align: left;">12.200±1.000 Mpc</td>
<td style="text-align: left;">816±1 km/s</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NGC 4486</td>
<td style="text-align: left;">16.400±0.500 Mpc</td>
<td style="text-align: left;">1307±7 km/s</td>
</tr>
<tr class="even">
<td style="text-align: left;">NGC 4649</td>
<td style="text-align: left;">16.800±1.200 Mpc</td>
<td style="text-align: left;">1117±6 km/s</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NGC 4472</td>
<td style="text-align: left;">17.100±1.200 Mpc</td>
<td style="text-align: left;">729±2 km/s</td>
</tr>
</tbody>
</table>
<p>We can represent that in JavaScript using the following array.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">hubble_data = [
    { <span class="dt">nebulae</span>: <span class="st">&quot;NGC 6822&quot;</span>, <span class="dt">distance</span>:  <span class="fl">0.500</span>, <span class="dt">distance_error</span>: <span class="fl">0.010</span>,
      <span class="dt">velocity</span>:   <span class="dv">57</span>, <span class="dt">velocity_error</span>: <span class="dv">2</span>, },
    { <span class="dt">nebulae</span>: <span class="st">&quot;NGC  221&quot;</span>, <span class="dt">distance</span>:  <span class="fl">0.763</span>, <span class="dt">distance_error</span>: <span class="fl">0.024</span>,
      <span class="dt">velocity</span>:  <span class="dv">200</span>, <span class="dt">velocity_error</span>: <span class="dv">6</span>, },
    { <span class="dt">nebulae</span>: <span class="st">&quot;NGC  598&quot;</span>, <span class="dt">distance</span>:  <span class="fl">0.835</span>, <span class="dt">distance_error</span>: <span class="fl">0.105</span>,
      <span class="dt">velocity</span>:  <span class="dv">179</span>, <span class="dt">velocity_error</span>: <span class="dv">3</span>, },
    <span class="co">// Data set continues...</span></code></pre></td></tr></table>
<h3 id="step-2-set-up-the-web-page">Step 2: Set Up the Web Page</h3>
<p><span class="lgcp">D3</span>.js doesn’t depend on any other libraries, and it’s available on most content distribution networks. All we need to do is include it in the page (line 9). We’ll also want to set up a container for the visualization, so our markup includes a <code>&lt;div&gt;</code> with the id <code>&quot;container&quot;</code> on line 8.</p>
<table class="sourceCode html numberLines line-8 line-9"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
<span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">&quot;en&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;head&gt;</span>
    <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;title&gt;&lt;/title&gt;</span>
  <span class="kw">&lt;/head&gt;</span>
  <span class="kw">&lt;body&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>
    <span class="kw">&lt;script</span> 
<span class="ot">      src=</span><span class="st">&quot;//cdnjs.cloudflare.com/ajax/libs/d3/3.4.6/d3.min.js&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;/script&gt;</span>
  <span class="kw">&lt;/body&gt;</span>
<span class="kw">&lt;/html&gt;</span></code></pre></td></tr></table>
<h3 id="step-3-create-a-stage-for-the-visualization">Step 3: Create a Stage for the Visualization</h3>
<p>Unlike higher-level libraries, <span class="smcp">D3</span>.js doesn’t draw the visualization on the page. We’ll have to do that ourselves. In exchange for the additional effort, though, we get the freedom to pick our own drawing technology. We could follow the same approach as most libraries in this book and use <span class="smcp">HTML5</span>’s <code>&lt;canvas&gt;</code> element, or we could simply use native <span class="smcp">HTML</span>. Now that we’ve seen it in action in chapter 6, however, it seems Scalable Vector Graphics (<span class="smcp">SVG</span>) is the best approach for our chart. The root of our graph, therefore, will be an <code>&lt;svg&gt;</code> element, and we need to add that to the page. We can define its dimensions at the same time using attributes.</p>
<p>If we were using jQuery, we might do something like the following:</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> svg = <span class="fu">$</span>(<span class="st">&quot;&lt;svg&gt;&quot;</span>).<span class="fu">attr</span>(<span class="st">&quot;height&quot;</span>, height).<span class="fu">attr</span>(<span class="st">&quot;width&quot;</span>, width);
<span class="fu">$</span>(<span class="st">&quot;#container&quot;</span>).<span class="fu">append</span>(svg);</code></pre></td></tr></table>
<p>With <span class="smcp">D3</span>.js our code is very similar:</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> svg = <span class="ot">d3</span>.<span class="fu">select</span>(<span class="st">&quot;#container&quot;</span>).<span class="fu">append</span>(<span class="st">&quot;svg&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;height&quot;</span>, height)
    .<span class="fu">attr</span>(<span class="st">&quot;width&quot;</span>, width);</code></pre></td></tr></table>
<p>With this statement we’re selecting the container, appending an <code>&lt;svg&gt;</code> element to it, and setting the attributes of that <code>&lt;svg&gt;</code> element. This statement highlights one important difference between <span class="smcp">D3</span>.js and jQuery that often trips up developers starting out with <span class="smcp">D3</span>.js. In jQuery the <code>append()</code> method returns the original selection so that you can continue operating on that selection. More specifically, <code>$(&quot;#container&quot;).append(svg)</code> returns <code>$(&quot;#container&quot;)</code>.</p>
<p>With <span class="smcp">D3</span>.js, on the other hand, <code>append()</code> returns a different selection, the newly appended element(s). So <code>d3.select(&quot;#container&quot;).append(&quot;svg&quot;)</code> doesn’t return the container selection but rather a selection of the new <code>&lt;svg&gt;</code> element. The <code>attr()</code> calls that follow, therefore, apply to the <code>&lt;svg&gt;</code> element and not the <code>&quot;#container&quot;</code>.</p>
<h3 id="step-4-control-the-charts-dimensions">Step 4: Control the Chart’s Dimensions</h3>
<p>So far we haven’t specified the actual values for the chart’s height and width; we’ve only used <code>height</code> and <code>width</code> variables. Having the dimensions in variables will come in handy, and it will make it easy to incorporate margins in the visualization. The code below sets up those dimensions; its form is a common convention in <span class="smcp">D3</span>.js visualizations.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> margin = {<span class="dt">top</span>: <span class="dv">20</span>, <span class="dt">right</span>: <span class="dv">20</span>, <span class="dt">bottom</span>: <span class="dv">30</span>, <span class="dt">left</span>: <span class="dv">40</span>},
    width = <span class="dv">640</span> - <span class="ot">margin</span>.<span class="fu">left</span> - <span class="ot">margin</span>.<span class="fu">right</span>,
    height = <span class="dv">400</span> - <span class="ot">margin</span>.<span class="fu">top</span> - <span class="ot">margin</span>.<span class="fu">bottom</span>;</code></pre></td></tr></table>
<p>We’ll have to adjust the code that creates the main <code>&lt;svg&gt;</code> container to account for these margins.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> svg = <span class="ot">d3</span>.<span class="fu">select</span>(<span class="st">&quot;#chart1&quot;</span>).<span class="fu">append</span>(<span class="st">&quot;svg&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;height&quot;</span>, height + <span class="ot">margin</span>.<span class="fu">left</span> + <span class="ot">margin</span>.<span class="fu">right</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;width&quot;</span>, width + <span class="ot">margin</span>.<span class="fu">top</span> + <span class="ot">margin</span>.<span class="fu">bottom</span>);</code></pre></td></tr></table>
<p>To make sure our chart honors the defined margins, we’ll construct it entirely within a child <span class="smcp">SVG</span> group (<code>&lt;g&gt;</code>) element. The <code>&lt;g&gt;</code> element is just an arbitrary containing element in <span class="smcp">SVG</span>, much like the <code>&lt;div&gt;</code> element for <span class="smcp">HTML</span>. We can use <span class="smcp">D3</span>.js to create the element and position it appropriately within the main <code>&lt;svg&gt;</code> element.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> chart = <span class="ot">svg</span>.<span class="fu">append</span>(<span class="st">&quot;g&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;transform&quot;</span>, 
        <span class="st">&quot;translate(&quot;</span> + <span class="ot">margin</span>.<span class="fu">left</span> + <span class="st">&quot;,&quot;</span> + <span class="ot">margin</span>.<span class="fu">top</span> + <span class="st">&quot;)&quot;</span>
    );</code></pre></td></tr></table>
<p>Visualizations must often rescale the source data. In our case, we’ll need to rescale the data to fit within the chart dimensions. Instead of ranging from 0.5 to 17 Mpc, for example, galactic distance should be scaled between 0 and 920 pixels. Since this type of requirement is common for visualizations, <span class="smcp">D3</span>.js has tools to help. Not surprisingly, they’re <code>scale</code> objects. We’ll create scales for both the x- and the y-dimensions.</p>
<p>As the code below indicates, both of our scales are linear. Linear transformations are pretty simple (and we really don’t need <span class="smcp">D3</span>.js to manage them); however, <span class="smcp">D3</span>.js supports other types of scales that can be quite complex. With <span class="smcp">D3</span>.js using more sophisticated scaling is just as easy as using linear scales.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> xScale = <span class="ot">d3</span>.<span class="ot">scale</span>.<span class="fu">linear</span>()
    .<span class="fu">range</span>([<span class="dv">0</span>,width]);
<span class="kw">var</span> yScale = <span class="ot">d3</span>.<span class="ot">scale</span>.<span class="fu">linear</span>()
    .<span class="fu">range</span>([height,<span class="dv">0</span>]);</code></pre></td></tr></table>
<p>We define both ranges as the desired limits for each scale. The x-scale ranges from 0 to the chart’s width, and the y-scale ranges from 0 to the chart’s height. Note, though, that we’ve reversed the normal order for the y-scale. That’s because <span class="smcp">SVG</span> dimensions (just like <span class="smcp">HTML</span> dimensions) place 0 at the top of the area. That convention is the opposite of the normal chart convention which places 0 at the bottom. To account for the reversal, we swap the values when defining the range.</p>
<p>At this point we’ve set the ranges for each scale, and those ranges define the desired output. We also have to specify the possible inputs to each scale, which <span class="smcp">D3</span>.js calls the <em>domain.</em> Those inputs are the minimum and maximum values for the distance and velocity. We can use <span class="smcp">D3</span>.js to extract the values directly from the data. Here’s how to get the minimum distance:</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> minDist = <span class="ot">d3</span>.<span class="fu">min</span>(hubble_data, <span class="kw">function</span>(nebulae) { 
    <span class="kw">return</span> <span class="ot">nebulae</span>.<span class="fu">distance</span> - <span class="ot">nebulae</span>.<span class="fu">distance_error</span>;
});</code></pre></td></tr></table>
<p>We can’t simply find the minimum value in the data because we have to account for the distance error. As we can see above, <span class="smcp">D3</span>.js accepts a function as a parameter to <code>d3.min()</code>, and that function can make the necessary adjustment. We can use the same approach for maximum values as well. Here’s the complete code for defining the domains of both scales:</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">xScale</span>.<span class="fu">domain</span>([
        <span class="ot">d3</span>.<span class="fu">min</span>(hubble_data, <span class="kw">function</span>(nebulae) { 
            <span class="kw">return</span> <span class="ot">nebulae</span>.<span class="fu">distance</span> - <span class="ot">nebulae</span>.<span class="fu">distance_error</span>; 
        }),
        <span class="ot">d3</span>.<span class="fu">max</span>(hubble_data, <span class="kw">function</span>(nebulae) { 
            <span class="kw">return</span> <span class="ot">nebulae</span>.<span class="fu">distance</span> + <span class="ot">nebulae</span>.<span class="fu">distance_error</span>; 
        })
    ])
    .<span class="fu">nice</span>();
<span class="ot">yScale</span>.<span class="fu">domain</span>([
        <span class="ot">d3</span>.<span class="fu">min</span>(hubble_data, <span class="kw">function</span>(nebulae) { 
            <span class="kw">return</span> <span class="ot">nebulae</span>.<span class="fu">velocity</span> - <span class="ot">nebulae</span>.<span class="fu">velocity_error</span>; 
        }),
        <span class="ot">d3</span>.<span class="fu">max</span>(hubble_data, <span class="kw">function</span>(nebulae) { 
            <span class="kw">return</span> <span class="ot">nebulae</span>.<span class="fu">velocity</span> + <span class="ot">nebulae</span>.<span class="fu">velocity_error</span>; 
        })
    ])
    .<span class="fu">nice</span>();</code></pre></td></tr></table>
<h3 id="step-5-draw-the-chart-framework">Step 5: Draw the Chart Framework</h3>
<p>Axes are another common feature in visualizations, and <span class="smcp">D3</span>.js has tools for those as well. To create the axes for our chart, we specify the appropriate scales and an orientation. As you can see from the code below, <span class="smcp">D3</span>.js supports axes as part of its <span class="smcp">SVG</span> utilities.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> xAxis = <span class="ot">d3</span>.<span class="ot">svg</span>.<span class="fu">axis</span>()
    .<span class="fu">scale</span>(xScale)
    .<span class="fu">orient</span>(<span class="st">&quot;bottom&quot;</span>);
<span class="kw">var</span> yAxis = <span class="ot">d3</span>.<span class="ot">svg</span>.<span class="fu">axis</span>()
    .<span class="fu">scale</span>(yScale)
    .<span class="fu">orient</span>(<span class="st">&quot;left&quot;</span>);</code></pre></td></tr></table>
<p>After defining the axes, we can use <span class="smcp">D3</span>.js to add the appropriate <span class="smcp">SVG</span> elements to the page. We’ll contain each axis within its own <code>&lt;g&gt;</code> group. For the x-axis, we need to shift that group to the bottom of the chart.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> xAxisGroup = <span class="ot">chart</span>.<span class="fu">append</span>(<span class="st">&quot;g&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;transform&quot;</span>, <span class="st">&quot;translate(0,&quot;</span> + height + <span class="st">&quot;)&quot;</span>);</code></pre></td></tr></table>
<p>To create the <span class="smcp">SVG</span> elements that make up the axis, we could call the <code>xAxis</code> object and pass it the containing group as a parameter.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="fu">xAxis</span>(xAxisGroup);</code></pre></td></tr></table>
<p>With <span class="smcp">D3</span>.js, though, there’s a more concise expression that avoids creating unnecessary local variables and preserves method chaining.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">chart</span>.<span class="fu">append</span>(<span class="st">&quot;g&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;transform&quot;</span>, <span class="st">&quot;translate(0,&quot;</span> + height + <span class="st">&quot;)&quot;</span>)
    .<span class="fu">call</span>(xAxis);</code></pre></td></tr></table>
<p>And as long as we’re preserving method chaining, we can take advantage of it to add yet another element to our chart: this time, it’s the label for the axis.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">chart</span>.<span class="fu">append</span>(<span class="st">&quot;g&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;transform&quot;</span>, <span class="st">&quot;translate(0,&quot;</span> + height + <span class="st">&quot;)&quot;</span>)
    .<span class="fu">call</span>(xAxis)
  .<span class="fu">append</span>(<span class="st">&quot;text&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;x&quot;</span>, width)
    .<span class="fu">attr</span>(<span class="st">&quot;y&quot;</span>, -<span class="dv">6</span>)
    .<span class="fu">style</span>(<span class="st">&quot;text-anchor&quot;</span>, <span class="st">&quot;end&quot;</span>)
    .<span class="fu">text</span>(<span class="st">&quot;Distance (Mpc)&quot;</span>);</code></pre></td></tr></table>
<p>If you look under the hood, you’ll find that <span class="smcp">D3</span>.js has done quite a bit of work for us in creating the axis, its tick marks, and its labels. Here’s a taste of the <span class="smcp">SVG</span> it builds.</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="kw">&lt;g</span><span class="ot"> class=</span><span class="st">&quot;x axis&quot;</span><span class="ot"> transform=</span><span class="st">&quot;translate(0,450)&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;g</span><span class="ot"> class=</span><span class="st">&quot;tick&quot;</span><span class="ot"> transform=</span><span class="st">&quot;translate(0,0)&quot;</span><span class="ot"> style=</span><span class="st">&quot;opacity: 1;&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;line</span><span class="ot"> y2=</span><span class="st">&quot;6&quot;</span><span class="ot"> x2=</span><span class="st">&quot;0&quot;</span><span class="kw">&gt;&lt;/line&gt;</span>
        <span class="kw">&lt;text</span><span class="ot"> y=</span><span class="st">&quot;9&quot;</span><span class="ot"> x=</span><span class="st">&quot;0&quot;</span><span class="ot"> dy=</span><span class="st">&quot;.71em&quot;</span><span class="ot"> style=</span><span class="st">&quot;text-anchor: middle;&quot;</span><span class="kw">&gt;</span>0<span class="kw">&lt;/text&gt;</span>
    <span class="kw">&lt;/g&gt;</span>
    <span class="kw">&lt;g</span><span class="ot"> class=</span><span class="st">&quot;tick&quot;</span><span class="ot"> transform=</span><span class="st">&quot;translate(77.77,0)&quot;</span><span class="ot"> style=</span><span class="st">&quot;opacity: 1;&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;line</span><span class="ot"> y2=</span><span class="st">&quot;6&quot;</span><span class="ot"> x2=</span><span class="st">&quot;0&quot;</span><span class="kw">&gt;&lt;/line&gt;</span>
        <span class="kw">&lt;text</span><span class="ot"> y=</span><span class="st">&quot;9&quot;</span><span class="ot"> x=</span><span class="st">&quot;0&quot;</span><span class="ot"> dy=</span><span class="st">&quot;.71em&quot;</span><span class="ot"> style=</span><span class="st">&quot;text-anchor: middle;&quot;</span><span class="kw">&gt;</span>2<span class="kw">&lt;/text&gt;</span>
    <span class="kw">&lt;/g&gt;</span>
    <span class="co">&lt;!-- Additional Tick Marks... --&gt;</span>
    <span class="kw">&lt;path</span><span class="ot"> class=</span><span class="st">&quot;domain&quot;</span><span class="ot"> d=</span><span class="st">&quot;M0,6V0H700V6&quot;</span><span class="kw">&gt;&lt;/path&gt;</span>
    <span class="kw">&lt;text</span><span class="ot"> x=</span><span class="st">&quot;700&quot;</span><span class="ot"> y=</span><span class="st">&quot;-6&quot;</span><span class="ot"> style=</span><span class="st">&quot;text-anchor: end;&quot;</span><span class="kw">&gt;</span>Distance (Mpc)<span class="kw">&lt;/text&gt;</span>
<span class="kw">&lt;/g&gt;</span></code></pre></td></tr></table>
<p>When we add the code for the y-axis, we’ve completed the framework for the chart.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">chart</span>.<span class="fu">append</span>(<span class="st">&quot;g&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;transform&quot;</span>, <span class="st">&quot;translate(0,&quot;</span> + height + <span class="st">&quot;)&quot;</span>)
    .<span class="fu">call</span>(xAxis)
  .<span class="fu">append</span>(<span class="st">&quot;text&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;x&quot;</span>, width)
    .<span class="fu">attr</span>(<span class="st">&quot;y&quot;</span>, -<span class="dv">6</span>)
    .<span class="fu">style</span>(<span class="st">&quot;text-anchor&quot;</span>, <span class="st">&quot;end&quot;</span>)
    .<span class="fu">text</span>(<span class="st">&quot;Distance (Mpc)&quot;</span>);

<span class="ot">chart</span>.<span class="fu">append</span>(<span class="st">&quot;g&quot;</span>)
    .<span class="fu">call</span>(yAxis)
  .<span class="fu">append</span>(<span class="st">&quot;text&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;transform&quot;</span>, <span class="st">&quot;rotate(-90)&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;y&quot;</span>, <span class="dv">6</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;dy&quot;</span>, <span class="st">&quot;.71em&quot;</span>)
    .<span class="fu">style</span>(<span class="st">&quot;text-anchor&quot;</span>, <span class="st">&quot;end&quot;</span>)
    .<span class="fu">text</span>(<span class="st">&quot;Red Shift Velocity (km/s)&quot;</span>)</code></pre></td></tr></table>
<p>The result of figure <span class="nextfigure"/> isn’t very exciting without any data, but it does give us a framework for the chart.</p>
<style>
svg { font: 16px; }

.axis path, .axis line {
  fill: none;
  stroke: #888;
  shape-rendering: crispEdges;
}
</style>
<figure>
<div id="chart1">

</div>
<figcaption>
<span class="lgcp">D3</span>.js provides tools to create the framework for a chart.
</figcaption>
</figure>
<p>As you can tell, we’ve had to write quite a bit of code just to get a couple of axes on the page. That’s the nature of <span class="smcp">D3</span>.js. It’s not a library to which you can simply pass a data set and get a chart as an output. Instead, think of it as a collection of very useful utilities that you can use to help create your own charts.</p>
<h3 id="step-6-add-the-data-to-the-chart">Step 6: Add the Data to the Chart</h3>
<p>Now that our chart’s framework is ready, we can add the actual data. Because we want to show both the distance and velocity errors in the data, we can draw each point as a rectangle. For a simple, static chart, we can add <span class="smcp">SVG</span> <code>&lt;rect&gt;</code> elements just as we’ve created the rest of the chart. We can take advantage of our x- and y-scales to calculate the dimensions of the rectangles.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">hubble_data</span>.<span class="fu">forEach</span>(<span class="kw">function</span>(nebulae) {
    <span class="ot">chart2</span>.<span class="fu">append</span>(<span class="st">&quot;rect&quot;</span>)
      .<span class="fu">attr</span>(<span class="st">&quot;x&quot;</span>, <span class="fu">xScale</span>(<span class="ot">nebulae</span>.<span class="fu">distance</span> - <span class="ot">nebulae</span>.<span class="fu">distance_error</span>))
      .<span class="fu">attr</span>(<span class="st">&quot;width&quot;</span>, <span class="fu">xScale</span>(<span class="dv">2</span> * <span class="ot">nebulae</span>.<span class="fu">distance_error</span>))
      .<span class="fu">attr</span>(<span class="st">&quot;y&quot;</span>, <span class="fu">yScale</span>(<span class="ot">nebulae</span>.<span class="fu">velocity</span> - <span class="ot">nebulae</span>.<span class="fu">velocity_error</span>))
      .<span class="fu">attr</span>(<span class="st">&quot;height&quot;</span>, height - <span class="fu">yScale</span>(<span class="dv">2</span> * <span class="ot">nebulae</span>.<span class="fu">velocity_error</span>));
});</code></pre></td></tr></table>
<p>The approach above works fine for this example and results in the chart of figure <span class="nextfigure"/>. Typically, however, <span class="smcp">D3</span>.js visualizations combine their data sets directly with markup elements and rely on <span class="smcp">D3</span>’s <code>enter</code>, <code>update</code>, and <code>exit</code> selections to add the data to the page. We’ll defer further discussion of this alternative approach until the next example.</p>
<figure>
<div id="chart2">

</div>
<figcaption>
<span class="lgcp">D3</span>.js can render the data elements using any valid markup, including <span class="smcp">SVG</span> &lt;rect&gt; elements with defined dimensions.
</figcaption>
</figure>
<h3 id="step-7-answer-users-questions">Step 7: Answer Users’ Questions</h3>
<p>Whenever you create a visualization, it’s a good idea to anticipate questions that users might ask when they view it. In our example so far, we’ve presented a data set that leads to Hubble’s Law. But we haven’t (yet) shown how well the data fits that law. Since that is such an obvious question, let’s answer it right on the chart itself.</p>
<p>The current estimate for the Hubble Constant (<span class="smcp">H0</span>) is about 70 km/s/Mpc. To show how that matches the data on our chart, we can create a line graph with that slope beginning at the point (0,0). A single <span class="smcp">SVG</span> <code>&lt;line&gt;</code> is all that’s required. Once again we rely on the <span class="smcp">D3</span>.js scales to define the line’s coordinates.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">chart</span>.<span class="fu">append</span>(<span class="st">&quot;line&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;x1&quot;</span>,<span class="fu">xScale</span>(<span class="dv">0</span>))
    .<span class="fu">attr</span>(<span class="st">&quot;y1&quot;</span>,<span class="fu">yScale</span>(<span class="dv">0</span>))
    .<span class="fu">attr</span>(<span class="st">&quot;x2&quot;</span>,<span class="fu">xScale</span>(<span class="dv">20</span>))
    .<span class="fu">attr</span>(<span class="st">&quot;y2&quot;</span>,<span class="fu">yScale</span>(<span class="dv">1400</span>));</code></pre></td></tr></table>
<p>In figure <span class="nextfigure"/> we can see that Hubble’s Law remains a good approximation.</p>
<figure>
<div id="chart3">

</div>
<figcaption>
The complete custom chart shows the data set exactly as we wish.
</figcaption>
</figure>
<script>
;(function(){

    draw = function() {

        var hubble_data = [
            { nebulae: "NGC 6822", distance:  0.500, distance_error: 0.010, velocity:   57, velocity_error: 2, },
            { nebulae: "NGC  221", distance:  0.763, distance_error: 0.024, velocity:  200, velocity_error: 6, },
            { nebulae: "NGC  598", distance:  0.835, distance_error: 0.105, velocity:  179, velocity_error: 3, },
            { nebulae: "NGC 4736", distance:  4.900, distance_error: 0.400, velocity:  308, velocity_error: 1, },
            { nebulae: "NGC 4258", distance:  7.000, distance_error: 0.500, velocity:  448, velocity_error: 3, },
            { nebulae: "NGC 5194", distance:  7.100, distance_error: 1.200, velocity:  463, velocity_error: 3, },
            { nebulae: "NGC 4826", distance:  7.400, distance_error: 0.610, velocity:  408, velocity_error: 4, },
            { nebulae: "NGC 3627", distance: 11.000, distance_error: 1.500, velocity:  727, velocity_error: 3, },
            { nebulae: "NGC 7331", distance: 12.200, distance_error: 1.000, velocity:  816, velocity_error: 1, },
            { nebulae: "NGC 4486", distance: 16.400, distance_error: 0.500, velocity: 1307, velocity_error: 7, },
            { nebulae: "NGC 4649", distance: 16.800, distance_error: 1.200, velocity: 1117, velocity_error: 6, },
        ];


        var margin = {top: 20, right: 20, bottom: 30, left: 40},
            width = 640 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        var svg1 = d3.select("#chart1").append("svg")
            .attr("height", height + margin.left + margin.right)
            .attr("width", width + margin.top + margin.bottom);

        var chart1 = svg1.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var xScale = d3.scale.linear()
            .range([0,width]);
        var yScale = d3.scale.linear()
            .range([height,0]);

        var xAxis = d3.svg.axis()
            .scale(xScale)
            .orient("bottom");
        var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient("left");
    
        xScale.domain([
                d3.min(hubble_data, function(nebulae) { return nebulae.distance - nebulae.distance_error; }),
                d3.max(hubble_data, function(nebulae) { return nebulae.distance + nebulae.distance_error; })
            ])
            .nice();

        yScale.domain([
                d3.min(hubble_data, function(nebulae) { return nebulae.velocity - nebulae.velocity_error; }),
                d3.max(hubble_data, function(nebulae) { return nebulae.velocity + nebulae.velocity_error; })
            ])
            .nice();

        chart1.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
          .append("text")
            .attr("x", width)
            .attr("y", -6)
            .style("text-anchor", "end")
            .text("Distance (Mpc)");

        chart1.append("g")
            .attr("class", "y axis")
            .call(yAxis)
          .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Red Shift Velocity (km/s)")

        var svg2 = d3.select("#chart2").append("svg")
            .attr("height", height + margin.left + margin.right)
            .attr("width", width + margin.top + margin.bottom);

        var chart2 = svg2.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        chart2.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
          .append("text")
            .attr("x", width)
            .attr("y", -6)
            .style("text-anchor", "end")
            .text("Distance (Mpc)");

        chart2.append("g")
            .attr("class", "y axis")
            .call(yAxis)
          .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Red Shift Velocity (km/s)")

        hubble_data.forEach(function(nebulae) {
            chart2.append("rect")
              .attr("x", xScale(nebulae.distance - nebulae.distance_error))
              .attr("width", xScale(2 * nebulae.distance_error))
              .attr("y", yScale(nebulae.velocity - nebulae.velocity_error))
              .attr("height", height - yScale(2 * nebulae.velocity_error))
              .style("fill", "red");
        });

        var svg3 = d3.select("#chart3").append("svg")
            .attr("height", height + margin.left + margin.right)
            .attr("width", width + margin.top + margin.bottom);

        var chart3 = svg3.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        chart3.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
          .append("text")
            .attr("x", width)
            .attr("y", -6)
            .style("text-anchor", "end")
            .text("Distance (Mpc)");

        chart3.append("g")
            .attr("class", "y axis")
            .call(yAxis)
          .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Red Shift Velocity (km/s)")

        hubble_data.forEach(function(nebulae) {
            chart3.append("rect")
              .attr("x", xScale(nebulae.distance - nebulae.distance_error))
              .attr("width", xScale(2 * nebulae.distance_error))
              .attr("y", yScale(nebulae.velocity - nebulae.velocity_error))
              .attr("height", height - yScale(2 * nebulae.velocity_error))
              .style("fill", "red");
        });

        chart3.append("line")
            .attr("x1",xScale(0))
            .attr("y1",yScale(0))
            .attr("x2",xScale(20))
            .attr("y2",yScale(1400))
            .style("stroke","#300083");
    };

    if (typeof contentLoaded != "undefined") {
        contentLoaded.done(draw);
    } else {
        window.addEventListener('load', draw);
    }

}());
</script>
<h2 id="creating-a-force-directed-network-graph">Creating a Force-Directed Network Graph</h2>
<p>Unlike the JavaScript plotting libraries we considered in the early chapters, <span class="smcp">D3</span>.js is not limited to standard charts. In fact, it excels at specialized and custom graph types. To see its power we’ll create another version of the network graph from Chapter 4. In the earlier implementation we used the sigmajs library, and most of our work was structuring the data into the format that library requires. We didn’t have to decide how to draw the nodes and edges, how to connect them, or, once we enabled layouts, how to position them on the page. As we’ll see below, <span class="smcp">D3</span>.js doesn’t make those decisions for us. For this example, we’ll have to draw the nodes and edges, connect them to each other appropriately, and position them on the page. That may sound like a lot of work, but, as we’ll also see, <span class="smcp">D3</span>.js gives us a lot of tools to help.</p>
<h3 id="step-1-prepare-the-data-1">Step 1: Prepare the Data</h3>
<p>Since we’re replicating the network graph from chapter 4, we start with the same data set.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> albums = [
  {
    <span class="dt">album</span>: <span class="st">&quot;Miles Davis - Kind of Blue&quot;</span>,
    <span class="dt">musicians</span>: [
      <span class="st">&quot;Cannonball Adderley&quot;</span>,
      <span class="st">&quot;Paul Chambers&quot;</span>,
      <span class="st">&quot;Jimmy Cobb&quot;</span>,
      <span class="st">&quot;John Coltrane&quot;</span>,
      <span class="st">&quot;Miles Davis&quot;</span>,
      <span class="st">&quot;Bill Evans&quot;</span>
    ]
  },{
    <span class="dt">album</span>: <span class="st">&quot;John Coltrane - A Love Supreme&quot;</span>,
    <span class="dt">musicians</span>: [
      <span class="st">&quot;John Coltrane&quot;</span>,
      <span class="st">&quot;Jimmy Garrison&quot;</span>,
      <span class="st">&quot;Elvin Jones&quot;</span>,
      <span class="st">&quot;McCoy Tyner&quot;</span>
    ]
  <span class="co">// Data set continues...</span></code></pre></td></tr></table>
<p>For the visualization it will be helpful to have two separate arrays, one for the graph’s nodes and a one for the graph’s edges. Extracting those arrays from the original data is straightforward, so we won’t bother looking at it in this chapter. You can, however, see the full implementation in the book’s source code. The result looks like the following:</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> nodes = [
  {
    <span class="st">&quot;name&quot;</span>: <span class="st">&quot;Miles Davis - Kind of Blue&quot;</span>,
    <span class="st">&quot;links&quot;</span>: [
      <span class="st">&quot;Cannonball Adderley&quot;</span>,
      <span class="st">&quot;Paul Chambers&quot;</span>,
      <span class="st">&quot;Jimmy Cobb&quot;</span>,
      <span class="st">&quot;John Coltrane&quot;</span>,
      <span class="st">&quot;Miles Davis&quot;</span>,
      <span class="st">&quot;Bill Evans&quot;</span>
    ],
    <span class="st">&quot;x&quot;</span>: <span class="dv">270</span>,
    <span class="st">&quot;y&quot;</span>: <span class="dv">200</span>
  },
  {
    <span class="st">&quot;name&quot;</span>: <span class="st">&quot;John Coltrane - A Love Supreme&quot;</span>,
    <span class="st">&quot;links&quot;</span>: [
      <span class="st">&quot;John Coltrane&quot;</span>,
      <span class="st">&quot;Jimmy Garrison&quot;</span>,
      <span class="st">&quot;Elvin Jones&quot;</span>,
      <span class="st">&quot;McCoy Tyner&quot;</span>
    ],
    <span class="st">&quot;x&quot;</span>: <span class="fl">307.303483</span>,
    <span class="st">&quot;y&quot;</span>: <span class="fl">195.287474</span>
  },
  <span class="co">// Data set continues...</span>
];</code></pre></td></tr></table>
<p>For the nodes, we’ve added <code>x</code> and <code>y</code> properties to define a position on the graph. Initially the code arbitrarily sets these values so that the nodes are positioned in a circle.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> edges = [
  {
    <span class="st">&quot;source&quot;</span>: <span class="dv">0</span>,
    <span class="st">&quot;target&quot;</span>: <span class="dv">16</span>,
    <span class="st">&quot;links&quot;</span>: [
      <span class="st">&quot;Cannonball Adderley&quot;</span>,
      <span class="st">&quot;Miles Davis&quot;</span>
    ]
  },
  {
    <span class="st">&quot;source&quot;</span>: <span class="dv">0</span>,
    <span class="st">&quot;target&quot;</span>: <span class="dv">6</span>,
    <span class="st">&quot;links&quot;</span>: [
      <span class="st">&quot;Paul Chambers&quot;</span>,
      <span class="st">&quot;John Coltrane&quot;</span>
    ]
  },
  <span class="co">// Data set continues...</span>
];</code></pre></td></tr></table>
<p>The edges indicate the two nodes that they connect as indices in the <code>nodes</code> array and they include an array of the individual musicians that are common between the albums.</p>
<h3 id="step-2-set-up-the-page">Step 2: Set Up the Page</h3>
<p>As we noted in the previous example, <span class="smcp">D3</span>.js doesn’t depend on any other libraries, and it’s available on most content distribution networks. All we need to do is include it in the page (line 9). We’ll also want to set up a container for the visualization, so our markup includes a <code>&lt;div&gt;</code> with the id <code>&quot;container&quot;</code> on line 8.</p>
<table class="sourceCode html numberLines line-8 line-9"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
<span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">&quot;en&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;head&gt;</span>
    <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;title&gt;&lt;/title&gt;</span>
  <span class="kw">&lt;/head&gt;</span>
  <span class="kw">&lt;body&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>
    <span class="kw">&lt;script</span> 
<span class="ot">      src=</span><span class="st">&quot;//cdnjs.cloudflare.com/ajax/libs/d3/3.4.6/d3.min.js&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;/script&gt;</span>
  <span class="kw">&lt;/body&gt;</span>
<span class="kw">&lt;/html&gt;</span></code></pre></td></tr></table>
<h3 id="step-3-create-a-stage-for-the-visualization-1">Step 3: Create a Stage for the Visualization</h3>
<p>This step is also the same as in the previous example. We ask <span class="smcp">D3</span>.js to select the container element and then insert an <code>&lt;svg&gt;</code> element within it. In addition to appending the <code>&lt;svg&gt;</code> element, we can define its size by setting the <code>height</code> and <code>width</code> attributes.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> svg = <span class="ot">d3</span>.<span class="fu">select</span>(<span class="st">&quot;#container&quot;</span>).<span class="fu">append</span>(<span class="st">&quot;svg&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;height&quot;</span>, <span class="dv">500</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;width&quot;</span>, <span class="dv">960</span>);</code></pre></td></tr></table>
<h3 id="step-4-draw-the-graphs-nodes">Step 4: Draw the Graph’s Nodes</h3>
<p>We’ll draw each node as a circle by appending <code>&lt;circle&gt;</code> elements inside the <code>&lt;svg&gt;</code> stage. Based on the previous step, you might think that would be as simple as executing <code>svg.append(&quot;circle&quot;)</code> for each element in the <code>nodes</code> array.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">nodes</span>.<span class="fu">forEach</span>(<span class="kw">function</span>(node) {
    <span class="ot">svg</span>.<span class="fu">append</span>(<span class="st">&quot;circle&quot;</span>);
});</code></pre></td></tr></table>
<p>That code will indeed add 25 circles to the visualization. What it won’t do, though, is create any links between the data (nodes in the array) and the document (circle elements on the page). <span class="lgcp">D3</span>.js has another way to add the circles to the page that does create that linkage. In fact, not only will <span class="smcp">D3</span>.js create the links, it will even manage them for us. This support becomes especially valuable as visualizations grow more complex.</p>
<blockquote>
<p>Note: This feature is really the <em>core</em> of <span class="smcp">D3</span>.js, and is, in fact, the source for the name “<span class="smcp">D3</span>” which is shorthand for “Data Driven Documents.”</p>
</blockquote>
<p>Here’s how we can use <span class="smcp">D3</span>.js more effectively to add the <code>&lt;circle&gt;</code> elements to the graph.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> selection = <span class="ot">svg</span>.<span class="fu">selectAll</span>(<span class="st">&quot;circle&quot;</span>)
    .<span class="fu">data</span>(nodes);
    
<span class="ot">selection</span>.<span class="fu">enter</span>().<span class="fu">append</span>(<span class="st">&quot;circle&quot;</span>);</code></pre></td></tr></table>
<p>If you haven’t seen <span class="smcp">D3</span>.js code before, that fragment surely looks very strange. What are we trying to do by selecting <code>&lt;circle&gt;</code> elements before we’ve even created any? Won’t the result just be empty? And if so, what’s the point of the <code>data()</code> function that follows? To answer those questions, we have to understand how <span class="smcp">D3</span>.js differs from traditional JavaScript libraries like jQuery. In those libraries a selection represents elements of <span class="smcp">HTML</span> markup. With jQuery, <code>$(&quot;circle&quot;)</code> is nothing more than the <code>&lt;circle&gt;</code> elements in the page. With <span class="smcp">D3</span>.js, however, selections are more than just markup elements. <span class="lgcp">D3</span>.js selections can contain both markup <em>and</em> data.</p>
<p><span class="lgcp">D3</span>.js puts markup elements and data objects together with the <code>data()</code> function. The object on which it operates (<code>svg.selectAll(&quot;circle&quot;)</code> above) supplies the elements, and its parameter (<code>nodes</code> above) provides the data. The first statement in the fragment, therefore, tells <span class="smcp">D3</span>.js that we want to match <code>&lt;circle&gt;</code> elements with nodes in our graph. We are, in effect, saying that we want one <code>&lt;circle&gt;</code> to represent each value in the <code>nodes</code> array.</p>
<p>The result is easiest to understand when there are exactly as many elements as there are data values. Figure <span class="nextfigure"/> shows four <code>&lt;circle&gt;</code> elements and four albums. <span class="lgcp">D3</span>.js dutifully combines the two sets, giving us a selection of four objects. Each object has both a <code>&lt;circle&gt;</code> and an album.</p>
<figure>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="630" height="315" xml:space="preserve">
<defs> <linearGradient id="obj_Gradient-bezier11" x1="205.91" y1="131.64" x2="183.02" y2="171.29" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="0.39" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="1" stop-color="rgb(0, 0, 0)" stop-opacity="0.5" /> </linearGradient> <linearGradient id="obj_Gradient_2-bezier12" x1="169.93" y1="157.6" x2="194.47" y2="157.6" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(123, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_3-bezier14" x1="158.49" y1="159.02" x2="181.38" y2="119.38" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(247, 21, 21)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_4-bezier16" x1="168.7" y1="138.49" x2="146.63" y2="176.71" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_5-bezier18" x1="324.91" y1="131.64" x2="302.02" y2="171.29" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="0.39" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="1" stop-color="rgb(0, 0, 0)" stop-opacity="0.5" /> </linearGradient> <linearGradient id="obj_Gradient_6-bezier19" x1="288.93" y1="157.6" x2="313.47" y2="157.6" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(123, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_7-bezier21" x1="277.49" y1="159.02" x2="300.38" y2="119.38" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(247, 21, 21)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_8-bezier23" x1="287.7" y1="138.49" x2="265.63" y2="176.71" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_9-bezier25" x1="443.91" y1="131.64" x2="421.02" y2="171.29" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="0.39" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="1" stop-color="rgb(0, 0, 0)" stop-opacity="0.5" /> </linearGradient> <linearGradient id="obj_Gradient_a-bezier26" x1="407.93" y1="157.6" x2="432.47" y2="157.6" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(123, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_b-bezier28" x1="396.49" y1="159.02" x2="419.38" y2="119.38" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(247, 21, 21)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_c-bezier30" x1="406.7" y1="138.49" x2="384.63" y2="176.71" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_d-bezier32" x1="86.91" y1="131.64" x2="64.02" y2="171.29" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="0.39" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="1" stop-color="rgb(0, 0, 0)" stop-opacity="0.5" /> </linearGradient> <linearGradient id="obj_Gradient_e-bezier33" x1="50.93" y1="157.6" x2="75.47" y2="157.6" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(123, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_f-bezier35" x1="39.49" y1="159.02" x2="62.38" y2="119.38" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(247, 21, 21)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_10-bezier37" x1="49.7" y1="138.49" x2="27.63" y2="176.71" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> </linearGradient> <filter id="shadow-outer" filterUnits="userSpaceOnUse"> <feGaussianBlur stdDeviation="2.5" /> <feOffset dx="3.1" dy="3.1" result="blur" /> <feFlood flood-color="rgb(0, 0, 0)" flood-opacity="1" /> <feComposite in2="blur" operator="in" result="colorShadow" /> <feComposite in="SourceGraphic" in2="colorShadow" operator="over" /> </filter> <filter id="shadow-outer" filterUnits="userSpaceOnUse"> <feGaussianBlur stdDeviation="2.5" /> <feOffset dx="3.1" dy="3.1" result="blur" /> <feFlood flood-color="rgb(0, 0, 0)" flood-opacity="1" /> <feComposite in2="blur" operator="in" result="colorShadow" /> <feComposite in="SourceGraphic" in2="colorShadow" operator="over" /> </filter> <filter id="shadow-outer" filterUnits="userSpaceOnUse"> <feGaussianBlur stdDeviation="2.5" /> <feOffset dx="3.1" dy="3.1" result="blur" /> <feFlood flood-color="rgb(0, 0, 0)" flood-opacity="1" /> <feComposite in2="blur" operator="in" result="colorShadow" /> <feComposite in="SourceGraphic" in2="colorShadow" operator="over" /> </filter> <filter id="shadow-outer" filterUnits="userSpaceOnUse"> <feGaussianBlur stdDeviation="2.5" /> <feOffset dx="3.1" dy="3.1" result="blur" /> <feFlood flood-color="rgb(0, 0, 0)" flood-opacity="1" /> <feComposite in2="blur" operator="in" result="colorShadow" /> <feComposite in="SourceGraphic" in2="colorShadow" operator="over" /> </filter> </defs> <path id="bezier" stroke="none" fill="rgb(123, 0, 0)" d="M 412.22,209.6 L 405.78,209.6 405.78,191.17 399,191.17 409,171.2 419,191.17 412.22,191.17 412.22,209.6 Z M 412.22,209.6" /> <path id="bezier3" stroke="none" fill="rgb(123, 0, 0)" d="M 293.22,209.6 L 286.78,209.6 286.78,191.17 280,191.17 290,171.2 300,191.17 293.22,191.17 293.22,209.6 Z M 293.22,209.6" /> <path id="bezier5" stroke="none" fill="rgb(123, 0, 0)" d="M 174.22,209.6 L 167.78,209.6 167.78,191.17 161,191.17 171,171.2 181,191.17 174.22,191.17 174.22,209.6 Z M 174.22,209.6" /> <path id="bezier7" stroke="none" fill="rgb(123, 0, 0)" d="M 55.22,209.6 L 48.78,209.6 48.78,191.17 42,191.17 52,171.2 62,191.17 55.22,191.17 55.22,209.6 Z M 55.22,209.6" /> <path id="bezier9" stroke="none" fill="rgb(202, 0, 0)" d="M 52.4,161.6 L 52.4,142.4 504.56,142.4 504.56,123.2 529,152 504.56,180.8 504.56,161.6 52.4,161.6 Z M 52.4,161.6" /> <path id="bezier11" stroke="none" fill="url(#obj_Gradient-bezier11)" d="M 169.93,151.47 L 194.47,139.2 219,151.47 194.47,163.73 169.93,151.47 Z M 169.93,151.47" /> <path id="bezier12" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_2-bezier12)" d="M 194.47,163.73 L 194.47,139.2 169.93,151.47 169.93,176 194.47,163.73 Z M 194.47,163.73" /> <path id="bezier14" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_3-bezier14)" d="M 194.47,139.2 L 169.93,126.93 145.4,139.2 169.93,151.47 194.47,139.2 Z M 194.47,139.2" /> <path id="bezier16" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_4-bezier16)" d="M 145.4,163.73 L 145.4,139.2 169.93,151.47 169.93,176 145.4,163.73 Z M 145.4,163.73" /> <path id="bezier18" stroke="none" fill="url(#obj_Gradient_5-bezier18)" d="M 288.93,151.47 L 313.47,139.2 338,151.47 313.47,163.73 288.93,151.47 Z M 288.93,151.47" /> <path id="bezier19" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_6-bezier19)" d="M 313.47,163.73 L 313.47,139.2 288.93,151.47 288.93,176 313.47,163.73 Z M 313.47,163.73" /> <path id="bezier21" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_7-bezier21)" d="M 313.47,139.2 L 288.93,126.93 264.4,139.2 288.93,151.47 313.47,139.2 Z M 313.47,139.2" /> <path id="bezier23" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_8-bezier23)" d="M 264.4,163.73 L 264.4,139.2 288.93,151.47 288.93,176 264.4,163.73 Z M 264.4,163.73" /> <path id="bezier25" stroke="none" fill="url(#obj_Gradient_9-bezier25)" d="M 407.93,151.47 L 432.47,139.2 457,151.47 432.47,163.73 407.93,151.47 Z M 407.93,151.47" /> <path id="bezier26" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_a-bezier26)" d="M 432.47,163.73 L 432.47,139.2 407.93,151.47 407.93,176 432.47,163.73 Z M 432.47,163.73" /> <path id="bezier28" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_b-bezier28)" d="M 432.47,139.2 L 407.93,126.93 383.4,139.2 407.93,151.47 432.47,139.2 Z M 432.47,139.2" /> <path id="bezier30" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_c-bezier30)" d="M 383.4,163.73 L 383.4,139.2 407.93,151.47 407.93,176 383.4,163.73 Z M 383.4,163.73" /> <path id="bezier32" stroke="none" fill="url(#obj_Gradient_d-bezier32)" d="M 50.93,151.47 L 75.47,139.2 100,151.47 75.47,163.73 50.93,151.47 Z M 50.93,151.47" /> <path id="bezier33" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_e-bezier33)" d="M 75.47,163.73 L 75.47,139.2 50.93,151.47 50.93,176 75.47,163.73 Z M 75.47,163.73" /> <path id="bezier35" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_f-bezier35)" d="M 75.47,139.2 L 50.93,126.93 26.4,139.2 50.93,151.47 75.47,139.2 Z M 75.47,139.2" /> <path id="bezier37" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_10-bezier37)" d="M 26.4,163.73 L 26.4,139.2 50.93,151.47 50.93,176 26.4,163.73 Z M 26.4,163.73" /> <path id="bezier39" stroke="rgb(68, 68, 68)" stroke-miterlimit="4" fill="rgb(255, 255, 255)" d="M 85.94,15.26 C 104.69,34 104.69,64.4 85.94,83.14 67.2,101.89 36.8,101.89 18.06,83.14 -0.69,64.4 -0.69,34 18.06,15.26 36.8,-3.49 67.2,-3.49 85.94,15.26 Z M 85.94,15.26" /> <path id="bezier41" stroke="rgb(68, 68, 68)" stroke-miterlimit="4" fill="rgb(255, 255, 255)" d="M 442.94,15.26 C 461.69,34 461.69,64.4 442.94,83.14 424.2,101.89 393.8,101.89 375.06,83.14 356.31,64.4 356.31,34 375.06,15.26 393.8,-3.49 424.2,-3.49 442.94,15.26 Z M 442.94,15.26" /> <path id="bezier43" stroke="rgb(68, 68, 68)" stroke-miterlimit="4" fill="rgb(255, 255, 255)" d="M 323.94,15.26 C 342.69,34 342.69,64.4 323.94,83.14 305.2,101.89 274.8,101.89 256.06,83.14 237.31,64.4 237.31,34 256.06,15.26 274.8,-3.49 305.2,-3.49 323.94,15.26 Z M 323.94,15.26" /> <path id="bezier45" stroke="rgb(68, 68, 68)" stroke-miterlimit="4" fill="rgb(255, 255, 255)" d="M 204.94,15.26 C 223.69,34 223.69,64.4 204.94,83.14 186.2,101.89 155.8,101.89 137.06,83.14 118.31,64.4 118.31,34 137.06,15.26 155.8,-3.49 186.2,-3.49 204.94,15.26 Z M 204.94,15.26" /> <g id="group3" filter="url(#shadow-outer)"> <rect id="rectangle6" stroke="none" fill="rgb(45, 153, 153)" x="4" y="211.6" width="96" height="96" /> </g> <g id="group4" filter="url(#shadow-outer)"> <rect id="rectangle8" stroke="none" fill="rgb(77, 115, 0)" x="123" y="211.6" width="96" height="96" /> </g> <g id="group5" filter="url(#shadow-outer)"> <path id="bezier47" stroke="none" fill="rgb(21, 121, 120)" d="M 242,210.6 L 338,210.6 338,306.6 242,306.6 242,210.6 Z M 242,210.6" /> </g> <g id="group6" filter="url(#shadow-outer)"> <rect id="rectangle11" stroke="none" fill="rgb(129, 188, 31)" x="361" y="211.6" width="96" height="96" /> </g> <path id="bezier48" stroke="none" fill="rgb(123, 0, 0)" d="M 48.78,99.87 L 55.22,99.87 55.22,117.63 62,117.63 52,137.6 42,117.63 48.78,117.63 48.78,99.87 Z M 48.78,99.87" /> <path id="bezier50" stroke="none" fill="rgb(123, 0, 0)" d="M 167.78,99.87 L 174.22,99.87 174.22,117.63 181,117.63 171,137.6 161,117.63 167.78,117.63 167.78,99.87 Z M 167.78,99.87" /> <path id="bezier52" stroke="none" fill="rgb(123, 0, 0)" d="M 286.78,99.87 L 293.22,99.87 293.22,117.63 300,117.63 290,137.6 280,117.63 286.78,117.63 286.78,99.87 Z M 286.78,99.87" /> <path id="bezier54" stroke="none" fill="rgb(123, 0, 0)" d="M 405.78,99.87 L 412.22,99.87 412.22,117.63 419,117.63 409,137.6 399,117.63 405.78,117.63 405.78,99.87 Z M 405.78,99.87" /> <g id="group2"> <path id="bezier6" stroke="none" fill="rgb(184, 234, 82)" d="M 202,228.03 C 201.98,227.93 201.92,227.84 201.83,227.79 L 200.52,227.03 C 200.95,226.5 201.35,225.98 201.72,225.52 200.82,221.82 196.66,221.35 196.66,221.35 L 195.38,223.11 194.37,222.13 C 194.3,222.05 194.2,222.02 194.09,222.03 193.99,222.03 193.89,222.08 193.83,222.17 L 193.07,223.17 C 193.01,223.25 192.98,223.36 193.01,223.46 193.02,223.54 193.07,223.62 193.14,223.67 193.15,223.68 193.16,223.69 193.18,223.7 L 194.43,224.43 193.54,225.65 192.47,224.62 C 192.4,224.55 192.3,224.51 192.2,224.52 192.09,224.53 192,224.58 191.93,224.66 L 191.17,225.66 C 191.11,225.75 191.09,225.85 191.11,225.95 191.12,226.04 191.17,226.12 191.24,226.17 191.25,226.18 191.27,226.19 191.28,226.2 L 192.59,226.96 191.66,228.23 190.56,227.15 C 190.48,227.07 190.38,227.04 190.28,227.05 190.17,227.05 190.08,227.11 190.02,227.19 L 189.25,228.19 C 189.19,228.27 189.17,228.38 189.19,228.48 189.21,228.57 189.25,228.64 189.32,228.7 189.34,228.71 189.35,228.71 189.36,228.72 L 190.81,229.57 C 190.84,229.58 190.86,229.59 190.88,229.59 L 189.94,232.35 192.86,234.57 195.52,233.03 C 195.53,233.1 195.56,233.16 195.61,233.21 L 196.82,234.39 C 196.83,234.4 196.84,234.41 196.85,234.41 196.92,234.47 197.01,234.49 197.1,234.49 197.2,234.48 197.29,234.43 197.36,234.35 L 198.12,233.34 C 198.18,233.26 198.2,233.16 198.18,233.06 198.16,232.95 198.1,232.87 198.01,232.81 L 196.56,231.97 C 196.55,231.97 196.55,231.97 196.54,231.96 196.83,231.62 197.17,231.2 197.56,230.72 L 198.74,231.86 C 198.75,231.87 198.76,231.88 198.77,231.89 198.84,231.94 198.93,231.97 199.01,231.96 199.12,231.95 199.21,231.9 199.28,231.82 L 200.04,230.82 C 200.1,230.74 200.12,230.63 200.1,230.53 200.08,230.43 200.02,230.34 199.93,230.29 L 198.56,229.49 C 198.87,229.1 199.2,228.69 199.52,228.29 L 200.63,229.36 C 200.64,229.37 200.65,229.38 200.67,229.39 200.73,229.44 200.82,229.47 200.91,229.46 201.02,229.46 201.11,229.41 201.17,229.32 L 201.93,228.32 C 201.99,228.24 202.02,228.13 202,228.03 Z M 192.75,230.06 C 192.53,230.33 192.13,230.39 191.85,230.18 191.57,229.96 191.52,229.56 191.73,229.28 191.95,229 192.34,228.95 192.63,229.16 192.91,229.37 192.96,229.77 192.75,230.06 Z M 194.67,227.53 C 194.45,227.81 194.05,227.86 193.77,227.65 193.49,227.44 193.44,227.04 193.65,226.76 193.86,226.47 194.26,226.42 194.54,226.63 194.83,226.85 194.88,227.25 194.67,227.53 Z M 195.55,224.26 C 195.76,223.98 196.16,223.93 196.44,224.14 196.72,224.35 196.78,224.75 196.56,225.03 196.35,225.31 195.95,225.37 195.67,225.15 195.39,224.94 195.33,224.54 195.55,224.26 Z M 195.46,232.12 C 195.25,232.4 194.85,232.45 194.57,232.24 194.29,232.03 194.23,231.63 194.45,231.35 194.66,231.06 195.06,231.01 195.34,231.22 195.62,231.43 195.68,231.84 195.46,232.12 Z M 197.38,229.59 C 197.17,229.87 196.77,229.93 196.49,229.71 196.21,229.5 196.15,229.1 196.37,228.82 196.58,228.54 196.98,228.48 197.26,228.7 197.54,228.91 197.6,229.31 197.38,229.59 Z M 199.28,227.1 C 199.07,227.38 198.67,227.43 198.38,227.22 198.1,227 198.05,226.6 198.26,226.32 198.47,226.04 198.88,225.99 199.16,226.2 199.44,226.41 199.49,226.82 199.28,227.1 Z M 199.28,227.1" /> <path id="bezier8" stroke="none" fill="rgb(184, 234, 82)" d="M 172.53,262.11 L 192.26,235.21 189.47,233.1 171.4,256.05 C 171.24,255.91 171.08,255.77 170.93,255.64 166.35,251.92 162.57,251.23 159.59,254.27 157.66,256.24 157.72,258.02 156.87,259.45 152.26,267.15 145.88,265.62 140.92,270.9 137.21,274.84 137.49,280.41 139.2,283.49 143.7,291.58 158.04,301.68 165.5,293.8 170.41,288.62 169.75,283.63 171.18,278.78 171.65,277.19 172.96,274.76 174.39,273.37 175.22,272.56 177.48,272.3 178.25,270.26 179.44,267.14 171.77,265.48 172.53,262.11 Z M 159.96,266.37 C 161.39,264.5 164.06,264.14 165.93,265.56 167.8,266.98 168.17,269.65 166.74,271.53 165.32,273.4 162.65,273.77 160.78,272.34 158.9,270.92 158.54,268.25 159.96,266.37 Z M 160.54,284.69 L 150.3,276.91 151.57,275.25 161.81,283.03 160.54,284.69 Z M 165.56,282.39 C 164.44,282.75 163.89,282.87 161.94,281.43 160.45,280.14 159.77,279.04 161.31,276.59 162.4,275.17 163.38,274.58 164.61,274.72 165.86,274.73 169.26,273.3 169.58,269.09 169.53,268.05 170.39,267.94 170.85,270.52 170.85,270.52 171.97,278.7 165.56,282.39 Z M 165.56,282.39" /> </g> <g id="group"> <path id="bezier2" stroke="none" fill="rgb(9, 74, 74)" d="M 44.5,225.68 C 41.85,225.64 38.96,227.26 38.03,230.21 37.99,230.34 37.31,232.34 37.27,232.49 L 31.69,232.49 C 33.93,233.97 34.67,234.36 36.91,234.36 37.28,234.36 38.79,234.35 39.16,233.24 39.27,232.91 40.04,230.7 40.19,230.4 40.85,229.07 41.87,228.09 43.13,228.09 44.68,228.09 44.75,229.56 44.63,231.06 L 40.53,280.68 C 39.97,287.48 45.38,294 53.96,294 58.84,294 61.95,292.44 63.52,287.78 65.09,283.11 62.71,274.46 68.52,272.53 L 56.19,260.3 C 51.82,264.46 52.35,273.32 53.2,278.83 53.37,279.93 53.22,283.26 51.73,283.26 50.24,283.26 49.63,280.55 49.62,279.29 L 49.48,231.06 C 49.56,227.42 47.15,225.73 44.5,225.68 Z M 46.27,252.35 C 47.19,252.35 47.96,253.09 47.96,254.01 47.96,254.93 47.19,255.68 46.27,255.68 45.34,255.68 44.6,254.93 44.6,254.01 44.6,253.09 45.34,252.35 46.27,252.35 Z M 46.02,258.82 C 46.95,258.82 47.69,259.58 47.69,260.5 47.69,261.42 46.95,262.15 46.02,262.15 45.09,262.15 44.33,261.42 44.33,260.5 44.33,259.58 45.1,258.82 46.02,258.82 Z M 45.75,265.31 C 46.68,265.31 47.42,266.05 47.42,266.97 47.42,267.89 46.68,268.64 45.75,268.64 44.83,268.64 44.06,267.89 44.06,266.97 44.06,266.05 44.83,265.31 45.75,265.31 Z M 45.75,265.31" /> <path id="bezier4" stroke="none" fill="rgb(9, 74, 74)" d="M 72.19,272.71 L 72.5,272.4 C 72.85,272.05 72.85,271.49 72.5,271.14 L 57.15,255.9 C 56.8,255.56 56.23,255.56 55.88,255.9 L 55.56,256.22 C 55.22,256.56 55.22,257.13 55.56,257.47 L 70.92,272.71 C 71.27,273.06 71.84,273.06 72.19,272.71 Z M 72.19,272.71" /> </g> <g id="group13"> <path id="bezier62" stroke="none" fill="rgb(79, 114, 15)" d="M 410.38,275.55 C 410.34,275.6 410.38,275.64 410.38,275.69 L 410.26,275.71 410.26,277.9 411.13,278.61 413.79,278.12 413.79,275.93 413.6,275.56 C 413.6,275.55 413.64,275.55 413.64,275.55 413.41,274.76 414.12,262.98 414.37,258.78 412.7,259.05 411.11,259.3 409.74,259.52 410.08,263.74 410.93,275 410.38,275.55 Z M 410.38,275.55" /> <path id="bezier63" stroke="none" fill="rgb(79, 114, 15)" d="M 391.32,254.86 C 391.53,257.41 392.31,267.38 391.86,267.83 391.82,267.87 391.7,267.9 391.71,267.94 L 391.57,267.94 391.57,269.62 392.4,270.17 394.6,269.79 394.6,268.11 394.3,267.61 C 394.23,266.23 394.66,259.55 394.87,256.2 L 391.32,254.86 Z M 391.32,254.86" /> <path id="bezier64" stroke="none" fill="rgb(79, 114, 15)" d="M 429.96,266.96 C 429.91,267.01 429.93,267.04 429.93,267.08 L 429.95,267.07 429.95,268.92 430.72,269.52 432.98,269.1 432.98,267.26 432.64,266.71 C 432.57,265.34 432.93,259.32 433.17,255.46 432.19,255.64 430.91,255.89 429.62,256.13 429.93,260.39 430.33,266.59 429.96,266.96 Z M 429.96,266.96" /> <path id="bezier65" stroke="none" fill="rgb(79, 114, 15)" d="M 431.43,242.17 C 427.61,242.91 421.91,243.69 414.94,244.43 413.72,244.56 413.41,244.9 413.38,245.06 L 413.4,245.08 413.39,245.08 C 413.39,245.58 413.38,247.09 413.15,247.93 L 413.15,247.97 C 412.36,250.47 410.73,250.75 408.25,251.14 407.97,251.19 407.66,251.25 407.34,251.3 L 407.28,251.31 C 404.82,251.48 404.4,252.58 404.4,255.78 404.4,258.01 404.77,258.83 404.99,259.11 405.16,259.14 405.34,259.16 405.53,259.16 406.6,259.16 419.73,256.96 423.92,256.25 424.72,256.12 434.74,254.22 434.74,254.22 434.74,254.22 434.91,245.05 434.96,241.36 435.13,241.31 433.16,241.84 431.43,242.17 Z M 431.43,242.17" /> <path id="bezier66" stroke="none" fill="rgb(79, 114, 15)" d="M 433.54,239.63 C 431.56,239.48 413.36,239.19 407.98,239.07 407.6,239.07 407.21,239.06 406.82,239.06 401.05,239.06 393.15,239.87 392.46,239.92 391.73,239.98 392.03,241.69 391.89,243.13 391.75,244.56 389.99,244.98 389.99,244.98 389.99,244.98 387.69,245.49 386.06,245.8 384.43,246.11 384.5,246.84 384.5,246.84 L 384.5,248.75 384.5,248.86 384.5,251.31 C 384.5,251.31 403.14,258.3 403.48,258.44 403.45,258.24 403.23,257.25 403.23,255.78 403.23,254.62 403.28,253.54 403.56,252.63 L 388.04,247.85 388.04,247.41 391.95,246.4 C 391.95,246.4 401.41,249.13 405.92,250.14 L 405.92,250.14 C 408.07,250.14 407.78,249.93 408.07,249.89 409.59,249.64 410.52,249.54 411.14,249.04 L 394.62,244.95 C 394.07,244.81 393.64,244.27 393.64,243.71 L 393.64,241.94 C 393.64,241.68 393.73,241.45 393.89,241.28 394.1,241.08 394.4,240.99 394.71,241.05 L 412.3,244.52 C 412.31,244.52 412.33,244.52 412.35,244.53 412.39,244.44 412.45,244.34 412.53,244.24 412.94,243.71 413.71,243.37 414.82,243.25 421.4,242.55 426.67,241.85 430.48,241.15 432.8,240.73 433.99,240.38 435,240.12 435,240.09 435,240.07 435,240.05 435,240.06 434.99,239.89 434.45,239.76 434.27,239.72 433.7,239.64 433.54,239.63 Z M 433.54,239.63" /> </g> <g id="g4977"> <path id="bezier10" stroke="none" fill="rgb(54, 153, 152)" d="M 252.65,248.11 L 252.71,255.03 C 254.32,255.02 255.65,253.95 256.06,252.49 L 267.5,252.42 C 266.7,253.49 266.23,254.79 266.24,256.22 266.27,259.74 269.23,262.61 272.82,262.58 L 294.94,262.42 302.32,262.36 308.79,262.3 C 312.38,262.28 315.28,259.38 315.25,255.85 315.24,254.44 314.75,253.13 313.94,252.07 L 318.47,252.03 C 322.56,253.96 324.6,262.38 324.6,262.38 324.78,263.04 325.28,263.02 325.27,262.37 L 325.17,250.7 325.09,239.67 C 325.08,239.02 324.59,239.02 324.43,239.66 324.43,239.66 322.52,247.47 318.32,249.54 L 309.83,249.59 272.05,249.79 255.74,249.87 C 255.13,248.81 253.97,248.09 252.65,248.1 L 252.65,248.11 Z M 271.58,252.54 C 271.88,252.45 272.18,252.4 272.5,252.38 L 295.95,252.2 C 295.95,252.2 299.49,252.26 301.14,252.25 303.31,252.23 305.03,253.89 305.05,256.03 305.06,257.87 303.8,259.39 302.05,259.77 L 301.99,259.79 272.78,259.98 C 270.61,260 268.91,258.33 268.89,256.2 268.88,254.46 270,253.03 271.58,252.54 Z M 306.3,252.13 L 309.13,252.12 C 311.1,252.3 312.59,253.89 312.6,255.88 312.62,258.02 310.93,259.71 308.76,259.73 L 306.48,259.74 C 307.25,258.68 307.71,257.39 307.7,256 307.69,254.54 307.16,253.2 306.3,252.13 L 306.3,252.13 Z M 306.3,252.13" /> <path id="bezier49" stroke="none" fill="rgb(54, 153, 152)" d="M 282.99,248.74 L 284.65,248.74 C 284.96,248.74 285.21,248.98 285.21,249.28 L 285.27,262.42 C 285.27,262.72 285.03,262.97 284.72,262.97 L 283.06,262.98 C 282.75,262.98 282.5,262.74 282.5,262.44 L 282.44,249.29 C 282.43,248.99 282.68,248.75 282.99,248.74 Z M 282.99,248.74" /> <path id="bezier51" stroke="none" fill="rgb(54, 153, 152)" d="M 287.86,248.72 L 289.52,248.71 C 289.83,248.71 290.07,248.95 290.08,249.26 L 290.14,262.4 C 290.14,262.7 289.89,262.95 289.59,262.95 L 287.92,262.96 C 287.62,262.96 287.37,262.71 287.37,262.41 L 287.3,249.27 C 287.3,248.97 287.55,248.72 287.86,248.72 Z M 287.86,248.72" /> <path id="bezier53" stroke="none" fill="rgb(54, 153, 152)" d="M 292.72,248.7 L 294.39,248.69 C 294.69,248.69 294.94,248.93 294.94,249.23 L 295.01,262.38 C 295.01,262.68 294.76,262.92 294.45,262.92 L 292.79,262.93 C 292.48,262.93 292.24,262.69 292.23,262.39 L 292.17,249.25 C 292.17,248.94 292.41,248.7 292.72,248.7 Z M 292.72,248.7" /> <path id="bezier55" stroke="none" fill="rgb(54, 153, 152)" d="M 283.81,247.61 C 283.98,247.61 284.12,247.75 284.12,247.91 L 284.13,249.15 C 284.13,249.32 283.99,249.45 283.82,249.45 283.65,249.46 283.52,249.32 283.52,249.16 L 283.51,247.91 C 283.51,247.75 283.65,247.61 283.81,247.61 Z M 283.81,247.61" /> <path id="bezier56" stroke="none" fill="rgb(54, 153, 152)" d="M 288.68,247.5 C 288.85,247.5 288.99,247.64 288.99,247.8 L 288.99,249.04 C 288.99,249.21 288.86,249.35 288.69,249.35 288.52,249.35 288.38,249.21 288.38,249.05 L 288.38,247.81 C 288.38,247.64 288.51,247.51 288.68,247.5 Z M 288.68,247.5" /> <path id="bezier57" stroke="none" fill="rgb(54, 153, 152)" d="M 293.55,247.48 C 293.72,247.48 293.85,247.61 293.85,247.78 L 293.86,249.02 C 293.86,249.19 293.73,249.32 293.56,249.32 293.39,249.32 293.25,249.19 293.25,249.02 L 293.24,247.78 C 293.24,247.62 293.38,247.48 293.55,247.48 Z M 293.55,247.48" /> <path id="bezier58" stroke="none" fill="rgb(54, 153, 152)" d="M 282.2,247.24 L 285.42,247.22 C 285.64,247.22 285.82,247.39 285.82,247.6 285.82,247.82 285.65,247.99 285.43,247.99 L 282.2,248.01 C 281.99,248.01 281.81,247.84 281.81,247.62 281.81,247.41 281.98,247.24 282.2,247.24 Z M 282.2,247.24" /> <path id="bezier59" stroke="none" fill="rgb(54, 153, 152)" d="M 287.07,247.21 L 290.29,247.2 C 290.51,247.2 290.68,247.37 290.69,247.58 290.69,247.79 290.51,247.97 290.29,247.97 L 287.07,247.98 C 286.85,247.98 286.68,247.81 286.68,247.6 286.68,247.39 286.85,247.21 287.07,247.21 Z M 287.07,247.21" /> <path id="bezier60" stroke="none" fill="rgb(54, 153, 152)" d="M 291.93,247.19 L 295.16,247.17 C 295.38,247.17 295.55,247.34 295.55,247.56 295.55,247.77 295.38,247.94 295.16,247.94 L 291.94,247.96 C 291.72,247.96 291.55,247.79 291.54,247.58 291.54,247.36 291.72,247.19 291.93,247.19 Z M 291.93,247.19" /> </g> <text fill="rgb(68, 68, 68)" font-size="16" x="535.82" y="134"> <tspan x="535.82" y="150">selection of </tspan> </text> <text fill="rgb(68, 68, 68)" font-size="16" x="545.17" y="154"> <tspan x="545.17" y="170">4 objects</tspan> </text> <text fill="rgb(68, 68, 68)" font-size="16" x="140.94" y="39"> <tspan x="140.94" y="55">&lt;circle&gt;</tspan> </text> <text fill="rgb(68, 68, 68)" font-size="16" x="259.44" y="39"> <tspan x="259.44" y="55">&lt;circle&gt;</tspan> </text> <text fill="rgb(68, 68, 68)" font-size="16" x="378.44" y="39"> <tspan x="378.44" y="55">&lt;circle&gt;</tspan> </text> <text fill="rgb(68, 68, 68)" font-size="16" x="21.44" y="39"> <tspan x="21.44" y="55">&lt;circle&gt;</tspan> </text>
</svg>
<figcaption>
<span class="lgcp">D3</span>.js selections can associate page content such as &lt;circle&gt; elements with data items such as albums.
</figcaption>
</figure>
<p>In general, though, we can’t guarantee that there will be exactly as many elements as data values. Suppose, for example, only two <code>&lt;circle&gt;</code> elements existed for our four albums. As figure <span class="nextfigure"/> shows, <span class="smcp">D3</span>.js still creates a selection of four objects, even though there aren’t enough circles for all of them. Two of the objects will have a data value but no element.</p>
<figure>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="630" height="315" xml:space="preserve">
<defs> <linearGradient id="obj_Gradient-bezier11" x1="205.91" y1="131.64" x2="183.02" y2="171.29" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="0.39" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="1" stop-color="rgb(0, 0, 0)" stop-opacity="0.5" /> </linearGradient> <linearGradient id="obj_Gradient_2-bezier12" x1="169.93" y1="157.6" x2="194.47" y2="157.6" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(123, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_3-bezier14" x1="158.49" y1="159.02" x2="181.38" y2="119.38" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(247, 21, 21)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_4-bezier16" x1="168.7" y1="138.49" x2="146.63" y2="176.71" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_5-bezier18" x1="324.91" y1="131.64" x2="302.02" y2="171.29" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="0.39" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="1" stop-color="rgb(0, 0, 0)" stop-opacity="0.5" /> </linearGradient> <linearGradient id="obj_Gradient_6-bezier19" x1="288.93" y1="157.6" x2="313.47" y2="157.6" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(123, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_7-bezier21" x1="277.49" y1="159.02" x2="300.38" y2="119.38" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(247, 21, 21)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_8-bezier23" x1="287.7" y1="138.49" x2="265.63" y2="176.71" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_9-bezier25" x1="443.91" y1="131.64" x2="421.02" y2="171.29" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="0.39" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="1" stop-color="rgb(0, 0, 0)" stop-opacity="0.5" /> </linearGradient> <linearGradient id="obj_Gradient_a-bezier26" x1="407.93" y1="157.6" x2="432.47" y2="157.6" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(123, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_b-bezier28" x1="396.49" y1="159.02" x2="419.38" y2="119.38" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(247, 21, 21)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_c-bezier30" x1="406.7" y1="138.49" x2="384.63" y2="176.71" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_d-bezier32" x1="86.91" y1="131.64" x2="64.02" y2="171.29" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="0.39" stop-color="rgb(0, 0, 0)" stop-opacity="0" /> <stop offset="1" stop-color="rgb(0, 0, 0)" stop-opacity="0.5" /> </linearGradient> <linearGradient id="obj_Gradient_e-bezier33" x1="50.93" y1="157.6" x2="75.47" y2="157.6" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(123, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_f-bezier35" x1="39.49" y1="159.02" x2="62.38" y2="119.38" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(165, 0, 0)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(247, 21, 21)" stop-opacity="1" /> </linearGradient> <linearGradient id="obj_Gradient_10-bezier37" x1="49.7" y1="138.49" x2="27.63" y2="176.71" gradientUnits="userSpaceOnUse" > <stop offset="0" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> <stop offset="1" stop-color="rgb(254, 76, 76)" stop-opacity="1" /> </linearGradient> <filter id="shadow-outer" filterUnits="userSpaceOnUse"> <feGaussianBlur stdDeviation="2.5" /> <feOffset dx="3.1" dy="3.1" result="blur" /> <feFlood flood-color="rgb(0, 0, 0)" flood-opacity="1" /> <feComposite in2="blur" operator="in" result="colorShadow" /> <feComposite in="SourceGraphic" in2="colorShadow" operator="over" /> </filter> <filter id="shadow-outer" filterUnits="userSpaceOnUse"> <feGaussianBlur stdDeviation="2.5" /> <feOffset dx="3.1" dy="3.1" result="blur" /> <feFlood flood-color="rgb(0, 0, 0)" flood-opacity="1" /> <feComposite in2="blur" operator="in" result="colorShadow" /> <feComposite in="SourceGraphic" in2="colorShadow" operator="over" /> </filter> <filter id="shadow-outer" filterUnits="userSpaceOnUse"> <feGaussianBlur stdDeviation="2.5" /> <feOffset dx="3.1" dy="3.1" result="blur" /> <feFlood flood-color="rgb(0, 0, 0)" flood-opacity="1" /> <feComposite in2="blur" operator="in" result="colorShadow" /> <feComposite in="SourceGraphic" in2="colorShadow" operator="over" /> </filter> <filter id="shadow-outer" filterUnits="userSpaceOnUse"> <feGaussianBlur stdDeviation="2.5" /> <feOffset dx="3.1" dy="3.1" result="blur" /> <feFlood flood-color="rgb(0, 0, 0)" flood-opacity="1" /> <feComposite in2="blur" operator="in" result="colorShadow" /> <feComposite in="SourceGraphic" in2="colorShadow" operator="over" /> </filter> </defs> <path id="bezier" stroke="none" fill="rgb(123, 0, 0)" d="M 412.22,209.6 L 405.78,209.6 405.78,191.17 399,191.17 409,171.2 419,191.17 412.22,191.17 412.22,209.6 Z M 412.22,209.6" /> <path id="bezier3" stroke="none" fill="rgb(123, 0, 0)" d="M 293.22,209.6 L 286.78,209.6 286.78,191.17 280,191.17 290,171.2 300,191.17 293.22,191.17 293.22,209.6 Z M 293.22,209.6" /> <path id="bezier5" stroke="none" fill="rgb(123, 0, 0)" d="M 174.22,209.6 L 167.78,209.6 167.78,191.17 161,191.17 171,171.2 181,191.17 174.22,191.17 174.22,209.6 Z M 174.22,209.6" /> <path id="bezier7" stroke="none" fill="rgb(123, 0, 0)" d="M 55.22,209.6 L 48.78,209.6 48.78,191.17 42,191.17 52,171.2 62,191.17 55.22,191.17 55.22,209.6 Z M 55.22,209.6" /> <path id="bezier9" stroke="none" fill="rgb(202, 0, 0)" d="M 51.4,161.6 L 51.4,142.4 504.51,142.4 504.51,123.2 529,152 504.51,180.8 504.51,161.6 51.4,161.6 Z M 51.4,161.6" /> <path id="bezier11" stroke="none" fill="url(#obj_Gradient-bezier11)" d="M 169.93,151.47 L 194.47,139.2 219,151.47 194.47,163.73 169.93,151.47 Z M 169.93,151.47" /> <path id="bezier12" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_2-bezier12)" d="M 194.47,163.73 L 194.47,139.2 169.93,151.47 169.93,176 194.47,163.73 Z M 194.47,163.73" /> <path id="bezier14" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_3-bezier14)" d="M 194.47,139.2 L 169.93,126.93 145.4,139.2 169.93,151.47 194.47,139.2 Z M 194.47,139.2" /> <path id="bezier16" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_4-bezier16)" d="M 145.4,163.73 L 145.4,139.2 169.93,151.47 169.93,176 145.4,163.73 Z M 145.4,163.73" /> <path id="bezier18" stroke="none" fill="url(#obj_Gradient_5-bezier18)" d="M 288.93,151.47 L 313.47,139.2 338,151.47 313.47,163.73 288.93,151.47 Z M 288.93,151.47" /> <path id="bezier19" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_6-bezier19)" d="M 313.47,163.73 L 313.47,139.2 288.93,151.47 288.93,176 313.47,163.73 Z M 313.47,163.73" /> <path id="bezier21" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_7-bezier21)" d="M 313.47,139.2 L 288.93,126.93 264.4,139.2 288.93,151.47 313.47,139.2 Z M 313.47,139.2" /> <path id="bezier23" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_8-bezier23)" d="M 264.4,163.73 L 264.4,139.2 288.93,151.47 288.93,176 264.4,163.73 Z M 264.4,163.73" /> <path id="bezier25" stroke="none" fill="url(#obj_Gradient_9-bezier25)" d="M 407.93,151.47 L 432.47,139.2 457,151.47 432.47,163.73 407.93,151.47 Z M 407.93,151.47" /> <path id="bezier26" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_a-bezier26)" d="M 432.47,163.73 L 432.47,139.2 407.93,151.47 407.93,176 432.47,163.73 Z M 432.47,163.73" /> <path id="bezier28" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_b-bezier28)" d="M 432.47,139.2 L 407.93,126.93 383.4,139.2 407.93,151.47 432.47,139.2 Z M 432.47,139.2" /> <path id="bezier30" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_c-bezier30)" d="M 383.4,163.73 L 383.4,139.2 407.93,151.47 407.93,176 383.4,163.73 Z M 383.4,163.73" /> <path id="bezier32" stroke="none" fill="url(#obj_Gradient_d-bezier32)" d="M 50.93,151.47 L 75.47,139.2 100,151.47 75.47,163.73 50.93,151.47 Z M 50.93,151.47" /> <path id="bezier33" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_e-bezier33)" d="M 75.47,163.73 L 75.47,139.2 50.93,151.47 50.93,176 75.47,163.73 Z M 75.47,163.73" /> <path id="bezier35" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_f-bezier35)" d="M 75.47,139.2 L 50.93,126.93 26.4,139.2 50.93,151.47 75.47,139.2 Z M 75.47,139.2" /> <path id="bezier37" stroke="rgb(46, 46, 46)" stroke-miterlimit="4" fill="url(#obj_Gradient_10-bezier37)" d="M 26.4,163.73 L 26.4,139.2 50.93,151.47 50.93,176 26.4,163.73 Z M 26.4,163.73" /> <path id="bezier39" stroke="rgb(68, 68, 68)" stroke-miterlimit="4" fill="rgb(255, 255, 255)" d="M 85.94,15.26 C 104.69,34 104.69,64.4 85.94,83.14 67.2,101.89 36.8,101.89 18.06,83.14 -0.69,64.4 -0.69,34 18.06,15.26 36.8,-3.49 67.2,-3.49 85.94,15.26 Z M 85.94,15.26" /> <path id="bezier45" stroke="rgb(68, 68, 68)" stroke-miterlimit="4" fill="rgb(255, 255, 255)" d="M 204.94,15.26 C 223.69,34 223.69,64.4 204.94,83.14 186.2,101.89 155.8,101.89 137.06,83.14 118.31,64.4 118.31,34 137.06,15.26 155.8,-3.49 186.2,-3.49 204.94,15.26 Z M 204.94,15.26" /> <g id="group3" filter="url(#shadow-outer)"> <rect id="rectangle6" stroke="none" fill="rgb(45, 153, 153)" x="4" y="211.6" width="96" height="96" /> </g> <g id="group4" filter="url(#shadow-outer)"> <rect id="rectangle8" stroke="none" fill="rgb(77, 115, 0)" x="123" y="211.6" width="96" height="96" /> </g> <g id="group5" filter="url(#shadow-outer)"> <path id="bezier47" stroke="none" fill="rgb(21, 121, 120)" d="M 242,210.6 L 338,210.6 338,306.6 242,306.6 242,210.6 Z M 242,210.6" /> </g> <g id="group6" filter="url(#shadow-outer)"> <rect id="rectangle11" stroke="none" fill="rgb(129, 188, 31)" x="361" y="211.6" width="96" height="96" /> </g> <path id="bezier48" stroke="none" fill="rgb(123, 0, 0)" d="M 48.78,99.87 L 55.22,99.87 55.22,117.63 62,117.63 52,137.6 42,117.63 48.78,117.63 48.78,99.87 Z M 48.78,99.87" /> <path id="bezier50" stroke="none" fill="rgb(123, 0, 0)" d="M 167.78,99.87 L 174.22,99.87 174.22,117.63 181,117.63 171,137.6 161,117.63 167.78,117.63 167.78,99.87 Z M 167.78,99.87" /> <g id="group2"> <path id="bezier6" stroke="none" fill="rgb(184, 234, 82)" d="M 202,228.03 C 201.98,227.93 201.92,227.84 201.83,227.79 L 200.52,227.03 C 200.95,226.5 201.35,225.98 201.72,225.52 200.82,221.82 196.66,221.35 196.66,221.35 L 195.38,223.11 194.37,222.13 C 194.3,222.05 194.2,222.02 194.09,222.03 193.99,222.03 193.89,222.08 193.83,222.17 L 193.07,223.17 C 193.01,223.25 192.98,223.36 193.01,223.46 193.02,223.54 193.07,223.62 193.14,223.67 193.15,223.68 193.16,223.69 193.18,223.7 L 194.43,224.43 193.54,225.65 192.47,224.62 C 192.4,224.55 192.3,224.51 192.2,224.52 192.09,224.53 192,224.58 191.93,224.66 L 191.17,225.66 C 191.11,225.75 191.09,225.85 191.11,225.95 191.12,226.04 191.17,226.12 191.24,226.17 191.25,226.18 191.27,226.19 191.28,226.2 L 192.59,226.96 191.66,228.23 190.56,227.15 C 190.48,227.07 190.38,227.04 190.28,227.05 190.17,227.05 190.08,227.11 190.02,227.19 L 189.25,228.19 C 189.19,228.27 189.17,228.38 189.19,228.48 189.21,228.57 189.25,228.64 189.32,228.7 189.34,228.71 189.35,228.71 189.36,228.72 L 190.81,229.57 C 190.84,229.58 190.86,229.59 190.88,229.59 L 189.94,232.35 192.86,234.57 195.52,233.03 C 195.53,233.1 195.56,233.16 195.61,233.21 L 196.82,234.39 C 196.83,234.4 196.84,234.41 196.85,234.41 196.92,234.47 197.01,234.49 197.1,234.49 197.2,234.48 197.29,234.43 197.36,234.35 L 198.12,233.34 C 198.18,233.26 198.2,233.16 198.18,233.06 198.16,232.95 198.1,232.87 198.01,232.81 L 196.56,231.97 C 196.55,231.97 196.55,231.97 196.54,231.96 196.83,231.62 197.17,231.2 197.56,230.72 L 198.74,231.86 C 198.75,231.87 198.76,231.88 198.77,231.89 198.84,231.94 198.93,231.97 199.01,231.96 199.12,231.95 199.21,231.9 199.28,231.82 L 200.04,230.82 C 200.1,230.74 200.12,230.63 200.1,230.53 200.08,230.43 200.02,230.34 199.93,230.29 L 198.56,229.49 C 198.87,229.1 199.2,228.69 199.52,228.29 L 200.63,229.36 C 200.64,229.37 200.65,229.38 200.67,229.39 200.73,229.44 200.82,229.47 200.91,229.46 201.02,229.46 201.11,229.41 201.17,229.32 L 201.93,228.32 C 201.99,228.24 202.02,228.13 202,228.03 Z M 192.75,230.06 C 192.53,230.33 192.13,230.39 191.85,230.18 191.57,229.96 191.52,229.56 191.73,229.28 191.95,229 192.34,228.95 192.63,229.16 192.91,229.37 192.96,229.77 192.75,230.06 Z M 194.67,227.53 C 194.45,227.81 194.05,227.86 193.77,227.65 193.49,227.44 193.44,227.04 193.65,226.76 193.86,226.47 194.26,226.42 194.54,226.63 194.83,226.85 194.88,227.25 194.67,227.53 Z M 195.55,224.26 C 195.76,223.98 196.16,223.93 196.44,224.14 196.72,224.35 196.78,224.75 196.56,225.03 196.35,225.31 195.95,225.37 195.67,225.15 195.39,224.94 195.33,224.54 195.55,224.26 Z M 195.46,232.12 C 195.25,232.4 194.85,232.45 194.57,232.24 194.29,232.03 194.23,231.63 194.45,231.35 194.66,231.06 195.06,231.01 195.34,231.22 195.62,231.43 195.68,231.84 195.46,232.12 Z M 197.38,229.59 C 197.17,229.87 196.77,229.93 196.49,229.71 196.21,229.5 196.15,229.1 196.37,228.82 196.58,228.54 196.98,228.48 197.26,228.7 197.54,228.91 197.6,229.31 197.38,229.59 Z M 199.28,227.1 C 199.07,227.38 198.67,227.43 198.38,227.22 198.1,227 198.05,226.6 198.26,226.32 198.47,226.04 198.88,225.99 199.16,226.2 199.44,226.41 199.49,226.82 199.28,227.1 Z M 199.28,227.1" /> <path id="bezier8" stroke="none" fill="rgb(184, 234, 82)" d="M 172.53,262.11 L 192.26,235.21 189.47,233.1 171.4,256.05 C 171.24,255.91 171.08,255.77 170.93,255.64 166.35,251.92 162.57,251.23 159.59,254.27 157.66,256.24 157.72,258.02 156.87,259.45 152.26,267.15 145.88,265.62 140.92,270.9 137.21,274.84 137.49,280.41 139.2,283.49 143.7,291.58 158.04,301.68 165.5,293.8 170.41,288.62 169.75,283.63 171.18,278.78 171.65,277.19 172.96,274.76 174.39,273.37 175.22,272.56 177.48,272.3 178.25,270.26 179.44,267.14 171.77,265.48 172.53,262.11 Z M 159.96,266.37 C 161.39,264.5 164.06,264.14 165.93,265.56 167.8,266.98 168.17,269.65 166.74,271.53 165.32,273.4 162.65,273.77 160.78,272.34 158.9,270.92 158.54,268.25 159.96,266.37 Z M 160.54,284.69 L 150.3,276.91 151.57,275.25 161.81,283.03 160.54,284.69 Z M 165.56,282.39 C 164.44,282.75 163.89,282.87 161.94,281.43 160.45,280.14 159.77,279.04 161.31,276.59 162.4,275.17 163.38,274.58 164.61,274.72 165.86,274.73 169.26,273.3 169.58,269.09 169.53,268.05 170.39,267.94 170.85,270.52 170.85,270.52 171.97,278.7 165.56,282.39 Z M 165.56,282.39" /> </g> <g id="group"> <path id="bezier2" stroke="none" fill="rgb(9, 74, 74)" d="M 44.5,225.68 C 41.85,225.64 38.96,227.26 38.03,230.21 37.99,230.34 37.31,232.34 37.27,232.49 L 31.69,232.49 C 33.93,233.97 34.67,234.36 36.91,234.36 37.28,234.36 38.79,234.35 39.16,233.24 39.27,232.91 40.04,230.7 40.19,230.4 40.85,229.07 41.87,228.09 43.13,228.09 44.68,228.09 44.75,229.56 44.63,231.06 L 40.53,280.68 C 39.97,287.48 45.38,294 53.96,294 58.84,294 61.95,292.44 63.52,287.78 65.09,283.11 62.71,274.46 68.52,272.53 L 56.19,260.3 C 51.82,264.46 52.35,273.32 53.2,278.83 53.37,279.93 53.22,283.26 51.73,283.26 50.24,283.26 49.63,280.55 49.62,279.29 L 49.48,231.06 C 49.56,227.42 47.15,225.73 44.5,225.68 Z M 46.27,252.35 C 47.19,252.35 47.96,253.09 47.96,254.01 47.96,254.93 47.19,255.68 46.27,255.68 45.34,255.68 44.6,254.93 44.6,254.01 44.6,253.09 45.34,252.35 46.27,252.35 Z M 46.02,258.82 C 46.95,258.82 47.69,259.58 47.69,260.5 47.69,261.42 46.95,262.15 46.02,262.15 45.09,262.15 44.33,261.42 44.33,260.5 44.33,259.58 45.1,258.82 46.02,258.82 Z M 45.75,265.31 C 46.68,265.31 47.42,266.05 47.42,266.97 47.42,267.89 46.68,268.64 45.75,268.64 44.83,268.64 44.06,267.89 44.06,266.97 44.06,266.05 44.83,265.31 45.75,265.31 Z M 45.75,265.31" /> <path id="bezier4" stroke="none" fill="rgb(9, 74, 74)" d="M 72.19,272.71 L 72.5,272.4 C 72.85,272.05 72.85,271.49 72.5,271.14 L 57.15,255.9 C 56.8,255.56 56.23,255.56 55.88,255.9 L 55.56,256.22 C 55.22,256.56 55.22,257.13 55.56,257.47 L 70.92,272.71 C 71.27,273.06 71.84,273.06 72.19,272.71 Z M 72.19,272.71" /> </g> <g id="group13"> <path id="bezier62" stroke="none" fill="rgb(79, 114, 15)" d="M 410.38,275.55 C 410.34,275.6 410.38,275.64 410.38,275.69 L 410.26,275.71 410.26,277.9 411.13,278.61 413.79,278.12 413.79,275.93 413.6,275.56 C 413.6,275.55 413.64,275.55 413.64,275.55 413.41,274.76 414.12,262.98 414.37,258.78 412.7,259.05 411.11,259.3 409.74,259.52 410.08,263.74 410.93,275 410.38,275.55 Z M 410.38,275.55" /> <path id="bezier63" stroke="none" fill="rgb(79, 114, 15)" d="M 391.32,254.86 C 391.53,257.41 392.31,267.38 391.86,267.83 391.82,267.87 391.7,267.9 391.71,267.94 L 391.57,267.94 391.57,269.62 392.4,270.17 394.6,269.79 394.6,268.11 394.3,267.61 C 394.23,266.23 394.66,259.55 394.87,256.2 L 391.32,254.86 Z M 391.32,254.86" /> <path id="bezier64" stroke="none" fill="rgb(79, 114, 15)" d="M 429.96,266.96 C 429.91,267.01 429.93,267.04 429.93,267.08 L 429.95,267.07 429.95,268.92 430.72,269.52 432.98,269.1 432.98,267.26 432.64,266.71 C 432.57,265.34 432.93,259.32 433.17,255.46 432.19,255.64 430.91,255.89 429.62,256.13 429.93,260.39 430.33,266.59 429.96,266.96 Z M 429.96,266.96" /> <path id="bezier65" stroke="none" fill="rgb(79, 114, 15)" d="M 431.43,242.17 C 427.61,242.91 421.91,243.69 414.94,244.43 413.72,244.56 413.41,244.9 413.38,245.06 L 413.4,245.08 413.39,245.08 C 413.39,245.58 413.38,247.09 413.15,247.93 L 413.15,247.97 C 412.36,250.47 410.73,250.75 408.25,251.14 407.97,251.19 407.66,251.25 407.34,251.3 L 407.28,251.31 C 404.82,251.48 404.4,252.58 404.4,255.78 404.4,258.01 404.77,258.83 404.99,259.11 405.16,259.14 405.34,259.16 405.53,259.16 406.6,259.16 419.73,256.96 423.92,256.25 424.72,256.12 434.74,254.22 434.74,254.22 434.74,254.22 434.91,245.05 434.96,241.36 435.13,241.31 433.16,241.84 431.43,242.17 Z M 431.43,242.17" /> <path id="bezier66" stroke="none" fill="rgb(79, 114, 15)" d="M 433.54,239.63 C 431.56,239.48 413.36,239.19 407.98,239.07 407.6,239.07 407.21,239.06 406.82,239.06 401.05,239.06 393.15,239.87 392.46,239.92 391.73,239.98 392.03,241.69 391.89,243.13 391.75,244.56 389.99,244.98 389.99,244.98 389.99,244.98 387.69,245.49 386.06,245.8 384.43,246.11 384.5,246.84 384.5,246.84 L 384.5,248.75 384.5,248.86 384.5,251.31 C 384.5,251.31 403.14,258.3 403.48,258.44 403.45,258.24 403.23,257.25 403.23,255.78 403.23,254.62 403.28,253.54 403.56,252.63 L 388.04,247.85 388.04,247.41 391.95,246.4 C 391.95,246.4 401.41,249.13 405.92,250.14 L 405.92,250.14 C 408.07,250.14 407.78,249.93 408.07,249.89 409.59,249.64 410.52,249.54 411.14,249.04 L 394.62,244.95 C 394.07,244.81 393.64,244.27 393.64,243.71 L 393.64,241.94 C 393.64,241.68 393.73,241.45 393.89,241.28 394.1,241.08 394.4,240.99 394.71,241.05 L 412.3,244.52 C 412.31,244.52 412.33,244.52 412.35,244.53 412.39,244.44 412.45,244.34 412.53,244.24 412.94,243.71 413.71,243.37 414.82,243.25 421.4,242.55 426.67,241.85 430.48,241.15 432.8,240.73 433.99,240.38 435,240.12 435,240.09 435,240.07 435,240.05 435,240.06 434.99,239.89 434.45,239.76 434.27,239.72 433.7,239.64 433.54,239.63 Z M 433.54,239.63" /> </g> <g id="g4977"> <path id="bezier10" stroke="none" fill="rgb(54, 153, 152)" d="M 252.65,248.11 L 252.71,255.03 C 254.32,255.02 255.65,253.95 256.06,252.49 L 267.5,252.42 C 266.7,253.49 266.23,254.79 266.24,256.22 266.27,259.74 269.23,262.61 272.82,262.58 L 294.94,262.42 302.32,262.36 308.79,262.3 C 312.38,262.28 315.28,259.38 315.25,255.85 315.24,254.44 314.75,253.13 313.94,252.07 L 318.47,252.03 C 322.56,253.96 324.6,262.38 324.6,262.38 324.78,263.04 325.28,263.02 325.27,262.37 L 325.17,250.7 325.09,239.67 C 325.08,239.02 324.59,239.02 324.43,239.66 324.43,239.66 322.52,247.47 318.32,249.54 L 309.83,249.59 272.05,249.79 255.74,249.87 C 255.13,248.81 253.97,248.09 252.65,248.1 L 252.65,248.11 Z M 271.58,252.54 C 271.88,252.45 272.18,252.4 272.5,252.38 L 295.95,252.2 C 295.95,252.2 299.49,252.26 301.14,252.25 303.31,252.23 305.03,253.89 305.05,256.03 305.06,257.87 303.8,259.39 302.05,259.77 L 301.99,259.79 272.78,259.98 C 270.61,260 268.91,258.33 268.89,256.2 268.88,254.46 270,253.03 271.58,252.54 Z M 306.3,252.13 L 309.13,252.12 C 311.1,252.3 312.59,253.89 312.6,255.88 312.62,258.02 310.93,259.71 308.76,259.73 L 306.48,259.74 C 307.25,258.68 307.71,257.39 307.7,256 307.69,254.54 307.16,253.2 306.3,252.13 L 306.3,252.13 Z M 306.3,252.13" /> <path id="bezier49" stroke="none" fill="rgb(54, 153, 152)" d="M 282.99,248.74 L 284.65,248.74 C 284.96,248.74 285.21,248.98 285.21,249.28 L 285.27,262.42 C 285.27,262.72 285.03,262.97 284.72,262.97 L 283.06,262.98 C 282.75,262.98 282.5,262.74 282.5,262.44 L 282.44,249.29 C 282.43,248.99 282.68,248.75 282.99,248.74 Z M 282.99,248.74" /> <path id="bezier51" stroke="none" fill="rgb(54, 153, 152)" d="M 287.86,248.72 L 289.52,248.71 C 289.83,248.71 290.07,248.95 290.08,249.26 L 290.14,262.4 C 290.14,262.7 289.89,262.95 289.59,262.95 L 287.92,262.96 C 287.62,262.96 287.37,262.71 287.37,262.41 L 287.3,249.27 C 287.3,248.97 287.55,248.72 287.86,248.72 Z M 287.86,248.72" /> <path id="bezier53" stroke="none" fill="rgb(54, 153, 152)" d="M 292.72,248.7 L 294.39,248.69 C 294.69,248.69 294.94,248.93 294.94,249.23 L 295.01,262.38 C 295.01,262.68 294.76,262.92 294.45,262.92 L 292.79,262.93 C 292.48,262.93 292.24,262.69 292.23,262.39 L 292.17,249.25 C 292.17,248.94 292.41,248.7 292.72,248.7 Z M 292.72,248.7" /> <path id="bezier55" stroke="none" fill="rgb(54, 153, 152)" d="M 283.81,247.61 C 283.98,247.61 284.12,247.75 284.12,247.91 L 284.13,249.15 C 284.13,249.32 283.99,249.45 283.82,249.45 283.65,249.46 283.52,249.32 283.52,249.16 L 283.51,247.91 C 283.51,247.75 283.65,247.61 283.81,247.61 Z M 283.81,247.61" /> <path id="bezier56" stroke="none" fill="rgb(54, 153, 152)" d="M 288.68,247.5 C 288.85,247.5 288.99,247.64 288.99,247.8 L 288.99,249.04 C 288.99,249.21 288.86,249.35 288.69,249.35 288.52,249.35 288.38,249.21 288.38,249.05 L 288.38,247.81 C 288.38,247.64 288.51,247.51 288.68,247.5 Z M 288.68,247.5" /> <path id="bezier57" stroke="none" fill="rgb(54, 153, 152)" d="M 293.55,247.48 C 293.72,247.48 293.85,247.61 293.85,247.78 L 293.86,249.02 C 293.86,249.19 293.73,249.32 293.56,249.32 293.39,249.32 293.25,249.19 293.25,249.02 L 293.24,247.78 C 293.24,247.62 293.38,247.48 293.55,247.48 Z M 293.55,247.48" /> <path id="bezier58" stroke="none" fill="rgb(54, 153, 152)" d="M 282.2,247.24 L 285.42,247.22 C 285.64,247.22 285.82,247.39 285.82,247.6 285.82,247.82 285.65,247.99 285.43,247.99 L 282.2,248.01 C 281.99,248.01 281.81,247.84 281.81,247.62 281.81,247.41 281.98,247.24 282.2,247.24 Z M 282.2,247.24" /> <path id="bezier59" stroke="none" fill="rgb(54, 153, 152)" d="M 287.07,247.21 L 290.29,247.2 C 290.51,247.2 290.68,247.37 290.69,247.58 290.69,247.79 290.51,247.97 290.29,247.97 L 287.07,247.98 C 286.85,247.98 286.68,247.81 286.68,247.6 286.68,247.39 286.85,247.21 287.07,247.21 Z M 287.07,247.21" /> <path id="bezier60" stroke="none" fill="rgb(54, 153, 152)" d="M 291.93,247.19 L 295.16,247.17 C 295.38,247.17 295.55,247.34 295.55,247.56 295.55,247.77 295.38,247.94 295.16,247.94 L 291.94,247.96 C 291.72,247.96 291.55,247.79 291.54,247.58 291.54,247.36 291.72,247.19 291.93,247.19 Z M 291.93,247.19" /> </g> <text fill="rgb(68, 68, 68)" font-size="16" x="535.82" y="134"> <tspan x="535.82" y="150">selection of </tspan> </text> <text fill="rgb(68, 68, 68)" font-size="16" x="545.17" y="154"> <tspan x="545.17" y="170">4 objects</tspan> </text> <text fill="rgb(68, 68, 68)" font-size="16" x="140.94" y="39"> <tspan x="140.94" y="55">&lt;circle&gt;</tspan> </text> <text fill="rgb(68, 68, 68)" font-size="16" x="21.44" y="39"> <tspan x="21.44" y="55">&lt;circle&gt;</tspan> </text>
</svg>
<figcaption>
<span class="lgcp">D3</span>.js selections keep track of page content that doesn’t exist (yet).
</figcaption>
</figure>
<p>Our code fragment is an even more extreme example. When it executes, there are absolutely no circles on the page. There are, however, values in the <code>nodes</code> array that we’re telling <span class="smcp">D3</span>.js to use as data. <span class="lgcp">D3</span>.js, therefore, creates an object for each of those data values. It just won’t have a <code>&lt;circle&gt;</code> element to go with them.</p>
<p>(Take a breath because magic is about to happen.)</p>
<p>Now we can look at the second statement in our code fragment. It starts with <code>selection.enter()</code>. The <code>enter()</code> function is a special <span class="smcp">D3</span>.js function. It tells <span class="smcp">D3</span>.js to search through the selection and find all of the objects that have a data value <em>but no markup element.</em> We then complete the statement by taking that subset of the selection and calling <code>append(&quot;circle&quot;)</code>. And with that function call, <span class="smcp">D3</span>.js will take any object in the selection without a markup element and create a circle for it. That’s how we add <code>&lt;circle&gt;</code> elements to the graph.</p>
<p>To be a little more concise, we can combine our two statements into a single one. The effect, for our visualization is to create a <code>&lt;circle&gt;</code> within the <code>&lt;svg&gt;</code> container for every node in the graph.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> nodeSelection = <span class="ot">svg</span>.<span class="fu">selectAll</span>(<span class="st">&quot;circle&quot;</span>)
    .<span class="fu">data</span>(nodes)
    .<span class="fu">enter</span>().<span class="fu">append</span>(<span class="st">&quot;circle&quot;</span>);</code></pre></td></tr></table>
<h3 id="step-5-draw-the-graphs-edges">Step 5: Draw the Graph’s Edges</h3>
<p>You won’t be surprised to find that adding the edges to the graph works just like adding nodes. We simply append <code>&lt;line&gt;</code> elements instead of circles.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> edgeSelection = <span class="ot">svg</span>.<span class="fu">selectAll</span>(<span class="st">&quot;line&quot;</span>)
    .<span class="fu">data</span>(edges)
    .<span class="fu">enter</span>().<span class="fu">append</span>(<span class="st">&quot;line&quot;</span>);</code></pre></td></tr></table>
<blockquote>
<p>Note: Even though we won’t need to use them for this example, <span class="smcp">D3</span>.js has other functions that complement the <code>enter()</code> function. To find objects that have a markup element but no data value, you can use the function <code>exit()</code>. And to find objects that have a markup element with a data value that has changed, you can use the function <code>update()</code>. The names <em>enter</em> and <em>exit</em> derive from a theater metaphor that <span class="smcp">D3</span>.js associates with a visualization. The <code>enter()</code> subset represents those elements that are <em>entering</em> the stage, while the <code>exit()</code> subset represents elements leaving, or <em>exiting,</em> the stage.</p>
</blockquote>
<p>Because we’re using <span class="smcp">SVG</span> elements for both the nodes and the edges, we can use <span class="smcp">CSS</span> rules to style them. That’s especially important for the edges because, by default, <span class="smcp">SVG</span> lines have a stroke width of 0.</p>
<table class="sourceCode css numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="sourceCode"><pre><code class="sourceCode css">circle <span class="kw">{</span>
    <span class="kw">fill:</span> <span class="dt">#ccc</span><span class="kw">;</span>
    <span class="kw">stroke:</span> <span class="dt">#fff</span><span class="kw">;</span>
    <span class="kw">stroke-width:</span> <span class="dt">1px</span><span class="kw">;</span>
<span class="kw">}</span>

line <span class="kw">{</span>
    <span class="kw">stroke:</span> <span class="dt">#777</span><span class="kw">;</span>
    <span class="kw">stroke-width:</span> <span class="dt">1px</span><span class="kw">;</span>
<span class="kw">}</span></code></pre></td></tr></table>
<h3 id="step-6-position-the-elements">Step 6: Position the Elements</h3>
<p>At this point we’ve added the necessary markup elements to our visualization, but we haven’t given them any dimensions or positions. As noted before, <span class="smcp">D3</span>.js doesn’t do any drawing, so we’ll have to write the code to do it. And as noted in step 2, we did assign somewhat arbitrary positions to the nodes by arranging them in a circle. For now, we can use that to position them.</p>
<p>To position an <span class="smcp">SVG</span> circle we set its <code>cx</code> and <code>cy</code> attributes to correspond to the circle’s center. We also specify the circle’s radius with the <code>r</code> attribute. Let’s start with the radius; we’ll set it to a fixed value for all nodes. We’ve already created a <span class="smcp">D3</span>.js selection for all of those nodes. Setting their <code>r</code> attributes is a simple statement:</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">nodeSelection</span>.<span class="fu">attr</span>(<span class="st">&#39;r&#39;</span>, <span class="dv">10</span>);</code></pre></td></tr></table>
<p>The <code>cx</code> and <code>cy</code> values are a little trickier because they’re not the same for all of the nodes. Those values depend on properties of the data associated with the nodes. More specifically, each element in the <code>nodes</code> array has <code>x</code> and <code>y</code> properties. <span class="lgcp">D3</span>.js, however, makes it very easy to access those properties. Instead of providing constant values for the attributes, we provide functions. <span class="lgcp">D3</span>.js will then call those functions and pass the data values as parameters. Our functions can return the appropriate value for the attribute.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">nodeSelection
    .<span class="fu">attr</span>(<span class="st">&#39;r&#39;</span>, <span class="dv">10</span>)
    .<span class="fu">attr</span>(<span class="st">&#39;cx&#39;</span>, <span class="kw">function</span>(dataValue) { <span class="kw">return</span> <span class="ot">dataValue</span>.<span class="fu">x</span>; })
    .<span class="fu">attr</span>(<span class="st">&#39;cy&#39;</span>, <span class="kw">function</span>(dataValue) { <span class="kw">return</span> <span class="ot">dataValue</span>.<span class="fu">y</span>; });</code></pre></td></tr></table>
<p>Positioning the edges relies on a similar strategy. We want to set the endpoints of the lines to the centers of the corresponding nodes. Those endpoints are the <code>x1,y1</code> and <code>x2,y2</code> attributes of the <code>&lt;line&gt;</code> elements. Here’s the code to set those attributes. As is conventional with <span class="smcp">D3</span>.js, the parameter <code>d</code> is the data value.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">edgeSelection
    .<span class="fu">attr</span>(<span class="st">&#39;x1&#39;</span>, <span class="kw">function</span>(d) { <span class="kw">return</span> nodes[<span class="ot">d</span>.<span class="fu">source</span>].<span class="fu">x</span>; })
    .<span class="fu">attr</span>(<span class="st">&#39;y1&#39;</span>, <span class="kw">function</span>(d) { <span class="kw">return</span> nodes[<span class="ot">d</span>.<span class="fu">source</span>].<span class="fu">y</span>; })
    .<span class="fu">attr</span>(<span class="st">&#39;x2&#39;</span>, <span class="kw">function</span>(d) { <span class="kw">return</span> nodes[<span class="ot">d</span>.<span class="fu">target</span>].<span class="fu">x</span>; })
    .<span class="fu">attr</span>(<span class="st">&#39;y2&#39;</span>, <span class="kw">function</span>(d) { <span class="kw">return</span> nodes[<span class="ot">d</span>.<span class="fu">target</span>].<span class="fu">y</span>; });</code></pre></td></tr></table>
<p>With the elements finally drawn and positioned, we have the first version of our visualization with figure <span class="nextfigure"/>.</p>
<style>
circle {
    fill: #ccc;
    stroke: #fff;
    stroke-width: 1px;
}

line {
    stroke: #777;
    stroke-width: 1px;
}
</style>
<figure>
<div id="figure1" style="position:relative;left:-100px">

</div>
<figcaption>
<span class="lgcp">D3</span>.js provides tools to help draw the circles and lines for a network graph.
</figcaption>
</figure>
<h3 id="step-7-add-force-direction-to-the-graph">Step 7: Add Force Direction to the Graph</h3>
<p>The graph has all the essential components, but its layout doesn’t make identifying the connections as easy as we’d like. In chapter 4’s example the sigmajs library could automate the layout with only a couple of lines of JavaScript. To perform that automation, sigmajs uses a force-direction algorithm. Force direction treats nodes as physical objects and simulates the effect of forces such as gravity and electromagnetism.</p>
<p>With <span class="smcp">D3</span>.js we cannot rely on the library to fully automate the layout. As we’ve seen, <span class="smcp">D3</span>.js does not draw any of the graph elements, so it cannot, by itself, set positions and dimensions. <span class="lgcp">D3</span>.js does, however, provide a lot of tools to help us create our own graph layouts. One of those tools is the <em>force layout.</em> As you might expect, the force layout tool helps us draw our own force-directed graph. It handles all of the messy and complex calculations that underlie force direction and gives us results we can use directly in code that draws the graph.</p>
<p>To get started with the layout, we define a new <code>force</code> object. That object accepts many configuration parameters, but only five are essential for our visualization.</p>
<ul>
<li>the dimensions of the graph</li>
<li>the nodes in the graph</li>
<li>the edges in the graph</li>
<li>the distance we’d like to see between connected nodes</li>
<li>how strongly nodes repel each other, a parameter <span class="smcp">D3</span>.js calls <em>charge</em></li>
</ul>
<p>The last parameter can take a bit of trial-and-error to optimize for any particular visualization. In our case we’ll want to increase it substantially above its default (-30) because we have a lot of nodes in a small space. (Negative charge values indicate repulsion.) Here’s the code to set all of those values.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> force = <span class="ot">d3</span>.<span class="ot">layout</span>.<span class="fu">force</span>()
    .<span class="fu">size</span>([width, height])
    .<span class="fu">nodes</span>(nodes)
    .<span class="fu">links</span>(edges)
    .<span class="fu">linkDistance</span>(<span class="dv">40</span>)
    .<span class="fu">charge</span>(-<span class="dv">500</span>);</code></pre></td></tr></table>
<p>When we tell <span class="smcp">D3</span>.js to start its force direction calculations, it will generate events at intermediate steps and when the calculations complete. Force direction often takes several seconds to execute fully, and if we wait until the calculations are complete before we draw the graph, users may think the browser has frozen. It’s usually better to update the graph at each iteration so users see some indication of progress. To do that, we can add a function to respond to the intermediate force layout calculations. That happens on a <span class="smcp">D3</span>.js <code>tick</code> event.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">force</span>.<span class="fu">on</span>(<span class="st">&#39;tick&#39;</span>, <span class="kw">function</span>() {
    <span class="co">// Update graph with intermediate results</span>
});</code></pre></td></tr></table>
<p>Each time <span class="smcp">D3</span>.js calls our event handler function, it will have updated the <code>x</code> and <code>y</code> properties of the <code>nodes</code> array. The new values will reflect how the force direction has nudged the nodes on the graph’s stage. We can update our graph accordingly by changing the <span class="smcp">SVG</span> attributes of the circles and lines. Before we do that, however, we can take advantage of the fact that <span class="smcp">D3</span>.js is giving us an opportunity to tweak the force layout algorithm as it executes. One problem that we may encounter, especially with the large charge force we defined, is that nodes may repel each other so strongly that some tend to drift off the stage entirely. We can prevent that by ensuring that the node positions remain within the dimensions of the graph.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">force</span>.<span class="fu">on</span>(<span class="st">&#39;tick&#39;</span>, <span class="kw">function</span>() {
    <span class="ot">nodeSelection</span>.<span class="fu">each</span>(<span class="kw">function</span>(node) {
        <span class="ot">node</span>.<span class="fu">x</span> = <span class="ot">Math</span>.<span class="fu">max</span>(<span class="ot">node</span>.<span class="fu">x</span>, <span class="dv">5</span>);
        <span class="ot">node</span>.<span class="fu">y</span> = <span class="ot">Math</span>.<span class="fu">max</span>(<span class="ot">node</span>.<span class="fu">y</span>, <span class="dv">5</span>);
        <span class="ot">node</span>.<span class="fu">x</span> = <span class="ot">Math</span>.<span class="fu">min</span>(<span class="ot">node</span>.<span class="fu">x</span>, width<span class="dv">-5</span>);
        <span class="ot">node</span>.<span class="fu">y</span> = <span class="ot">Math</span>.<span class="fu">min</span>(<span class="ot">node</span>.<span class="fu">y</span>, height<span class="dv">-5</span>);
    });
    <span class="co">// Update graph with intermediate results</span>
});</code></pre></td></tr></table>
<p>We’ve added or subtracted <code>5</code> in the above fragment to account for the radius of the nodes’ circles.</p>
<p>Once we’ve adjusted the nodes’ properties to keep them on the stage, we can update their positions. The code is exactly the same as the code we used to position them initially.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">nodeSelection
    .<span class="fu">attr</span>(<span class="st">&#39;cx&#39;</span>, <span class="kw">function</span>(d) { <span class="kw">return</span> <span class="ot">d</span>.<span class="fu">x</span>; })
    .<span class="fu">attr</span>(<span class="st">&#39;cy&#39;</span>, <span class="kw">function</span>(d) { <span class="kw">return</span> <span class="ot">d</span>.<span class="fu">y</span>; });</code></pre></td></tr></table>
<p>We’ll also want to adjust the endpoints of our edge lines. For these objects, however, there’s a small twist. When we initialized the <code>edges</code> array, we set the <code>source</code> and <code>target</code> properties to the indices of the respective nodes in the <code>nodes</code> array. When the <span class="smcp">D3</span>.js force layout begins execution, it replaces those indices with direct references to the nodes themselves. That makes it a little easier for us to find the appropriate coordinates for the lines.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">edgeSelection
    .<span class="fu">attr</span>(<span class="st">&#39;x1&#39;</span>, <span class="kw">function</span>(d) { <span class="kw">return</span> <span class="ot">d</span>.<span class="ot">source</span>.<span class="fu">x</span>; })
    .<span class="fu">attr</span>(<span class="st">&#39;y1&#39;</span>, <span class="kw">function</span>(d) { <span class="kw">return</span> <span class="ot">d</span>.<span class="ot">source</span>.<span class="fu">y</span>; })
    .<span class="fu">attr</span>(<span class="st">&#39;x2&#39;</span>, <span class="kw">function</span>(d) { <span class="kw">return</span> <span class="ot">d</span>.<span class="ot">target</span>.<span class="fu">x</span>; })
    .<span class="fu">attr</span>(<span class="st">&#39;y2&#39;</span>, <span class="kw">function</span>(d) { <span class="kw">return</span> <span class="ot">d</span>.<span class="ot">target</span>.<span class="fu">y</span>; });</code></pre></td></tr></table>
<p>With our function ready to handle updates from the force-direction calculations, we can tell <span class="smcp">D3</span>.js to start its work. That’s a simple method of the <code>force</code> object.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">force</span>.<span class="fu">start</span>();</code></pre></td></tr></table>
<p>With that statement the graph begins an animated transition to its final, force-directed state as figure <span class="nextfigure"/> shows.</p>
<figure>
<div id="figure2">

</div>
<figcaption>
The <span class="smcp">D3</span>.js force layout provides the information to reposition network graph elements.
</figcaption>
</figure>
<h3 id="step-8-add-interactivity">Step 8: Add Interactivity</h3>
<p>Since <span class="smcp">D3</span>.js is a JavaScript library, you would expect it to support interactions with the user. It does, and to demonstrate we can add a simple interaction to the graph. When a user clicks on one of the nodes in the graph, we can emphasize that node and its neighbors.</p>
<p>Event handlers in <span class="smcp">D3</span>.js closely resemble those in other JavaScript libraries such as jQuery. We define an event handler using the <code>on()</code> method of a selection, as in the following code.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">nodeSelection</span>.<span class="fu">on</span>(<span class="st">&#39;click&#39;</span>, <span class="kw">function</span>(d) {
    <span class="co">// Handle the click event</span>
});</code></pre></td></tr></table>
<p>The first parameter to <code>on()</code> is the event type, and the second parameter is a function that <span class="smcp">D3</span>.js will call when the event occurs. The parameter to this function is the data object that corresponds to the selection element, and by convention it’s named <code>d</code>. Because we’re adding the event to the selection of nodes (<code>nodeSelection</code>), <code>d</code> will be one of the graph nodes.</p>
<p>For our visualization we’ll emphasize the clicked node by added a <span class="smcp">CSS</span>-accessible class to the corresponding <code>&lt;circle&gt;</code> and by increasing the circle’s size. The class makes it possible to style the circle uniquely, but a circle’s size cannot be specified with <span class="smcp">CSS</span> rules. Ultimately, therefore, we have to do two things to the circle: add the <code>selected</code> class and increase the radius using the <code>r</code> attribute. Of course, in order to do either we have to select the <code>&lt;circle&gt;</code> element. When <span class="smcp">D3</span>.js calls an event handler, it sets <code>this</code> equal to the target of the event; we can turn that target into a selection with <code>d3.select(this)</code>. The following code, therefore, is all it takes to change the clicked node’s circle.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"> <span class="ot">d3</span>.<span class="fu">select</span>(<span class="kw">this</span>)
    .<span class="fu">classed</span>(<span class="st">&#39;selected&#39;</span>, <span class="kw">true</span>)
    .<span class="fu">attr</span>(<span class="st">&#39;r&#39;</span>, <span class="fl">1.5</span>*nodeRadius);</code></pre></td></tr></table>
<p>We can do something similar by adding a <code>selected</code> class to all the edges that connect to the clicked node. To find those edges we can iterate through the full edge selection. <span class="lgcp">D3</span>.js provides the <code>each()</code> function to do just that. As we look at each edge we check the <code>source</code> and <code>target</code> properties to see if either matches our clicked node. When we find a match, we add the <code>selected</code> class to the edge. Note that in line 3 we’re once again using <code>d3.select(this)</code>. In this case the code is inside of the <code>each()</code> function, so <code>this</code> will equal the particular element of the current iteration. In our case that’s the <code>&lt;line&gt;</code> for the edge.</p>
<table class="sourceCode javascript numberLines line-3"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">edgeSelection</span>.<span class="fu">each</span>(<span class="kw">function</span>(edge) {
    <span class="kw">if</span> ((<span class="ot">edge</span>.<span class="fu">source</span> === d) || (<span class="ot">edge</span>.<span class="fu">target</span> === d)) {
        <span class="ot">d3</span>.<span class="fu">select</span>(<span class="kw">this</span>).<span class="fu">classed</span>(<span class="st">&#39;selected&#39;</span>,<span class="kw">true</span>);
    }
});</code></pre></td></tr></table>
<p>That code handles setting the <code>selected</code> class, but we still need to remove it when appropriate. We can remove it from all the other circles (and make sure their radius is restored to its default value) by operating on the node selection. Other than line 2 below, the code looks the same as we’ve seen before. In line 2 we use the <span class="smcp">D3</span>.js <code>filter()</code> function to limit the selection to the nodes other than the one that was clicked.</p>
<table class="sourceCode javascript numberLines line-2"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">nodeSelection
    .<span class="fu">filter</span>(<span class="kw">function</span>(node) { <span class="kw">return</span> node !== d; })
    .<span class="fu">classed</span>(<span class="st">&#39;selected&#39;</span>, <span class="kw">false</span>)
    .<span class="fu">attr</span>(<span class="st">&#39;r&#39;</span>, nodeRadius);</code></pre></td></tr></table>
<p>A similar process resets the <code>selected</code> class on all the edges. We can remove the class from all edges first, before we add to the appropriate edges in the previous code fragment. Here’s the code that removes it. With <span class="smcp">D3</span>.js it takes only a single line:</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">edgeSelection</span>.<span class="fu">classed</span>(<span class="st">&#39;selected&#39;</span>, <span class="kw">false</span>);</code></pre></td></tr></table>
<p>And finally, if the user clicks on a node that’s already selected, we can restore it to it’s default state.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">    <span class="ot">d3</span>.<span class="fu">select</span>(<span class="kw">this</span>)
        .<span class="fu">classed</span>(<span class="st">&#39;selected&#39;</span>, <span class="kw">true</span>)
        .<span class="fu">attr</span>(<span class="st">&#39;r&#39;</span>, <span class="fl">1.5</span>*nodeRadius);</code></pre></td></tr></table>
<p>When you put all of the above code fragments together, you have the complete event handler below.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">nodeSelection</span>.<span class="fu">on</span>(<span class="st">&#39;click&#39;</span>, <span class="kw">function</span>(d) {

    nodeSelection
        .<span class="fu">filter</span>(<span class="kw">function</span>(node) { <span class="kw">return</span> node !== d; })
        .<span class="fu">classed</span>(<span class="st">&#39;selected&#39;</span>, <span class="kw">false</span>)
        .<span class="fu">attr</span>(<span class="st">&#39;r&#39;</span>, nodeRadius);

    <span class="ot">edgeSelection</span>.<span class="fu">classed</span>(<span class="st">&#39;selected&#39;</span>, <span class="kw">false</span>);

    <span class="kw">if</span> (<span class="ot">d3</span>.<span class="fu">select</span>(<span class="kw">this</span>).<span class="fu">classed</span>(<span class="st">&#39;selected&#39;</span>)) {
        <span class="ot">d3</span>.<span class="fu">select</span>(<span class="kw">this</span>)
            .<span class="fu">classed</span>(<span class="st">&#39;selected&#39;</span>, <span class="kw">false</span>)
            .<span class="fu">attr</span>(<span class="st">&#39;r&#39;</span>, nodeRadius)

    } <span class="kw">else</span> {
        <span class="ot">d3</span>.<span class="fu">select</span>(<span class="kw">this</span>)
            .<span class="fu">classed</span>(<span class="st">&#39;selected&#39;</span>, <span class="kw">true</span>)
            .<span class="fu">attr</span>(<span class="st">&#39;r&#39;</span>, <span class="fl">1.5</span>*nodeRadius);
       
       <span class="ot">edgeSelection</span>.<span class="fu">each</span>(<span class="kw">function</span>(edge) {
            <span class="kw">if</span> ((<span class="ot">edge</span>.<span class="fu">source</span> === d) || (<span class="ot">edge</span>.<span class="fu">target</span> === d)) {
                <span class="ot">d3</span>.<span class="fu">select</span>(<span class="kw">this</span>).<span class="fu">classed</span>(<span class="st">&#39;selected&#39;</span>,<span class="kw">true</span>);
            }
       });
    }
});</code></pre></td></tr></table>
<p>Along with a bit of <span class="smcp">CSS</span> styling to emphasize the selected circles and lines, this code results in the interactive visualization of <span class="nextfigure"/>.</p>
<style>
#figure3 circle, #figure3 line { cursor: pointer; }
#figure3 circle.selected { fill: #97aceb; }
#figure3 line { stroke: #aaa; stroke-width: 2px; }
#figure3 line.selected { stroke: #6B7DB8; }
</style>
<figure>
<div id="figure3">

</div>
<figcaption>
<span class="lgcp">D3</span>.js includes functions to make visualizations interactive.
</figcaption>
</figure>
<p>Step 9: Experiment with Other Enhancements</p>
<p>Our example has explored many of the features that <span class="smcp">D3</span>.js provides for custom visualizations. The code so far, however, has only scratched the surface of <span class="smcp">D3</span>’s capabilities. We haven’t added labels to our graph or animated the transitions in the graph’s state. In fact, it’s a pretty safe bet that if there is anything we want to add to the visualization, <span class="smcp">D3</span>.js has tools to help. And although we don’t have the time or space to consider other enhancements here, the source code for the book does include a more full-featured implementation that takes advantage of other <span class="smcp">D3</span>.js capabilities.</p>
<script>
;(function(){

    draw = function() {

        var albums = [
          {
            album: "Miles Davis - Kind of Blue",
            musicians: [
              "Cannonball Adderley",
              "Paul Chambers",
              "Jimmy Cobb",
              "John Coltrane",
              "Miles Davis",
              "Bill Evans"
            ]
          },{
            album: "John Coltrane - A Love Supreme",
            musicians: [
              "John Coltrane",
              "Jimmy Garrison",
              "Elvin Jones",
              "McCoy Tyner"
            ]
          },{
            album: "The Dave Brubeck Quartet - Time Out",
            musicians: [
              "Dave Brubeck",
              "Paul Desmond",
              "Joe Morello",
              "Eugene Write"
            ]
          },{
            album: "Duke Ellington - Ellington at Newport",
            musicians: [
              "Harry Carney",
              "John Willie Cook",
              "Duke Ellington",
              "Paul Gonsalves",
              "Jimmy Grissom",
              "Jimmy Hamilton",
              "Johnny Hodges",
              "Quentin Jackson",
              "William Anderson",
              "Ray Nance",
              "Russell Procope",
              "John Sanders",
              "Clark Terry",
              "James Woode",
              "Britt Woodman",
              "Sam Woodyar"
            ]
          },{
            album: "The Quintet - Jazz at Massey Hall",
            musicians: [
              "Dizzy Gillespie",
              "Charles Mingus",
              "Charlie Parker",
              "Bud Powell",
              "Max Roach"
            ]
          },{
            album: "Louis Armstrong - The Best of the Hot Five and Hot Seven Recordings",
            musicians: [
              "Lil Hardin Armstrong",
              "Louis Armstrong",
              "Clarence Babcock",
              "Pete Briggs",
              "Mancy Carr",
              "Baby Dodds",
              "Johnny Dodds",
              "Earl Hines",
              "Kid Ory",
              "Don Redman",
              "Fred Robinson",
              "Zutty Singleton",
              "Johnny St. Cyr",
              "Jimmy Strong",
              "John Thomas",
              "Dave Wilborn"
            ]
          },{
            album: "John Coltrane - Blue Trane",
            musicians: [
              "Paul Chambers",
              "John Coltrane",
              "Kenny Drew",
              "Curtis Fuller",
              "Philly Joe Jones",
              "Lee Morgan"
            ]
          },{
            album: "Stan Getz and João Gilberto - Getz/Gilberto",
            musicians: [
              "Milton Banana",
              "Stan Getz",
              "Astrud Gilberto",
              "João Gilberto",
              "Antonio Carlos Jobim",
              "Sebastião Neto"
            ]
          },{
            album: "Charles Mingus - Mingus Ah Um",
            musicians: [
              "Willie Dennis",
              "Booker Ervin",
              "Shafi Hadi",
              "John Handy",
              "Jimmy Knepper",
              "Charles Mingus",
              "Horace Parlan",
              "Dannie Richmond"
            ]
          },{
            album: "Erroll Garner - Concert by the Sea",
            musicians: [
             "Denzil Best",
              "Eddie Calhoun",
              "Erroll Garner"
            ]
          },{
            album: "Miles Davis - Bitches Brew",
            musicians: [
              "Don Alias",
              "Harvey Brooks",
              "Billy Cobham",
              "Chick Corea",
              "Miles Davis",
              "Jack DeJohnette",
              "Dave Holland",
              "Bennie Maupin",
              "John McLaughlin",
              "Airto Moreira",
              "Juma Santos",
              "Wayne Shorter",
              "Lenny White",
              "Larry Young",
              "Joe Zawinul"
            ]
          },{
            album: "Sonny Rollings - Saxophone Colossus",
            musicians: [
              "Tommy Flanagan",
              "Sonny Rollins",
              "Max Roach",
              "Doug Watkins"
            ]
          },{
            album: "Art Blakey and The Jazz Messengers - Moanin'",
            musicians: [
              "Art Blakey",
              "Lee Morgan",
              "Benny Golson",
              "Bobby Timmons",
              "Jymie Merritt"
            ]
          },{
            album: "Clifford Brown and Max Roach",
            musicians: [
              "Clifford Brown",
              "Harold Land",
              "George Morrow",
              "Richie Powell",
              "Max Roach"
            ]
          },{
            album: "Thelonious Monk with John Coltrane - At Carnegie Hall",
            musicians: [
              "Ahmed Abdul-Malik",
              "John Coltrane",
              "Thelonious Monk",
              "Shadow Wilson"
            ]
          },{
            album: "Hank Mobley - Soul Station",
            musicians: [
              "Art Blakey",
              "Paul Chambers",
              "Wynton Kelly",
              "Hank Mobley"
            ]
          },{
            album: "Cannonball Adderly - Somethin' Else",
            musicians: [
              "Cannonball Adderley",
              "Art Blakey",
              "Miles Davis",
              "Hank Jones",
              "Sam Jones"
            ]
          },{
            album: "Wayne Shorter - Speak No Evil",
            musicians: [
              "Ron Carter",
              "Herbie Hancock",
              "Freddie Hubbard",
              "Elvin Jones",
              "Wayne Shorter"
            ]
          },{
            album: "Miles Davis - Birth of the Cool",
            musicians: [
              "Bill Barber",
              "Nelson Boyd",
              "Kenny Clarke",
              "Junior Collins",
              "Miles Davis",
              "Kenny Hagood",
              "Al Haig",
              "J. J. Johnson",
              "Lee Konitz",
              "John Lewis",
              "Al McKibbon",
              "Gerry Mulligan",
              "Max Roach",
              "Gunther Schuller",
              "Joe Shulman",
              "Sandy Siegelstein",
              "Kai Winding"
            ]
          },{
            album: "Herbie Hancock - Maiden Voyage",
            musicians: [
              "Ron Carter",
              "George Coleman",
              "Herbie Hancock",
              "Freddie Hubbard",
              "Tony Williams"
            ]
          },{
            album: "Vince Guaraldi Trio- A Boy Named Charlie Brown",
            musicians: [
              "Colin Bailey",
              "Monty Budwig",
              "Vince Guaraldi"
            ]
          },{
            album: "Eric Dolphy - Out to Lunch",
            musicians: [
              "Richard Davis",
              "Eric Dolphy",
              "Freddie Hubbard",
              "Bobby Hutcherson",
              "Tony Williams"
            ]
          },{
            album: "Oliver Nelson - The Blues and the Abstract Truth",
            musicians: [
              "George Barrow",
              "Paul Chambers",
              "Eric Dolphy",
              "Bill Evans",
              "Roy Haynes",
              "Freddie Hubbard",
              "Oliver Nelson"
            ]
          },{
            album: "Dexter Gordon - Go",
            musicians: [
              "Sonny Clark",
              "Dexter Gordon",
              "Billy Higgins",
              "Butch Warren"
            ]
          },{
            album: "Sarah Vaughan with Clifford Brown",
            musicians: [
              "Joe Benjamin",
              "Clifford Brown",
              "Roy Haynes",
              "Jimmy Jones",
              "John Malachi",
              "Herbie Mann",
              "Paul Quinichette",
              "Sarah Vaughan",
              "Ernie Wilkins"
            ]
          }
        ];

        var width = 640;
        var height = 400;

        var nodes1 = albums.map(function(entry, idx, list) {
            var radius = 180;
            var node = {};
            var theta = idx*2*Math.PI / list.length;
            node.name = entry.album;
            node.links = entry.musicians.slice(0);
            node.x = (width/2) + radius*Math.sin(theta);
            node.y = (height/2) + radius*Math.cos(theta);
            return node;
        });

        var links = [];

        albums.forEach(function(srcNode, srcIdx, srcList) {
            srcNode.musicians.forEach(function(srcLink) {
                for (var tgtIdx = srcIdx + 1;
                         tgtIdx < srcList.length;
                         tgtIdx++) {

                    var tgtNode = srcList[tgtIdx];
                    if (tgtNode.musicians.some(function(tgtLink){
                        return tgtLink === srcLink;
                    })) {
                        links.push({
                            source: srcIdx,
                            target: tgtIdx,
                            link: srcLink
                        });
                    }
                }
            });
        });

        var edges1 = [];

        links.forEach(function(link) {
            var existingEdge = false;
            for (var idx = 0; idx < edges1.length; idx++) {
                if ((link.source === edges1[idx].source) &&
                    (link.target === edges1[idx].target)) {
                    existingEdge = edges1[idx];
                    break;
                }
            }
            if (existingEdge) {
                existingEdge.links.push(link.link);    
            } else {
                edges1.push({
                    source: link.source,
                    target: link.target,
                    links: [link.link]
                })
            }
        });

        var svg1 = d3.select('#figure1').append('svg')
            .attr('width', width)
            .attr('height', height);

        var edgeSelection1 = svg1.selectAll("line")
            .data(edges1)
            .enter().append("line");

        var nodeSelection1 = svg1.selectAll("circle")
            .data(nodes1)
            .enter().append("circle");

        nodeSelection1
            .attr('r', width/75)
            .attr('cx', function(d) { return d.x; })
            .attr('cy', function(d) { return d.y; });
    
        edgeSelection1
            .attr('x1', function(d) { return nodes1[d.source].x; })
            .attr('y1', function(d) { return nodes1[d.source].y; })
            .attr('x2', function(d) { return nodes1[d.target].x; })
            .attr('y2', function(d) { return nodes1[d.target].y; });



        var nodes2 = albums.map(function(entry, idx, list) {
            var radius = 180;
            var node = {};
            var theta = idx*2*Math.PI / list.length;
            node.name = entry.album;
            node.links = entry.musicians.slice(0);
            node.x = (width/2) + radius*Math.sin(theta);
            node.y = (height/2) + radius*Math.cos(theta);
            return node;
        });

        var edges2 = [];

        links.forEach(function(link) {
            var existingEdge = false;
            for (var idx = 0; idx < edges2.length; idx++) {
                if ((link.source === edges2[idx].source) &&
                    (link.target === edges2[idx].target)) {
                    existingEdge = edges2[idx];
                    break;
                }
            }
            if (existingEdge) {
                existingEdge.links.push(link.link);    
            } else {
                edges2.push({
                    source: link.source,
                    target: link.target,
                    links: [link.link]
                })
            }
        });

        var svg2 = d3.select('#figure2').append('svg')
            .attr('width', width)
            .attr('height', height);

        var edgeSelection2 = svg2.selectAll("line")
            .data(edges2)
            .enter().append("line");

        var nodeSelection2 = svg2.selectAll("circle")
            .data(nodes2)
            .enter().append("circle");

        nodeSelection2
            .attr('r', width/75)
            .attr('cx', function(d) { return d.x; })
            .attr('cy', function(d) { return d.y; });
    
        edgeSelection2
            .attr('x1', function(d) { return nodes2[d.source].x; })
            .attr('y1', function(d) { return nodes2[d.source].y; })
            .attr('x2', function(d) { return nodes2[d.target].x; })
            .attr('y2', function(d) { return nodes2[d.target].y; });

        var force2 = d3.layout.force()
            .size([width, height])
            .nodes(nodes2)
            .links(edges2)
            .linkDistance(height/2)
            .charge(-500);

        force2.on('tick', function() {
            nodeSelection2.each(function(node) {
                node.x = Math.max(node.x, width/75);
                node.y = Math.max(node.y, width/75);
                node.x = Math.min(node.x, width-width/75);
                node.y = Math.min(node.y, height-width/75);
            });

            nodeSelection2
                .attr('cx', function(d) { return d.x; })
                .attr('cy', function(d) { return d.y; });
        
            edgeSelection2
                .attr('x1', function(d) { return d.source.x; })
                .attr('y1', function(d) { return d.source.y; })
                .attr('x2', function(d) { return d.target.x; })
                .attr('y2', function(d) { return d.target.y; });
        });


        force2.start();


        var nodeRadius = width/50;

        var nodes3 = albums.map(function(entry, idx, list) {
            var radius = 180;
            var node = {};
            var theta = idx*2*Math.PI / list.length;
            node.name = entry.album;
            node.links = entry.musicians.slice(0);
            node.x = (width/2) + radius*Math.sin(theta);
            node.y = (height/2) + radius*Math.cos(theta);
            return node;
        });

        var edges3 = [];

        links.forEach(function(link) {
            var existingEdge = false;
            for (var idx = 0; idx < edges3.length; idx++) {
                if ((link.source === edges3[idx].source) &&
                    (link.target === edges3[idx].target)) {
                    existingEdge = edges3[idx];
                    break;
                }
            }
            if (existingEdge) {
                existingEdge.links.push(link.link);    
            } else {
                edges3.push({
                    source: link.source,
                    target: link.target,
                    links: [link.link]
                })
            }
        });

        var svg3 = d3.select('#figure3').append('svg')
            .attr('width', width)
            .attr('height', height);

        var edgeSelection3 = svg3.selectAll("line")
            .data(edges3)
            .enter().append("line");

        var nodeSelection3 = svg3.selectAll("circle")
            .data(nodes3)
            .enter().append("circle");

        nodeSelection3
            .attr('r', nodeRadius)
            .attr('cx', function(d) { return d.x; })
            .attr('cy', function(d) { return d.y; });
    
        edgeSelection3
            .attr('x1', function(d) { return nodes3[d.source].x; })
            .attr('y1', function(d) { return nodes3[d.source].y; })
            .attr('x2', function(d) { return nodes3[d.target].x; })
            .attr('y2', function(d) { return nodes3[d.target].y; });


        var force3 = d3.layout.force()
            .size([width, height])
            .nodes(nodes3)
            .links(edges3)
            .linkDistance(height/2)
            .charge(-500);

        nodeSelection3.on('click', function(d) {
    
            nodeSelection3
                .classed('selected', false)
                .filter(function(node) { return node !== d; })
                .each(function(node) { node.selected = false;})
                .attr('r', nodeRadius)
        
            edgeSelection3.classed('selected', false);

            if (!d.selected) {
                 d3.select(this).classed('selected', true);
                 d3.select(this).attr('r', 1.5*nodeRadius);

                  edgeSelection3.each(function(edge) {
                    if ((edge.source === d) || (edge.target === d)) {
                        d3.select(this).classed('selected',true);
                        nodeSelection3
                            .filter(function(node) {return node === edge.source || node === edge.target})
                            .classed('selected',true);
                    }
                  });
      
            } else {
                d3.select(this).attr('r', nodeRadius)
            }
    
            d.selected = !d.selected;
        });

        force3.on('tick', function() {
            nodeSelection3.each(function(node) {
                node.x = Math.max(node.x, 1.5*nodeRadius);
                node.y = Math.max(node.y, 1.5*nodeRadius);
                node.x = Math.min(node.x, width-1.5*nodeRadius);
                node.y = Math.min(node.y, height-1.5*nodeRadius);
            });

            nodeSelection3
                .attr('cx', function(d) { return d.x; })
                .attr('cy', function(d) { return d.y; });
        
            edgeSelection3
                .attr('x1', function(d) { return d.source.x; })
                .attr('y1', function(d) { return d.source.y; })
                .attr('x2', function(d) { return d.target.x; })
                .attr('y2', function(d) { return d.target.y; });
        });

        force3.start();

    };

    if (typeof contentLoaded != "undefined") {
        contentLoaded.done(draw);
    } else {
        window.addEventListener('load', draw);
    }

}());
</script>
<h2 id="creating-a-choropleth-map">Creating a Choropleth Map</h2>
<p>The first two examples touched on some of the capabilities of <span class="smcp">D3</span>.js, but the library includes many others. From the examples of chapter 6, we know some of the best visualizations rely on maps, and <span class="smcp">D3</span>.js—as a general-purpose visualization library—has extensive support for mapping. We’ll look at a brief example in this section: a choropleth map of the <span class="smcp">US</span> presidential nominating events. More specifically, we’ll show the Democratic Party’s 2012 nominating events (either primary elections or caucuses) in each state, and we’ll color the state based on the date of that event.</p>
<h3 id="step-1-prepare-the-data-2">Step 1: Prepare the Data</h3>
<p>We can get the data for our visualization from the <a href="http://www.ncsl.org/research/elections-and-campaigns/2012-presidential-primary-calendar.aspx">National Conference of State Legislatures</a>. Collecting that data into a JavaScript array gives us the raw data below.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> nominatingEvents = [
    {<span class="dt">date</span>: <span class="st">&quot;2012-01-03&quot;</span>, <span class="dt">state</span>: <span class="st">&quot;IA&quot;</span>},
    {<span class="dt">date</span>: <span class="st">&quot;2012-01-10&quot;</span>, <span class="dt">state</span>: <span class="st">&quot;NH&quot;</span>},
    {<span class="dt">date</span>: <span class="st">&quot;2012-01-21&quot;</span>, <span class="dt">state</span>: <span class="st">&quot;NV&quot;</span>},
    <span class="co">// Data set continues...</span>
];</code></pre></td></tr></table>
<h3 id="step-2-set-up-the-page-1">Step 2: Set Up the Page</h3>
<p>Our skeletal web page is no different from the other <span class="smcp">D3</span>.js examples. We set aside a container for the map (line 8) and include the <span class="smcp">D3</span>.js library (line 9).</p>
<table class="sourceCode html numberLines line-8 line-9"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
<span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">&quot;en&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;head&gt;</span>
    <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;title&gt;&lt;/title&gt;</span>
  <span class="kw">&lt;/head&gt;</span>
  <span class="kw">&lt;body&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;map&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>
    <span class="kw">&lt;script</span> 
<span class="ot">      src=</span><span class="st">&quot;//cdnjs.cloudflare.com/ajax/libs/d3/3.4.6/d3.min.js&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;/script&gt;</span>
  <span class="kw">&lt;/body&gt;</span>
<span class="kw">&lt;/html&gt;</span></code></pre></td></tr></table>
<h3 id="step-3-create-a-color-scale">Step 3: Create a Color Scale</h3>
<p>In the first example in this chapter we saw how <span class="smcp">D3</span>.js provides scales to map between data values and (in the case of that example) pixel positions. For this example we can use a scale to map from a data value to a color. The data value will be the date of the nominating event, and the color will range from light to dark blue.</p>
<p>Since all the nominating events took place in the first six months of the year, we can set the input for our scale (its <em>domain</em>) to be from January 1 to June 30. As you can see from line 2, we’re converting calendar dates to integers. We use <code>new Date()</code> to construct a JavaScript <code>Date</code> object and then convert it to an integer with the plus sign (<code>+</code>). The resulting value is the number of milliseconds since January 1, 1970 <span class="smcp">UTC</span>, although the details aren’t really important in this case.</p>
<p>For the scale’s range in line 3 we’re giving <span class="smcp">D3</span>.js two colors in <span class="smcp">CSS</span> hexidecimal format. <span class="lgcp">D3</span>.js is smart enough to recognize those as a colors and construct the scale accordingly.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> color = <span class="ot">d3</span>.<span class="ot">scale</span>.<span class="fu">linear</span>()
    .<span class="fu">domain</span>([+<span class="kw">new</span> <span class="fu">Date</span>(<span class="st">&quot;2012-01-01&quot;</span>), +<span class="kw">new</span> <span class="fu">Date</span>(<span class="st">&quot;2012-06-30&quot;</span>)])
    .<span class="fu">range</span>([<span class="st">&quot;#deebf7&quot;</span>,<span class="st">&quot;#08306b&quot;</span>]);</code></pre></td></tr></table>
<h3 id="step-4-create-a-map-projection">Step 4: Create a Map Projection</h3>
<p>If you can’t quite recall your geography lessons about map projections, don’t worry. <span class="lgcp">D3</span>.js can handle all of the heavy lifting. Not only does it have extensive support for common projections, but it supports extensions for custom projections as well. For our map, we’ll use a modified Albers projection that’s optimized for the United States. It repositions (and resizes) Alaska and Hawaii to give us a convenient map of all 50 states. <span class="lgcp">D3</span>.js has support for this projection built in.</p>
<p>We set up the projection in the code below. First, in lines 1 and 2, we define the size our map in pixels. Then, in line 4, we create the modified Albers projection. Line 5 defines the scale of the map, and line 6 centers it.</p>
<p>To draw the map on the page we’re going to use <span class="smcp">SVG</span> <code>&lt;path&gt;</code> elements, but our map data takes the form of latitude and longitude values. <span class="lgcp">D3</span>.js has a <code>path</code> object to translate to <span class="smcp">SVG</span> paths based on a particular map project. In lines 8 and 9 we create our path object.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> width = <span class="dv">640</span>,
    height = <span class="dv">400</span>;

<span class="kw">var</span> projection = <span class="ot">d3</span>.<span class="ot">geo</span>.<span class="fu">albersUsa</span>()
    .<span class="fu">scale</span>(<span class="dv">1000</span>)
    .<span class="fu">translate</span>([width / <span class="dv">2</span>, height / <span class="dv">2</span>]);

<span class="kw">var</span> path = <span class="ot">d3</span>.<span class="ot">geo</span>.<span class="fu">path</span>()
    .<span class="fu">projection</span>(projection);</code></pre></td></tr></table>
<h3 id="step-5-initialize-the-svg-container">Step 5: Initialize the SVG container</h3>
<p>Just as we’ve done in the previous <span class="smcp">D3</span>.js example, we can create an <span class="smcp">SVG</span> container to hold the map.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> svg = <span class="ot">d3</span>.<span class="fu">select</span>(<span class="st">&quot;#map&quot;</span>).<span class="fu">append</span>(<span class="st">&quot;svg&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;width&quot;</span>, width)
    .<span class="fu">attr</span>(<span class="st">&quot;height&quot;</span>, height);</code></pre></td></tr></table>
<h3 id="step-6-retrieve-the-map-data">Step 6: Retrieve the Map Data</h3>
<p>For our visualization, the map data is nothing but a map of the <span class="smcp">US</span> with individual states. <span class="lgcp">D3</span>.js uses <a href="http://geojson.org"><span class="smcp">G</span>eo<span class="smcp">JSON</span></a> for its map data. Unlike most image tiles that we used in chapter 6, <span class="smcp">G</span>eo<span class="smcp">JSON</span> data is vector-based, so it can be used at any scale. <span class="lgcp">G</span>eo<span class="smcp">JSON</span> data is also in <span class="smcp">JSON</span> format, which makes it especially compatible with JavaScript.</p>
<p>The data file for our map, which you can find with the book’s source code, has the boundaries of all 50 states (plus the District of Columbia) as separate <code>feature</code>s, and each feature includes an <code>abbreviation</code> property for the state’s official two-letter abbreviation.</p>
<p>Since our data is in a <span class="smcp">JSON</span> format, we can use the <code>d3.json()</code> function to retrieve it. If you’re more familiar with jQuery, that function is almost identical to the jQuery <code>$.getJSON()</code> function.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">d3</span>.<span class="fu">json</span>(<span class="st">&quot;data/us-states.json&quot;</span>, <span class="kw">function</span>(data) {
    <span class="co">// Process the JSON data</span>
});</code></pre></td></tr></table>
<h3 id="step-7-draw-the-map">Step 7: Draw the Map</h3>
<p>Once we have our data, we can draw the map on the page. The code in this step is very similar to that in the previous example. Each state will be a <code>&lt;path&gt;</code> element within the <span class="smcp">SVG</span> container. Using the conventions of <span class="smcp">D3</span>.js, we create a selection of <code>&lt;path&gt;</code> elements (line 1) and bind those elements to our data (line 2). When there is no element we create one (line 3), and we set its <code>d</code> attribute to be the path associated with the data given our projection. Note that <code>path</code> in line 4 is the object we created in step 4.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">svg</span>.<span class="fu">selectAll</span>(<span class="st">&quot;path&quot;</span>)
    .<span class="fu">data</span>(<span class="ot">data</span>.<span class="fu">features</span>)
  .<span class="fu">enter</span>().<span class="fu">append</span>(<span class="st">&quot;path&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;d&quot;</span>, path);</code></pre></td></tr></table>
<h3 id="step-8-style-the-map">Step 8: Style the Map</h3>
<p>For our final step we’ll set the color of each state according to the date of its nominating event. The style property we use is <code>fill</code>. For its value we search through the array of events to find the matching state (line 8). We then use our <code>color</code> scale to calculate an appropriate color for that date (line 14).</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">svg</span>.<span class="fu">selectAll</span>(<span class="st">&quot;path&quot;</span>)
    .<span class="fu">data</span>(<span class="ot">data</span>.<span class="fu">features</span>)
  .<span class="fu">enter</span>().<span class="fu">append</span>(<span class="st">&quot;path&quot;</span>)
    .<span class="fu">attr</span>(<span class="st">&quot;d&quot;</span>, path)
    .<span class="fu">style</span>(<span class="st">&quot;fill&quot;</span>, <span class="kw">function</span>(d) {
        <span class="kw">var</span> date = <span class="st">&quot;2012-01-01&quot;</span>;
        <span class="ot">nominatingEvents</span>.<span class="fu">some</span>(<span class="kw">function</span>(event) {
            <span class="kw">if</span> (<span class="ot">event</span>.<span class="fu">state</span> === <span class="ot">d</span>.<span class="ot">properties</span>.<span class="fu">abbreviation</span>) {
                date = <span class="ot">event</span>.<span class="fu">date</span>;
                <span class="kw">return</span> <span class="kw">true</span>;
            }
            <span class="kw">return</span> <span class="kw">false</span>;
        });
        <span class="kw">return</span> <span class="fu">color</span>(+<span class="kw">new</span> <span class="fu">Date</span>(date));
    });</code></pre></td></tr></table>
<p>The result of our efforts is figure <span class="nextfigure"/>. The map shows all the states and colors each according to its primary or caucus date.</p>
<figure>
<div id="map1">

</div>
<figcaption>
<span class="lgcp">D3</span>.js includes many features to help in the creation of map-based visualizations.
</figcaption>
</figure>
<script>
;(function(){

    draw = function() {

        var nominatingEvents = [
            {date: "2012-01-03", state: "IA"},
            {date: "2012-01-10", state: "NH"},
            {date: "2012-01-21", state: "NV"},
            {date: "2012-01-28", state: "SC"},
            {date: "2012-02-07", state: "MO"},
            {date: "2012-02-26", state: "ME"},
            {date: "2012-03-06", state: "CO"},
            {date: "2012-03-06", state: "GA"},
            {date: "2012-03-06", state: "MA"},
            {date: "2012-03-06", state: "MN"},
            {date: "2012-03-06", state: "OH"},
            {date: "2012-03-06", state: "OK"},
            {date: "2012-03-06", state: "TN"},
            {date: "2012-03-06", state: "VT"},
            {date: "2012-03-06", state: "VA"},
            {date: "2012-03-07", state: "HI"},
            {date: "2012-03-13", state: "AL"},
            {date: "2012-03-13", state: "MS"},
            {date: "2012-03-13", state: "UT"},
            {date: "2012-03-20", state: "IL"},
            {date: "2012-03-24", state: "LA"},
            {date: "2012-03-31", state: "AZ"},
            {date: "2012-04-03", state: "DC"},
            {date: "2012-04-03", state: "MD"},
            {date: "2012-04-03", state: "TX"},
            {date: "2012-04-03", state: "WI"},
            {date: "2012-04-09", state: "AK"},
            {date: "2012-04-14", state: "ID"},
            {date: "2012-04-14", state: "KS"},
            {date: "2012-04-14", state: "NE"},
            {date: "2012-04-14", state: "WY"},
            {date: "2012-04-15", state: "WA"},
            {date: "2012-04-24", state: "CT"},
            {date: "2012-04-24", state: "DE"},
            {date: "2012-04-24", state: "NY"},
            {date: "2012-04-24", state: "PA"},
            {date: "2012-04-24", state: "RI"},
            {date: "2012-05-05", state: "FL"},
            {date: "2012-05-05", state: "MI"},
            {date: "2012-05-08", state: "IN"},
            {date: "2012-05-08", state: "NC"},
            {date: "2012-05-08", state: "WV"},
            {date: "2012-05-15", state: "OR"},
            {date: "2012-05-22", state: "AR"},
            {date: "2012-05-22", state: "KY"},
            {date: "2012-06-05", state: "CA"},
            {date: "2012-06-05", state: "MO"},
            {date: "2012-06-05", state: "NJ"},
            {date: "2012-06-05", state: "NM"},
            {date: "2012-06-05", state: "ND"},
            {date: "2012-06-05", state: "SD"}
        ];

        var width = 630,
            height = 394;

        var color = d3.scale.linear()
            .domain([+new Date("2012-01-01"), +new Date("2012-06-30")])
            .range(["#deebf7","#08306b"]);

        var projection = d3.geo.albersUsa()
            .scale(829)
            .translate([width / 2, height / 2]);

        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select("#map1").append("svg")
            .attr("width", width)
            .attr("height", height);

        d3.json("data/us-states.json", function(us) {
            svg.selectAll("path")
                .data(us.features)
              .enter().append("path")
                .attr("d", path)
                .style("fill", function(d) {
                    var date = "2012-01-03";
                    nominatingEvents.some(function(event) {
                        if (event.state === d.properties.abbreviation) {
                            date = event.date;
                            return true;
                        }
                        return false;
                    });
                    return color(+new Date(date));
                });
        });
    };

    if (typeof contentLoaded != "undefined") {
        contentLoaded.done(draw);
    } else {
        window.addEventListener('load', draw);
    }

}());
</script>
<h2 id="summing-up">Summing Up</h2>
<p>As we’ve seen in these examples, D3.js is a very powerful library for building JavaScript visualizations. Using it effectively requires a deeper understanding of JavaScript techniques than most of the other libraries we’ve seen in this book. If you make the investment to learn D3.js, though, you’ll have more control and flexibility over the results.</p>
<p>Continue reading: <a href="apndA.html">Appendix A: Managing Data in the Browser</a>.</p>
<script src="js/scripts.07.min.js"></script>
        </main>
        <footer>
            <small>Copyright © 2012-2014 by <a href="http://sathomas.me">Stephen A. Thomas</a>. All Rights Reserved.</small>
        </footer>
    <script src="js/scripts.min.js"></script>
   </body>
</html>