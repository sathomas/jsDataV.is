<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="Cache-Control" content="no-transform">
        <!--[if lte IE 8]>
            <script>window.location.href='http://browsehappy.com';</script>
        <![endif]-->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Stephen Thomas <stephen@sathomas.me>">
        <meta name="mobile-web-app-capable" content="yes">
        <link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon.png">
        <link rel="shortcut icon" href="favicon.ico">
        <link rel="stylesheet" href="css/styles.min.css">
        <title>Data Visualization with JavaScript</title>
        <script>
            var chartStyles = {
                color: {
                    text:               "#000000",  /* PRINT SCREENSHOTS: black */
                    primary:            "#CA0000",
                    primaryLightest:    "#FE4C4C",
                    primaryLight:       "#F71515",
                    primaryDark:        "#A50000",
                    primaryDarkest:     "#7B0000",
                    secondary:          "#007979",
                    secondaryLightest:  "#2D9999",
                    secondaryLight:     "#0D9494",
                    secondaryDark:      "#006363",
                    secondaryDarkest:   "#004A4A",
                    alternate:          "#7EBD00",
                    alternateLightest:  "#B6ED47",
                    alternateLight:     "#A0E714",
                    alternateDark:      "#679A00",
                    alternateDarkest:   "#4D7300"
                },
                font: {
                    family:             "print"     /* PRINT SCREENSHOTS: 'print' */
                }

            };
        </script>
    </head>
    <body>
        <nav>
            <ul>
                <li>
                    <a href="index.html" alt="jsDataV.is">
                        <svg width="32px" height="32px" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                            <title>jsDataV.is</title>
                            <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                <path d="M22.5,2.5 L16.5,15.5"  stroke="#444444" stroke-linecap="square"></path>
                                <path d="M28.5,24.5 L16.5,15.5" stroke="#444444" stroke-linecap="square"></path>
                                <path d="M9.5,28.5 L16.5,15.5"  stroke="#444444" stroke-linecap="square"></path>
                                <path d="M2.5,18.5 L16.5,15.5"  stroke="#444444" stroke-linecap="square"></path>
                                <circle fill="#CA0000" cx="9"  cy="29" r="3"></circle>
                                <circle fill="#CA0000" cx="3"  cy="18" r="3"></circle>
                                <circle fill="#CA0000" cx="29" cy="25" r="3"></circle>
                                <circle fill="#CA0000" cx="22" cy="3"  r="3"></circle>
                                <circle fill="#CA0000" cx="17" cy="15" r="6"></circle>
                            </g>
                        </svg>
                    </a>
                </li>
                <li>Contents ▾
                    <ol>
                        <li><a href="intro.html" >Introduction</a></li>
                        <li><a href="chap01.html">Graphing Data</a></li>
                        <li><a href="chap02.html">Making Charts Interactive</a></li>
                        <li><a href="chap03.html">Integrating Charts in a Page</a></li>
                        <li><a href="chap04.html">Creating Specialized Graphs</a></li>
                        <li><a href="chap05.html">Showing Timelines</a></li>
                        <li><a href="chap06.html">Visualizing Geographic Data</a></li>
                        <li><a href="chap07.html">Managing Data in the Browser</a></li>
                        <li><a href="chap08.html">Building Data-Driven Web Applications</a></li>
                        <li><a href="apnd.html"  >Custom Visualizations with D3.js</a></li>
                    </ol>
                </li>
            </ul>
        </nav>
        <main>

<style>
body { counter-reset: chapter 8; }
</style>

<h1 id="chapter-8-building-data-driven-web-applications">Chapter 8: Building Data-Driven Web Applications</h1>
<p>So far we’ve had a chance to see many of the tools and libraries for creating individual JavaScript visualizations, but we’ve only considered them in the context of a traditional web page. Today, of course, the web is much more than traditional web pages. Especially on desktop computers, web sites are effectively full featured software applications. (Even on mobile devices many “apps” are really just web sites enclosed in a thin wrapper.) When a web application is structured around data, there’s a good chance it can benefit from data visualizations. That’s exactly what we’ll consider in this chapter: how to integrate data visualization into a true web application.</p>
<p>The sections that follow will walk through the development of an example application driven by data. The source of the data will be Nike’s <a href="http://nikeplus.com">Nike+</a> service for runners. Nike sells many products and applications that let runners track their activities and save the results for analysis and review. In this chapter we’ll build a web application to retrieve that data from Nike and present it to a user. Nike, of course, has its own web app for viewing Nike+ data, and that app is far superior to the simple example of this chapter. We’re certainly not trying to compete with Nike; rather, we’re just using the Nike+ service to structure our example.</p>
<blockquote>
<p>Note 1: The examples in this chapter are based on the version of the interface at the time of this writing. There have very likely been changes to the interface since then.</p>
</blockquote>
<p>Unlike most other chapters, we won’t be considering multiple independent examples in the following sections. Instead we’ll walkthrough the main stages in the development and testing of a data-driven application.</p>
<ul>
<li>How to structure a web application using a framework or library.</li>
<li>How to organize an application into models and views.</li>
<li>How to incorporate visualizations in views.</li>
<li>How to connect application models with an external REST API.</li>
<li>How to support web browser conventions in a single page application.</li>
</ul>
<blockquote>
<p>Note 2: To use the Nike+ data in an actual product, you must register your application with Nike and get the necessary credentials and security keys. That process also grants access to the full documentation for the service, which is not publicly available. Since we’re not building a real application in this example, we won’t cover that step. We will, however, base the application on the Nike+ API, which is documented publicly on <a href="https://developer.nike.com/index.html">Nike’s developer web site</a>. Because the example doesn’t include the credentials and security keys, it won’t be able to access the real Nike+ service. The book’s source code, however, does include actual Nike+ data that can be used to emulate the Nike+ service for testing and development.</p>
</blockquote>
<h2 id="frameworks-and-libraries">Frameworks and Libraries</h2>
<p>If we’re using JavaScript to add data visualizations to traditional web pages, we don’t have to worry too much about organizing and structuring our JavaScript. After all, it’s often a relatively small amount of code, especially compared to the HTML markup and CSS styles that are also part of the page. With web applications, however, the code can grow to be more extensive and more complex. To help keep our code organized and manageable, we’ll take advantage of a JavaScript application library, sometimes also known as a framework.</p>
<h3 id="step-1-select-an-application-library">Step 1: Select an Application Library</h3>
<p>Deciding to use <em>an</em> application library might be easier than deciding <em>which</em> one to use. The number of these libraries has exploded in the past few years; there are now over 30 high quality libraries from which to choose. A good place to see all the alternatives is <a href="http://todomvc.com">TodoMVC</a>. That site serves as a showcase for application libraries; it shows how to implement a simple to-do application in each.</p>
<p>There is an important difference between these application libraries that can help narrow the choice: Is an application library a pure library or an application framework? Those terms are often used interchangeably, but there is an important distinction. A pure library functions like jQuery or other libraries we’ve used throughout this book. It provides a set of tools for our application, and we can use as many—or as little—of those tools as we like. An application framework, on the other hand, dictates exactly how the application should work. The code that we write must follow the strictures and conventions of the framework. Fundamentally the difference is about control. With a pure library our code is in control and the library is at our disposal. With a framework the framework code is in control, and we simply add the code that makes our application unique.</p>
<p>The main advantage of a pure library is flexibility. Our code is in control of the application, and we have full latitude to structure the application to our own requirements. That’s not always a good thing, however. The constraints of a framework can protect us from making poor design decisions. Some of the world’s best JavaScript developers are responsible for the popular frameworks, and they’ve put a lot of thought into what makes a good web application. There’s another benefit to frameworks: Because the framework assumes more responsibility for the application, there’s generally less code we’re required to write.</p>
<p>Having made the distinction between frameworks and pure libraries, it’s worth noting that almost any web application can be built effectively with either. Both approaches provide the organization and structure necessary for a high quality application. For our example we’ll use the <a href="http://backbonejs.org">Backbone.js</a> library. It is by far the most popular of the pure (i.e. non-framework) libraries, and it’s used by dozens of the largest sites on the web. The general approach that we’ll follow, however, (including tools such as Yeoman) work well with almost any popular application library.</p>
<h3 id="step-2-install-development-tools">Step 2: Install Development Tools</h3>
<p>When you start building your first real web application, deciding how to begin can be a bit intimidating. One tool that can be a big help at this stage is <a href="http://yeoman.io">Yeoman</a>, which describes itself as “The Web’s Scaffolding Tool for Modern Webapps.” That’s a pretty accurate description. Yeoman can define and initialize a project structure for a large number of different web application frameworks, including Backbone.js. As we’ll see, it also sets up and configures most of the other tools we’ll need during the application’s development.</p>
<p>Before we can use Yeoman we must first install <a href="http://nodejs.org">node.js</a>. Node.js is a powerful application development platform all by itself, but we won’t need to worry about the details here. It is, however, the application platform required by many modern web development tools like Yeoman. To install node.js, follow the instructions on the <a href="http://nodejs.org">node.js web site</a>.</p>
<p>With node.js installed, we can install the main Yeoman application as well as everything necessary to create a <a href="https://github.com/yeoman/generator-backbone">Backbone.js application</a> with one command. You can execute this command in the Terminal app (on Mac OS X) or from the Windows Command Prompt.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash">$ <span class="kw">npm</span> install -g generator-backbone</code></pre></td></tr></table>
<h3 id="step-3-define-a-new-project">Step 3: Define a New Project</h3>
<p>The development tools we just installed will make it easy to create a new web app project. We’ll create a new folder (named <code>running</code>) for our application and then change directory into that folder.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash">$ <span class="kw">mkdir</span> running
$ <span class="kw">cd</span> running</code></pre></td></tr></table>
<p>From within that new folder, executing the command <code>yo backbone</code> will initialize the project structure.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash">$ <span class="kw">yo</span> backbone</code></pre></td></tr></table>
<p>As part of the initialization, Yeoman will ask for permission to send diagnostic information (mainly which frameworks and features our app uses) back to the Yeoman developers. It will then give us a choice to add a few additional tools to the app. For our example we’ll skip any of the suggested options.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash"><span class="kw">Out</span> of the box I include HTML5 Boilerplate, jQuery, Backbone.js and Modernizr.
[<span class="kw">?</span>] What more would you like? (Press <span class="kw">&lt;</span>space<span class="kw">&gt;</span> to select)
❯⬡ <span class="kw">Bootstrap</span> for Sass
 ⬡ <span class="kw">Use</span> CoffeeScript
 ⬡ <span class="kw">Use</span> RequireJs</code></pre></td></tr></table>
<p>Yeoman will then do it’s magic, creating several sub-folders, installing extra tools and applications, and setting up reasonable defaults. As we watch all the pages and pages of installation information scroll by in our window, we can be glad that Yeoman is doing all this work for us. When Yeoman finishes, we’ll have a project structure like the one in figure <span class="nextfigure"/>’s screenshot. It may not look exactly like the following since web applications may have changed since this text was written. Rest assured, though, that it will follow the best practices and conventions.</p>
<figure>
<img src="img/yoproject.png" />
<figcaption>
Yeoman creates a default project structure for a web application.
</figcaption>
</figure>
<p>We’ll spend more time with most of these files and folders in the sections that follow, but here’s a quick overview of the project that Yeoman has set up for us.</p>
<ul>
<li><code>app/</code>: The folder which will contain all the code for our app.</li>
<li><code>bower.json</code>: A file that keeps track of all the third party libraries our app uses.</li>
<li><code>Gruntfile.js</code>: A file that controls how to test and build our app.</li>
<li><code>node_modules/</code>: A folder that contains the tools used to build and test our app.</li>
<li><code>package.json</code>: A file that identifies the tools used to build and test our app.</li>
<li><code>test/</code>: A folder that will contain the code we’ll write to test our app.</li>
</ul>
<p>At this point Yeoman has set up a complete web app (albeit one that doesn’t do anything). You can execute the command <code>grunt serve</code> from the command prompt to see it in a browser.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash">$ <span class="kw">grunt</span> serve
<span class="kw">Running</span> <span class="st">&quot;serve&quot;</span> task

<span class="kw">Running</span> <span class="st">&quot;clean:server&quot;</span> (clean) <span class="kw">task</span>

<span class="kw">Running</span> <span class="st">&quot;createDefaultTemplate&quot;</span> task

<span class="kw">Running</span> <span class="st">&quot;jst:compile&quot;</span> (jst) <span class="kw">task</span>
<span class="kw">&gt;&gt;</span> <span class="kw">Destination</span> not written because compiled files were empty.

<span class="kw">Running</span> <span class="st">&quot;connect:livereload&quot;</span> (connect) <span class="kw">task</span>
<span class="kw">Started</span> connect web server on http://localhost:9000

<span class="kw">Running</span> <span class="st">&quot;open:server&quot;</span> (open) <span class="kw">task</span>

<span class="kw">Running</span> <span class="st">&quot;watch:livereload&quot;</span> (watch) <span class="kw">task</span>
<span class="kw">Waiting...</span></code></pre></td></tr></table>
<p>The <code>grunt</code> command runs one of the tools that’s part of the Yeoman package. When passed the <code>serve</code> option, it cleans up the application folder, starts a web server to host the application, launches a web browser, and navigates to the skeleton app. You’ll see something like figure <span class="nextfigure"/> in your browser.</p>
<figure>
<img src="img/yoskeleton.png" />
<figcaption>
The default Yeoman web application runs in the browser.
</figcaption>
</figure>
<p>Congratulations! Our web app, as basic as it is, is now running.</p>
<h3 id="step-4-add-our-unique-dependencies">Step 4: Add our Unique Dependencies</h3>
<p>Yeoman sets up sensible defaults and tools for a new app, but our app needs a few JavaScript libraries that aren’t part of those defaults—Leaflet for maps and Flot for charts. The <a href="http://momentjs.com">Moment.js</a> library for dealing with dates and times will also come in handy, as will the <a href="http://epeli.github.io/underscore.string/">Underscore.string</a> library. We can add these libraries to our project with some simple commands. The <code>--save</code> option tells bower to remember that our project depends on these libraries.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash">$ <span class="kw">bower</span> install leaflet --save
$ <span class="kw">bower</span> install flot --save
$ <span class="kw">bower</span> install momentjs --save
$ <span class="kw">bower</span> install underscore.string --save</code></pre></td></tr></table>
<p>Perhaps you’ve already begun to appreciate how tools like Yeoman make development easier. The simple commands above save us from having to find the libraries on the web, download the appropriate files, copy them to the right place in our project, and so on.</p>
<p>Even more importantly, Yeoman (technically, it’s the <em>bower</em> tool that’s part of the Yeoman package) automatically takes care of any additional libraries on which these libraries depend. The Flot library, for example, requires jQuery. When Yeoman installs Flot it will also check and make sure that jQuery is installed in the project. In our case it is because Backbone.js depends on it, but if jQuery weren’t already installed, Yeoman would automatically find it and install it as well.</p>
<p>For most libraries <code>bower</code> can completely install all the necessary components and files. In the case of Leaflet, however, we need to perform a few extra steps. Change directory to the <code>leaflet</code> folder within <code>app/bower_components</code>. From there, run two commands to install the unique tools that Leaflet requires.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash">$ <span class="kw">npm</span> install
$ <span class="kw">npm</span> install jake -g</code></pre></td></tr></table>
<p>Executing the command <code>jake</code> will then run all of Leaflet’s tests and, provided they pass, create a <code>leaflet.js</code> library for our app.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash">$ <span class="kw">jake</span>
<span class="kw">Checking</span> for JS errors...
    <span class="kw">Check</span> passed.

<span class="kw">Checking</span> for specs JS errors...
    <span class="kw">Check</span> passed.

<span class="kw">Running</span> tests...

<span class="kw">................................................................................</span>
<span class="kw">................................................................................</span>
<span class="kw">................................................................................</span>
<span class="kw">........................................</span>
<span class="kw">PhantomJS</span> 1.9.7 (Mac OS X)<span class="kw">:</span> Executed 280 of 280 SUCCESS (0.881 secs / 0.496 secs)
    <span class="kw">Tests</span> ran successfully.


<span class="kw">Concatenating</span> and compressing 75 files...
    <span class="kw">Uncompressed</span>: 217.22 KB (unchanged)
    <span class="kw">Compressed</span>: 122.27 KB (unchanged)
    <span class="kw">Gzipped</span>: 32.71 KB</code></pre></td></tr></table>
<p>All that’s left to do is adding the additional libraries into our HTML files. That’s easy enough. The main page for our app is <code>index.html</code> in the <code>app</code> folder. There’s already a block of code that includes jQuery, Underscore.js, and Backbone.js:</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- build:js scripts/vendor.js --&gt;</span>
<span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;bower_components/jquery/dist/jquery.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;bower_components/underscore/underscore.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;bower_components/backbone/backbone.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="co">&lt;!-- endbuild --&gt;</span></code></pre></td></tr></table>
<p>We can add our new libraries after Backbone.js.</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- build:js scripts/vendor.js --&gt;</span>
<span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;bower_components/jquery/dist/jquery.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;bower_components/underscore/underscore.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;bower_components/backbone/backbone.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;bower_components/flot/jquery.flot.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;bower_components/leaflet/dist/leaflet-src.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;bower_components/momentjs/moment.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;bower_components/underscore.string/lib/underscore.string.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="co">&lt;!-- endbuild --&gt;</span></code></pre></td></tr></table>
<p>Leaflet, as we saw in chapter 6, also requires it’s own style sheet. We add that to the top of <code>index.html</code> just before <code>main.css</code>.</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- build:css(.tmp) styles/main.css --&gt;</span>
<span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="ot"> href=</span><span class="st">&quot;bower_components/leaflet/dist/leaflet.css&quot;</span><span class="kw">&gt;</span>
<span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="ot"> href=</span><span class="st">&quot;styles/main.css&quot;</span><span class="kw">&gt;</span>
<span class="co">&lt;!-- endbuild --&gt;</span></code></pre></td></tr></table>
<p>Now that we’ve set up the structure of our app and installed the necessary libraries, it’s time to start development.## Models and Views</p>
<p>There are many application libraries available for web apps, and that number may lead you to assume that there are lots of opinions on how web apps should be built. In fact, though, most of the libraries agree on the key principles that should guide an app’s architecture. Perhaps the most fundamental of those principles is separating <em>models</em> from <em>views.</em> The code that keeps track of the core data for the app—the models—should be separate from the code that presents that data to the user—the views. Enforcing this separation makes it easier to update and modify either. If you want to present your data in a table instead of a chart, you can do that without any changes to the models. And if you need to change your data source from a local file to a REST API, you can do that without any changes to the views. We’ve been employing this principle in an informal way throughout the book. In all of the examples we’ve isolated the steps required to obtain and format our data from the steps we used to visualize it. Using an application library like Backbone.js gives us the tools to manage models and views more explicitly.</p>
<h3 id="step-1-define-the-applications-models">Step 1: Define the Application’s Models</h3>
<p>In the case of our running application, it’s pretty easy to identify the models. Nike+ provides details about runs—training runs, interval workouts, trail runs, races, etc. The data set we want consists of nothing but runs, so our app’s core model is, naturally, a run.</p>
<p>The Yeoman tool makes it very easy to define a model for our app. A simple command defines a new model and creates the JavaScript files and scaffolding for that model.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash">$ <span class="kw">yo</span> backbone:model run
   <span class="kw">create</span> app/scripts/models/run.js
   <span class="kw">invoke</span>   backbone-mocha:model
   <span class="kw">create</span>     test/models/run.spec.js</code></pre></td></tr></table>
<p>That command creates two new files: <code>run.js</code> in the <code>app/scripts/models/</code> folder and <code>run.spec.js</code> in the <code>test/</code> folder. Let’s take a look at the file Yeoman created for our model. It’s quite short.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">/*global Running, Backbone*/</span>

<span class="ot">Running</span>.<span class="fu">Models</span> = <span class="ot">Running</span>.<span class="fu">Models</span> || {};

(<span class="kw">function</span> () {
    <span class="st">&#39;use strict&#39;</span>;
    <span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span> = <span class="ot">Backbone</span>.<span class="ot">Model</span>.<span class="fu">extend</span>({
        <span class="dt">url</span>: <span class="st">&#39;&#39;</span>,
        <span class="dt">initialize</span>: <span class="kw">function</span>() {
        },
        <span class="dt">defaults</span>: {
        },
        <span class="dt">validate</span>: <span class="kw">function</span>(attrs, options) {
        },
        <span class="dt">parse</span>: <span class="kw">function</span>(response, options)  {
            <span class="kw">return</span> response;
        }
    });
})();</code></pre></td></tr></table>
<p>The first line is a comment that lists the global variables our model requires. In this case there are only two: <code>Running</code> (that’s our app), and <code>Backbone</code>. The next line creates a <code>.Models</code> property of the <code>Running</code> object unless that property already exists.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="fu">Models</span> = <span class="ot">Running</span>.<span class="fu">Models</span> || {};</code></pre></td></tr></table>
<p>When the browser encounters this line it will check to see if <code>Running.Models</code> exists. If it does, then <code>Running.Models</code> won’t be <code>false</code>, and the browser never has to consider the second clause of the logical <em>or</em> (<code>||</code>). The statement simply assigns <code>Running.Models</code> to itself, so it has no practical effect. If <code>Running.Models</code> does not exist, however, then <code>Running.Models</code> evaluates to <code>false</code>, and the browser will continue to the second clause. There it finds an empty object (<code>{}</code>) and assigns that to <code>Running.Models</code>. Ultimately, this statement makes sure that the object <code>Running.Models</code> exists.</p>
<p>The rest of the code in the file is enclosed within an <em>Immediately-Invoked Function Expression.</em> If you haven’t seen this pattern before, it may look a little strange.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">(<span class="kw">function</span> () {
    <span class="co">/* code goes here */</span>
})();</code></pre></td></tr></table>
<p>If we re-write the block as a single line, though, it might be easier to understand.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">( <span class="kw">function</span> () { <span class="co">/* code goes here */</span> } ) ();</code></pre></td></tr></table>
<p>The statement defines a JavaScript function with a function expression, <code>function () { /* ... */ }</code>, and then, with the concluding <code>()</code>, calls (technically <em>invokes</em>) that newly created function. All we’re really doing, therefore, is putting our code inside of a function and calling that function. You’ll see this pattern a lot in professional JavaScript because it protects a block of code from interfering with other code blocks in the application.</p>
<p>When you define a variable in JavaScript, that variable is a <em>global</em> variable, available everywhere in the code. As a consequence, if two different sections of code try to define the same global variable, those definitions will clash. This interaction can cause bugs that are very hard to find, as code in once section inadvertently interferes with code in a completely different section. To prevent this problem we can avoid using global variables, and the easiest way to do that in JavaScript is to define our variables inside a function. That’s the purpose of an immediately-invoked function expression. It makes sure that any variables our code defines are local to the function rather than global, and it prevents our code blocks from interfering with each other.</p>
<h3 id="step-2-implement-the-model">Step 2: Implement the Model</h3>
<p>Our application really only needs one model, so now we can finally start implementing. The lengthy explanation in the previous step might make you a little wary. If simply defining the model requires that much work (although, to be fair, it was only a single command), the prospect of actual coding might be even more intimidating. Fortunately there is no need to fear. This step is surely the easiest in the entire book. It’s already complete! That’s right, the scaffolding that Yeoman has set up for us is a complete and functioning model for a Run. In fact, if it weren’t for some quirks in Nike’s REST API, we wouldn’t have to touch the model code at all. We’ll address those quirks in a later section.</p>
<p>Rather than simply moving on to the next step, though, let’s spend a little time looking at what we can do with our newly created model. To do that we can make one temporary addition to the model code. This change is temporary because we won’t need it in the final app. From the Nike+ documentation we find that the URL to retrieve details about a run (Nike+ uses the more general term “activity”) is <code>https://api.nike.com/v1/me/sport/activities/{activityId}</code>. The final part depends on the specific activity, so we’ll add only the general part of the URL to our model.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span> = <span class="ot">Backbone</span>.<span class="ot">Model</span>.<span class="fu">extend</span>({
    <span class="dt">url</span>: <span class="st">&#39;https://api.nike.com/v1/me/sport/activities/&#39;</span>,
    <span class="dt">initialize</span>: <span class="kw">function</span>() {
    },
    <span class="dt">defaults</span>: {
    },
    <span class="dt">validate</span>: <span class="kw">function</span>(attrs, options) {
    },
    <span class="dt">parse</span>: <span class="kw">function</span>(response, options)  {
        <span class="kw">return</span> response;
    }
});</code></pre></td></tr></table>
<p>Now imagine that we want to get the details for a specific run from the Nike+ service. The run in question has a unique identifier of <code>2126456911</code>. If the Nike+ API followed typical conventions, we could create a variable representing that run, <em>and get all it’s data,</em> with two statements.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> run = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span>({<span class="dt">id</span>: <span class="dv">2126456911</span>});
<span class="ot">run</span>.<span class="fu">fetch</span>();</code></pre></td></tr></table>
<p>The first statement creates a new instance of the Run model and specifies it’s identifier. The second statement tells Backbone to retrieve the model’s data from the server. Backbone takes care of all the communication with Nike+, including error handling, timeouts, parsing the response, and so on. Once the fetch completes, detailed information from that run will be available from the model. If we provide a callback function, we can output some of the details. For example:</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> run = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span>({<span class="dt">id</span>: <span class="dv">2126456911</span>});
<span class="ot">run</span>.<span class="fu">fetch</span>({<span class="dt">success</span>: <span class="kw">function</span>() {
    <span class="ot">console</span>.<span class="fu">log</span>(<span class="st">&quot;Run started at &quot;</span>, <span class="ot">run</span>.<span class="fu">get</span>(<span class="st">&#39;startTime&#39;</span>));
    <span class="ot">console</span>.<span class="fu">log</span>(<span class="st">&quot;    Duration: &quot;</span>,  <span class="ot">run</span>.<span class="fu">get</span>(<span class="st">&#39;metricSummary&#39;</span>).<span class="fu">duration</span>);
    <span class="ot">console</span>.<span class="fu">log</span>(<span class="st">&quot;    Distance: &quot;</span>,  <span class="ot">run</span>.<span class="fu">get</span>(<span class="st">&#39;metricSummary&#39;</span>).<span class="fu">distance</span>);
    <span class="ot">console</span>.<span class="fu">log</span>(<span class="st">&quot;    Calories: &quot;</span>,  <span class="ot">run</span>.<span class="fu">get</span>(<span class="st">&#39;metricSummary&#39;</span>).<span class="fu">calories</span>);
}});</code></pre></td></tr></table>
<p>The output in the browser’s console would be:</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash"><span class="kw">Run</span> started at 2013-04-09T10:54:33Z
    <span class="kw">Duration</span>: 0:22:39.000
    <span class="kw">Distance</span>: 3.7524
    <span class="kw">Calories</span>: 240</code></pre></td></tr></table>
<p>Not bad for a few simple lines of code. The code in this step, though, is really just a detour. Our application won’t use individual models in this way. Instead we’ll use an even more powerful Backbone.js feature: collections.</p>
<h3 id="step-3-define-the-applications-collections">Step 3: Define the Application’s Collections</h3>
<p>If our application only needed a single object for its data, then we could easily capture that data in a model. Our users, however, aren’t interested in just a single run. They’d like to see all of their runs, dozens, hundreds, possibly thousands of them. Fortunately, Backbone.js can help. One of the core concepts of Backbone.js is a <em>collection,</em> or group of models. Let’s define a collection for all of the user’s runs.</p>
<p>Yeoman makes it easy to define and set up scaffolding for our collection. We execute the single command <code>yo backbone:collection runs</code> from the command line. (Yes, we’re being very original and calling our collection of runs, well, <em>runs.</em>)</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash">$ <span class="kw">yo</span> backbone:collection runs
   <span class="kw">create</span> app/scripts/collections/runs.js
   <span class="kw">invoke</span>   backbone-mocha:collection
   <span class="kw">create</span>     test/collections/runs.spec.js</code></pre></td></tr></table>
<p>Yeoman does the same thing for collections as it did for models. It creates an implementation file (<code>runs.js</code> in the <code>app/scripts/collections/</code> folder) and a test file. For now, let’s take a look at <code>runs.js</code>.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">/*global Running, Backbone*/</span>

<span class="ot">Running</span>.<span class="fu">Collections</span> = <span class="ot">Running</span>.<span class="fu">Collections</span> || {};

(<span class="kw">function</span> () {
    <span class="st">&#39;use strict&#39;</span>;
    <span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span> = <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="fu">extend</span>({
        <span class="dt">model</span>: <span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Runs</span>
    });
})();</code></pre></td></tr></table>
<p>This file is even simpler than our model; the default collection only has a single property to indicate what type of model the collection contains. Unfortunately, Yeoman isn’t smart enough to handle plurals, so it assumes the name of the model is the same as the name of the collection. That’s not true for our app, as our model is a <em>Run</em> (singular) and the collection is <em>Runs</em> (plural). We’ll need to change that by removing the <code>s</code>. While we’re making this change, we can also add a property to specify the REST API for the collection. That’s a URL from the Nike+ service.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span> = <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="fu">extend</span>({
    <span class="dt">url</span>: <span class="st">&#39;https://api.nike.com/v1/me/sport/activities/&#39;</span>,
    <span class="dt">model</span>: <span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span>
});</code></pre></td></tr></table>
<p>With those two small changes, we’re ready to take advantage of our new collection. (Well, we would be if the Nike+ API didn’t have a few quirks that we’ll address later; we’ll ignore that complication for now.) All we need to do is create a new instance of the Runs collection and then fetch its data.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> runs = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span>();
<span class="ot">runs</span>.<span class="fu">fetch</span>();</code></pre></td></tr></table>
<p>That’s all it takes to build a collection containing the user’s runs. Backbone.js creates a model for each and retrieves the model’s data from the server. Even better, those run models are stored in a true Underscore.js collection. (If you skipped the previous chapter on Underscore.js, you might want to pause now and take a look.) All of the powerful Underscore.js features are available. Suppose, for example, we want to find the total distance for all of a user’s runs. That’s a tailor-made for the Underscore.js <code>reduce</code> function.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> totalDistance = <span class="ot">runs</span>.<span class="fu">reduce</span>( <span class="kw">function</span>(sum, run) {
    <span class="kw">return</span> sum + <span class="ot">run</span>.<span class="fu">get</span>(<span class="st">&#39;metricSummary&#39;</span>).<span class="fu">distance</span>;
}, <span class="dv">0</span>);</code></pre></td></tr></table>
<p>That code could tell us, for example, that the user has logged a total of 3358 km with Nike+.</p>
<blockquote>
<p>In case you’re wondering, the relationship between Backbone.js and Underscore.js is not a coincidence. Jeremy Ashkenas is the lead developer for both projects.</p>
</blockquote>
<h3 id="step-4-define-the-applications-main-view">Step 4: Define the Application’s Main View</h3>
<p>Now that we have all the running data for a user, it’s time to present that data. We’ll do that with Backbone.js <em>views.</em> To keep our example simple, we’ll only consider two ways to show the running data. First we’ll display a table listing summary information about each run. Then, if the user clicks on a table row, we’ll show details about that specific run. The main view of our application will be the summary table, so let’s focus on that first.</p>
<p>A Backbone.js view is responsible for the presenting data to the user, and that data may be maintained in a collection or a model. For the main page of our app, we want to show summary information for all of a user’s runs. That view, therefore, is a view of the entire collection. We’ll call the view <em>Summary.</em> Before we stop thinking about views, though, consider what’s going to make up that summary table. The bulk of the table will be a series of table rows, and each row will present summary data about an individual run. That suggests an additional view for our app, the view of a single Run model presented as a table row. Let’s use that view as well, so that our main Summary view is made up (mostly) of many <em>SummaryRow</em> views. We can once again rely on Yeoman to set up the scaffolding for both of those types of views.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash">$ <span class="kw">yo</span> backbone:view summary
   <span class="kw">create</span> app/scripts/templates/summary.ejs
   <span class="kw">create</span> app/scripts/views/summary.js
   <span class="kw">invoke</span>   backbone-mocha:view
   <span class="kw">create</span>     test/views/summary.spec.js
$ <span class="kw">yo</span> backbone:view summaryRow
   <span class="kw">create</span> app/scripts/templates/summaryRow.ejs
   <span class="kw">create</span> app/scripts/views/summaryRow.js
   <span class="kw">invoke</span>   backbone-mocha:view
   <span class="kw">create</span>     test/views/summaryRow.spec.js</code></pre></td></tr></table>
<p>The scaffolding that Yeoman sets up is pretty much the same for each view; only the name varies. Here’s what a Summary view looks like.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">/*global Running, Backbone, JST*/</span>

<span class="ot">Running</span>.<span class="fu">Views</span> = <span class="ot">Running</span>.<span class="fu">Views</span> || {};

(<span class="kw">function</span> () {
    <span class="st">&#39;use strict&#39;</span>;
    <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Summary</span> = <span class="ot">Backbone</span>.<span class="ot">View</span>.<span class="fu">extend</span>({
        <span class="dt">template</span>: JST[<span class="st">&#39;app/scripts/templates/summary.ejs&#39;</span>],
        <span class="dt">tagName</span>: <span class="st">&#39;div&#39;</span>,
        <span class="dt">id</span>: <span class="st">&#39;&#39;</span>,
        <span class="dt">className</span>: <span class="st">&#39;&#39;</span>,
        <span class="dt">events</span>: {},
        <span class="dt">initialize</span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">listenTo</span>(<span class="kw">this</span>.<span class="fu">model</span>, <span class="st">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
        },
        <span class="dt">render</span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="ot">$el</span>.<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>(<span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">toJSON</span>()));
        }
    });
})();</code></pre></td></tr></table>
<p>The overall structure of the file is the same as our model and our collection, but there’s a bit more going on in the view itself. Let’s step through view’s properties one at a time. The first property is <code>template</code>. That’s where we define the exact HTML markup for the view, and we’ll look at this in more detail in the next step.</p>
<p>The <code>tagName</code> property defines the HTML tag that our view will use as it’s parent. Yeoman defaults it to a generic <code>&lt;div&gt;</code>, but we know that in our case it will be a <code>&lt;table&gt;</code>. It’s easy enough to change it, and we’ll do so in a moment.</p>
<p>The <code>id</code> and <code>className</code> properties specify HTML <code>id</code> attributes or <code>class</code> values to add to the main container (in our case the <code>&lt;table&gt;</code>). We could, for example, base some CSS styles on these values. For our example we’re not considering styles, so we can leave both properties blank or delete them entirely.</p>
<p>Next is the <code>events</code> property. This object identifies user events (such as mouse clicks) that are relevant for the view. In the case of the Summary view, there are no events, so we can leave the object empty or simply delete it.</p>
<p>The last two properties, <code>initialize</code> and <code>render</code>, are both methods. Backbone.js will call <code>initialize</code> when it first creates a view, and it will call <code>render</code> when the view should build or update the HTML markup. In the default Yeoman scaffolding, neither method has a return value. It’s quite handy, however, if a view’s methods return the view itself. That return value makes it easy to chain methods together in a single JavaScript statement. We can add the return statement to both methods. We’ll also make a small change to the <code>initialize</code> method. The first statement within it refers to <code>this.model</code> because Yeoman assumes that views are model views. The Summary view is for a collection rather than a model, so we should change the code accordingly. The <code>render</code> function also refers to a model; it has the fragment <code>this.model.toJSON()</code>. Rather than change this code to <code>collection</code>, we’ll simply delete it entirely. We’ll see why in the next section on templates.</p>
<p>Before we consider the implementation of the last two methods, let’s take a look at the resulting Summary view so far.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Summary</span> = <span class="ot">Backbone</span>.<span class="ot">View</span>.<span class="fu">extend</span>({
    <span class="dt">template</span>: JST[<span class="st">&#39;app/scripts/templates/summary.ejs&#39;</span>],
    <span class="dt">tagName</span>: <span class="st">&#39;table&#39;</span>,
    <span class="dt">initialize</span>: <span class="kw">function</span> () {
        <span class="kw">this</span>.<span class="fu">listenTo</span>(<span class="kw">this</span>.<span class="fu">collection</span>, <span class="st">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
        <span class="kw">return</span> <span class="kw">this</span>;
    },
    <span class="dt">render</span>: <span class="kw">function</span> () {
        <span class="kw">this</span>.<span class="ot">$el</span>.<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>());
        <span class="kw">return</span> <span class="kw">this</span>;
    }
});</code></pre></td></tr></table>
<p>Now let’s look inside the last two methods, starting with <code>initialize</code>. That method has a single statement (other than the <code>return</code> statement that we just added). By calling <code>listenTo</code>, it tells Backbone.js that the view wants to listen for events. The first parameter, <code>this.collection</code>, specifies the event target, so the statement says that the view wants to listen to events affecting the collection. The second parameter specifies the type of events. In this case the view wants to know whenever the collection changes. The final parameter is the function Backbone.js should call when the event occurs. Every time the Runs collection changes, we want Backbone.js to call the view’s <code>render</code> method. That makes sense. Whenever the Runs collection changes, whatever we were displaying on the page before is now out-of-date. To make it current, our view should refresh its contents.</p>
<p>Most of the real work of a view takes place in its <code>render</code> method. After all, this is the code that actually creates the HTML markup for the web page. Yeoman has gotten us started with a template, but, in the case of a collection view, that’s not enough. The template takes care of the HTML for the collection as a whole, but it doesn’t handle the models that are part of the collection. For the individual runs, we can use Underscore.js to iterate through the collection and render each run.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">    render: <span class="kw">function</span> () {
        <span class="kw">this</span>.<span class="ot">$el</span>.<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>());
        <span class="kw">this</span>.<span class="ot">collection</span>.<span class="fu">each</span>(<span class="kw">this</span>.<span class="fu">renderRun</span>, <span class="kw">this</span>);
        <span class="kw">return</span> <span class="kw">this</span>;
    },</code></pre></td></tr></table>
<p>Now we have to write the <code>renderRun</code> method that handles each individual run. Here’s what we want that function to do:</p>
<ol type="1">
<li>Create a new SummaryRow view for the run.</li>
<li>Render that Summary Row view.</li>
<li>Append the resulting HTML to the <code>&lt;tbody&gt;</code> in the Summary view.</li>
</ol>
<p>The code to implement those steps is straightforward, but it’s helpful to take each step one at a time.</p>
<ol type="1">
<li>Create a new SummaryRow view: <code>new SummaryRow({model: run})</code></li>
<li>Render that Summary Row view: <code>.render()</code></li>
<li>Append the result: <code>this.$('tbody').append();</code></li>
</ol>
<p>When we put the steps together we have the <code>renderRun</code> method.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">    renderRun: <span class="kw">function</span> (run) {
        <span class="kw">this</span>.<span class="fu">$</span>(<span class="st">&#39;tbody&#39;</span>).<span class="fu">append</span>(<span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">SummaryRow</span>({
            <span class="dt">model</span>: run
        }).<span class="fu">render</span>().<span class="fu">el</span>);
    }</code></pre></td></tr></table>
<p>Most of the changes we made to the Summary view are also appropriate for the SummaryRow view, although we don’t need to add anything to the <code>render</code> method. Here’s our first implementation of the SummaryRow. Note that we’ve set the <code>tagName</code> property to <code>'tr'</code> because we want each run model presented as a table row.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">SummaryRow</span> = <span class="ot">Backbone</span>.<span class="ot">View</span>.<span class="fu">extend</span>({
    <span class="dt">template</span>: JST[<span class="st">&#39;app/scripts/templates/summaryRow.ejs&#39;</span>],
    <span class="dt">tagName</span>: <span class="st">&#39;tr&#39;</span>,
    <span class="dt">events</span>: {},
    <span class="dt">initialize</span>: <span class="kw">function</span> () {
        <span class="kw">this</span>.<span class="fu">listenTo</span>(<span class="kw">this</span>.<span class="fu">model</span>, <span class="st">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
        <span class="kw">return</span> <span class="kw">this</span>;
    },
    <span class="dt">render</span>: <span class="kw">function</span> () {
        <span class="kw">this</span>.<span class="ot">$el</span>.<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>(<span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">toJSON</span>()));
        <span class="kw">return</span> <span class="kw">this</span>;
    }
});</code></pre></td></tr></table>
<p>Now we have all the JavaScript code we need to show the main summary view for our app.</p>
<h3 id="step-5-define-the-main-view-templates">Step 5: Define the Main View Templates</h3>
<p>So far we’ve developed the JavaScript code to manipulate our Summary and SummaryRow views. That code doesn’t generate the actual HTML markup, though. For that task we rely on templates. Templates are skeletal HTML markup with placeholders for individual values. Confining HTML markup to templates helps keep our JavaScript code clean, well-structured, and easy to maintain.</p>
<p>Just as there are many popular JavaScript application libraries, there are also many template languages. Our application doesn’t require any fancy template functionality, however, so we’ll stick with the default template process that Yeoman has set up for us. That process relies on a <a href="https://github.com/gruntjs/grunt-contrib-jst">JST tool</a> to process templates, and the tool uses the <a href="http://underscorejs.org/#template">Underscore.js template language</a>. It’s easy to see how this works through an example, so let’s dive in.</p>
<p>The first template we’ll tackle is the template for a SummaryRow. In our view we’ve already established that the SummaryRow is a <code>&lt;tr&gt;</code> element, so the template only needs to supply the content that lives within that <code>&lt;tr&gt;</code>. We’ll get that content from the associated Run model which, in turn, comes from the Nike+ service. Here’s an example activity that Nike+ could return.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">{
    <span class="st">&quot;activityId&quot;</span>: <span class="st">&quot;2126456911&quot;</span>,
    <span class="st">&quot;activityType&quot;</span>: <span class="st">&quot;RUN&quot;</span>,
    <span class="st">&quot;startTime&quot;</span>: <span class="st">&quot;2013-04-09T10:54:33Z&quot;</span>,
    <span class="st">&quot;activityTimeZone&quot;</span>: <span class="st">&quot;GMT-04:00&quot;</span>,
    <span class="st">&quot;status&quot;</span>: <span class="st">&quot;COMPLETE&quot;</span>,
    <span class="st">&quot;deviceType&quot;</span>: <span class="st">&quot;IPOD&quot;</span>,
    <span class="st">&quot;metricSummary&quot;</span>: {
        <span class="st">&quot;calories&quot;</span>: <span class="dv">240</span>,
        <span class="st">&quot;fuel&quot;</span>: <span class="dv">790</span>,
        <span class="st">&quot;distance&quot;</span>: <span class="fl">3.7524</span>,
        <span class="st">&quot;steps&quot;</span>: <span class="dv">0</span>,
        <span class="st">&quot;duration&quot;</span>: <span class="st">&quot;0:22:39.000&quot;</span>
    },
    <span class="st">&quot;tags&quot;</span>: [<span class="co">/* Data continues... */</span>],
    <span class="st">&quot;metrics&quot;</span>: [<span class="co">/* Data continues... */</span>],
    <span class="st">&quot;gps&quot;</span>: {<span class="co">/* Data continues... */</span>}
}</code></pre></td></tr></table>
<p>For a first implementation, let’s show the time of the run, as well as it’s duration, distance, and calories. Our table row, therefore, will have four cells with each cell holding one of these values. We can find the template in the <code>app/scripts/templates</code> folder. It’s the <code>summaryRow.ejs</code> file. By default, Yeoman sets it to a simple paragraph.</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="kw">&lt;p&gt;</span>Your content here.<span class="kw">&lt;/p&gt;</span></code></pre></td></tr></table>
<p>Let’s replace that with four table cells.</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="kw">&lt;td&gt;&lt;/td&gt;</span>
<span class="kw">&lt;td&gt;&lt;/td&gt;</span>
<span class="kw">&lt;td&gt;&lt;/td&gt;</span>
<span class="kw">&lt;td&gt;&lt;/td&gt;</span></code></pre></td></tr></table>
<p>As placeholders for the cells’ content, we can use model attributes enclosed in special <code>&lt;%=</code> and <code>%&gt;</code> delimiters. The full SummaryRow template, therefore, is as follows.</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="kw">&lt;td&gt;</span><span class="er">&lt;</span>%= startTime %&gt;<span class="kw">&lt;/td&gt;</span>
<span class="kw">&lt;td&gt;</span><span class="er">&lt;</span>%= metricSummary.duration %&gt;<span class="kw">&lt;/td&gt;</span>
<span class="kw">&lt;td&gt;</span><span class="er">&lt;</span>%= metricSummary.distance %&gt;<span class="kw">&lt;/td&gt;</span>
<span class="kw">&lt;td&gt;</span><span class="er">&lt;</span>%= metricSummary.calories %&gt;<span class="kw">&lt;/td&gt;</span></code></pre></td></tr></table>
<p>The other template we need to supply is the Summary template. Since we’ve already set the view’s main tag to be a <code>&lt;table&gt;</code>, that template should specify the content within that <code>&lt;table&gt;</code>, absent the individual rows for the Run models. That suggests the template should include the table header row plus a <code>&lt;tbody&gt;</code> element.</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="kw">&lt;thead&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;th&gt;</span>Time<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Duration<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Distance<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Calories<span class="kw">&lt;/th&gt;&lt;/tr&gt;</span>
<span class="kw">&lt;/thead&gt;</span>
<span class="kw">&lt;tbody&gt;&lt;/tbody&gt;</span></code></pre></td></tr></table>
<p>Now we’re finally ready to construct the main view for our runs. The steps are quite straigtforward.</p>
<ol type="1">
<li>Create a new Runs collection.</li>
<li>Fetch the data for that collection from the server.</li>
<li>Create a new Summary view for the collection.</li>
<li>Render the view.</li>
</ol>
<p>Here’s the JavaScript code for those four steps.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> runs = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Collection</span>.<span class="fu">Runs</span>();
<span class="ot">runs</span>.<span class="fu">fetch</span>();
<span class="kw">var</span> summaryView = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Summary</span>({<span class="dt">collection</span>: runs});
<span class="ot">summaryView</span>.<span class="fu">render</span>();</code></pre></td></tr></table>
<p>We can access the constructed <code>&lt;table&gt;</code> as the <code>el</code> (short for <em>element</em>) property of the view. It will look something like the following.</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="kw">&lt;table&gt;</span>
  <span class="kw">&lt;thead&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;th&gt;</span>Time<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Duration<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Distance<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Calories<span class="kw">&lt;/th&gt;&lt;/tr&gt;</span>
  <span class="kw">&lt;/thead&gt;</span>
  <span class="kw">&lt;tbody&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;td&gt;</span>2013-04-09T10:54:33Z<span class="kw">&lt;/td&gt;&lt;td&gt;</span>0:22:39.000<span class="kw">&lt;/td&gt;&lt;td&gt;</span>3.7524<span class="kw">&lt;/td&gt;&lt;td&gt;</span>240<span class="kw">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;td&gt;</span>2013-04-07T12:34:40Z<span class="kw">&lt;/td&gt;&lt;td&gt;</span>0:44:59.000<span class="kw">&lt;/td&gt;&lt;td&gt;</span>8.1724<span class="kw">&lt;/td&gt;&lt;td&gt;</span>569<span class="kw">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;td&gt;</span>2013-04-06T13:28:36Z<span class="kw">&lt;/td&gt;&lt;td&gt;</span>1:28:59.000<span class="kw">&lt;/td&gt;&lt;td&gt;</span>16.068001<span class="kw">&lt;/td&gt;&lt;td&gt;</span>1200<span class="kw">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;td&gt;</span>2013-04-04T11:57:16Z<span class="kw">&lt;/td&gt;&lt;td&gt;</span>0:58:44.000<span class="kw">&lt;/td&gt;&lt;td&gt;</span>9.623<span class="kw">&lt;/td&gt;&lt;td&gt;</span>736<span class="kw">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;td&gt;</span>2013-04-02T11:42:47Z<span class="kw">&lt;/td&gt;&lt;td&gt;</span>0:22:37.000<span class="kw">&lt;/td&gt;&lt;td&gt;</span>3.6368<span class="kw">&lt;/td&gt;&lt;td&gt;</span>293<span class="kw">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;td&gt;</span>2013-03-31T12:44:00Z<span class="kw">&lt;/td&gt;&lt;td&gt;</span>0:34:04.000<span class="kw">&lt;/td&gt;&lt;td&gt;</span>6.3987<span class="kw">&lt;/td&gt;&lt;td&gt;</span>445<span class="kw">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;td&gt;</span>2013-03-30T13:15:35Z<span class="kw">&lt;/td&gt;&lt;td&gt;</span>1:29:31.000<span class="kw">&lt;/td&gt;&lt;td&gt;</span>16.0548<span class="kw">&lt;/td&gt;&lt;td&gt;</span>1203<span class="kw">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;td&gt;</span>2013-03-28T11:42:17Z<span class="kw">&lt;/td&gt;&lt;td&gt;</span>1:04:09.000<span class="kw">&lt;/td&gt;&lt;td&gt;</span>11.1741<span class="kw">&lt;/td&gt;&lt;td&gt;</span>852<span class="kw">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;td&gt;</span>2013-03-26T12:21:52Z<span class="kw">&lt;/td&gt;&lt;td&gt;</span>0:39:33.000<span class="kw">&lt;/td&gt;&lt;td&gt;</span>7.3032<span class="kw">&lt;/td&gt;&lt;td&gt;</span>514<span class="kw">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;td&gt;</span>2013-03-24T20:15:31Z<span class="kw">&lt;/td&gt;&lt;td&gt;</span>0:33:49.000<span class="kw">&lt;/td&gt;&lt;td&gt;</span>6.2886<span class="kw">&lt;/td&gt;&lt;td&gt;</span>455<span class="kw">&lt;/td&gt;&lt;/tr&gt;</span>
  <span class="kw">&lt;/tbody&gt;</span>
<span class="kw">&lt;/table&gt;</span></code></pre></td></tr></table>
<p>When we insert that markup in the page, our users can see a simple summary table listing their runs.</p>
<table>
<thead>
<pre><code>&lt;tr&gt;&lt;th&gt;Time&lt;/th&gt;&lt;th&gt;Duration&lt;/th&gt;&lt;th&gt;Distance&lt;/th&gt;&lt;th&gt;Calories&lt;/th&gt;&lt;/tr&gt;</code></pre>
</thead>
<tbody>
<pre><code>&lt;tr&gt;&lt;td&gt;2013-04-09T10:54:33Z&lt;/td&gt;&lt;td&gt;0:22:39.000&lt;/td&gt;&lt;td&gt;3.7524&lt;/td&gt;&lt;td&gt;240&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2013-04-07T12:34:40Z&lt;/td&gt;&lt;td&gt;0:44:59.000&lt;/td&gt;&lt;td&gt;8.1724&lt;/td&gt;&lt;td&gt;569&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2013-04-06T13:28:36Z&lt;/td&gt;&lt;td&gt;1:28:59.000&lt;/td&gt;&lt;td&gt;16.068001&lt;/td&gt;&lt;td&gt;1200&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2013-04-04T11:57:16Z&lt;/td&gt;&lt;td&gt;0:58:44.000&lt;/td&gt;&lt;td&gt;9.623&lt;/td&gt;&lt;td&gt;736&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2013-04-02T11:42:47Z&lt;/td&gt;&lt;td&gt;0:22:37.000&lt;/td&gt;&lt;td&gt;3.6368&lt;/td&gt;&lt;td&gt;293&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2013-03-31T12:44:00Z&lt;/td&gt;&lt;td&gt;0:34:04.000&lt;/td&gt;&lt;td&gt;6.3987&lt;/td&gt;&lt;td&gt;445&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2013-03-30T13:15:35Z&lt;/td&gt;&lt;td&gt;1:29:31.000&lt;/td&gt;&lt;td&gt;16.0548&lt;/td&gt;&lt;td&gt;1203&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2013-03-28T11:42:17Z&lt;/td&gt;&lt;td&gt;1:04:09.000&lt;/td&gt;&lt;td&gt;11.1741&lt;/td&gt;&lt;td&gt;852&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2013-03-26T12:21:52Z&lt;/td&gt;&lt;td&gt;0:39:33.000&lt;/td&gt;&lt;td&gt;7.3032&lt;/td&gt;&lt;td&gt;514&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2013-03-24T20:15:31Z&lt;/td&gt;&lt;td&gt;0:33:49.000&lt;/td&gt;&lt;td&gt;6.2886&lt;/td&gt;&lt;td&gt;455&lt;/td&gt;&lt;/tr&gt;</code></pre>
</tbody>
</table>
<h3 id="step-6-refine-the-main-view">Step 6: Refine the Main View</h3>
<p>Now we’re starting to get somewhere, though the table contents could use some tweaking. After all, does the last digit in a run of 16.068001 km really matter? Since Nike+ determines the attributes of our Run model, it might seem like we no control over the values passed to our template. Fortunately, that’s not the case. If we look at the SummaryView’s <code>render</code> method, we can see how the template gets its values.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">render: <span class="kw">function</span> () {
    <span class="kw">this</span>.<span class="ot">$el</span>.<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>(<span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">toJSON</span>()));
    <span class="kw">return</span> <span class="kw">this</span>;
}</code></pre></td></tr></table>
<p>The template values come from a JavaScript object that we’re creating directly from the model. Backbone.js provided the <code>toJSON</code> method that returns a JavaScript object corresponding to the model’s attributes. We can actually pass any JavaScript object to the template, even one we create ourselves within the <code>render</code> method. Let’s rewrite the that method to provide a more user-friendly summary view. We’ll take the model’s attributes one at a time.</p>
<p>First up is the date of the run. A date of “2013-04-09T10:54:33Z” isn’t very readable for average users, and it’s probably not even in their time zone. Working with dates and times is actually quite tricky, but the excellent <a href="http://momentjs.com">Moment.js library</a> can handle all of the complexity. Since we added that library to our app in an earlier section, we can take advantage of it now.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">render: <span class="kw">function</span> () {
    <span class="kw">var</span> run = {};
    <span class="ot">run</span>.<span class="fu">date</span> = <span class="fu">moment</span>(<span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">get</span>(<span class="st">&quot;startTime&quot;</span>)).<span class="fu">calendar</span>();</code></pre></td></tr></table>
<blockquote>
<p>In the interest of brevity, we’re cheating a little with the code above because it converts the UTC timestamp to the local time zone of the browser. It would probably be more correct to convert it to the time zone for the run, which Nike+ provides in the data.</p>
</blockquote>
<p>Next up is the run’s duration. It’s doubtful that we need to show the fractions of seconds that Nike+ includes, so let’s simply drop them from the attribute. (It would be more precise to round up or down, but assuming our users are Olympic athletes in training, a second here or there won’t matter. Besides, Nike+ seems to always record these sub-second durations as “.000” anyway.)</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">run</span>.<span class="fu">duration</span> = <span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">get</span>(<span class="st">&quot;metricSummary&quot;</span>).<span class="ot">duration</span>.<span class="fu">split</span>(<span class="st">&quot;.&quot;</span>)[<span class="dv">0</span>];</code></pre></td></tr></table>
<p>The distance property can also use some adjustment. In addition to rounding it to a reasonable number of decimal places, we can convert from km to Miles for our US users. A single statement takes care of both.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">run</span>.<span class="fu">distance</span> = <span class="ot">Math</span>.<span class="fu">round</span>(<span class="fl">62.1371</span>*<span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">get</span>(<span class="st">&quot;metricSummary&quot;</span>).<span class="fu">distance</span>)/<span class="dv">100</span> + <span class="st">&quot; Miles&quot;</span>;</code></pre></td></tr></table>
<p>The calories attribute is one value that’s fine as it is, so we’ll just copy it into our temporary object.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">run</span>.<span class="fu">calories</span> = <span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">get</span>(<span class="st">&quot;metricSummary&quot;</span>).<span class="fu">calories</span>;</code></pre></td></tr></table>
<p>Finally, if you’re an avid runner you might have noticed that there’s an important value missing from the Nike+ attributes, the average pace for the run. We have the data to calculate it, so let’s go ahead and add that as well.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> secs = <span class="fu">_</span>(<span class="ot">run</span>.<span class="ot">duration</span>.<span class="fu">split</span>(<span class="st">&quot;:&quot;</span>)).<span class="fu">reduce</span>(<span class="kw">function</span>(sum, num) {
    <span class="kw">return</span> sum*<span class="dv">60</span>+<span class="fu">parseInt</span>(num,<span class="dv">10</span>); }, <span class="dv">0</span>);
<span class="kw">var</span> pace = <span class="ot">moment</span>.<span class="fu">duration</span>(<span class="dv">1000</span>*secs/<span class="fu">parseFloat</span>(<span class="ot">run</span>.<span class="fu">distance</span>));
<span class="ot">run</span>.<span class="fu">pace</span> = <span class="ot">pace</span>.<span class="fu">minutes</span>() + <span class="st">&quot;:&quot;</span> + <span class="fu">_</span>(<span class="ot">pace</span>.<span class="fu">seconds</span>()).<span class="fu">pad</span>(<span class="dv">2</span>, <span class="st">&quot;0&quot;</span>);</code></pre></td></tr></table>
<p>Now we have a new object to pass to the template.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">this</span>.<span class="ot">$el</span>.<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>(run));</code></pre></td></tr></table>
<p>We’ll also need to modify both templates to match the new markup. Here’s the updated template for SummaryRows.</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="kw">&lt;td&gt;</span><span class="er">&lt;</span>%= date %&gt;<span class="kw">&lt;/td&gt;</span>
<span class="kw">&lt;td&gt;</span><span class="er">&lt;</span>%= duration %&gt;<span class="kw">&lt;/td&gt;</span>
<span class="kw">&lt;td&gt;</span><span class="er">&lt;</span>%= distance %&gt;<span class="kw">&lt;/td&gt;</span>
<span class="kw">&lt;td&gt;</span><span class="er">&lt;</span>%= calories %&gt;<span class="kw">&lt;/td&gt;</span>
<span class="kw">&lt;td&gt;</span><span class="er">&lt;</span>%= pace %&gt;<span class="kw">&lt;/td&gt;</span></code></pre></td></tr></table>
<p>And here’s the Summary template with the additional column for pace.</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="kw">&lt;thead&gt;</span>
    <span class="kw">&lt;tr&gt;&lt;th&gt;</span>Date<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Duration<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Distance<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Calories<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Pace<span class="kw">&lt;/th&gt;&lt;/tr&gt;</span>
<span class="kw">&lt;/thead&gt;</span>
<span class="kw">&lt;tbody&gt;&lt;/tbody&gt;</span></code></pre></td></tr></table>
<p>Now we have a much improved summary view for our users.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Date</th>
<th style="text-align: left;">Duration</th>
<th style="text-align: left;">Distance</th>
<th style="text-align: left;">Calories</th>
<th style="text-align: left;">Pace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">04/09/2013</td>
<td style="text-align: left;">0:22:39</td>
<td style="text-align: left;">2.33 Miles</td>
<td style="text-align: left;">240</td>
<td style="text-align: left;">9:43</td>
</tr>
<tr class="even">
<td style="text-align: left;">04/07/2013</td>
<td style="text-align: left;">0:44:59</td>
<td style="text-align: left;">5.08 Miles</td>
<td style="text-align: left;">569</td>
<td style="text-align: left;">8:51</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04/06/2013</td>
<td style="text-align: left;">1:28:59</td>
<td style="text-align: left;">9.98 Miles</td>
<td style="text-align: left;">1200</td>
<td style="text-align: left;">8:54</td>
</tr>
<tr class="even">
<td style="text-align: left;">04/04/2013</td>
<td style="text-align: left;">0:58:44</td>
<td style="text-align: left;">5.98 Miles</td>
<td style="text-align: left;">736</td>
<td style="text-align: left;">9:49</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04/02/2013</td>
<td style="text-align: left;">0:22:37</td>
<td style="text-align: left;">2.26 Miles</td>
<td style="text-align: left;">293</td>
<td style="text-align: left;">10:00</td>
</tr>
<tr class="even">
<td style="text-align: left;">03/31/2013</td>
<td style="text-align: left;">0:34:04</td>
<td style="text-align: left;">3.98 Miles</td>
<td style="text-align: left;">445</td>
<td style="text-align: left;">8:33</td>
</tr>
<tr class="odd">
<td style="text-align: left;">03/30/2013</td>
<td style="text-align: left;">1:29:31</td>
<td style="text-align: left;">9.98 Miles</td>
<td style="text-align: left;">1203</td>
<td style="text-align: left;">8:58</td>
</tr>
<tr class="even">
<td style="text-align: left;">03/28/2013</td>
<td style="text-align: left;">1:04:09</td>
<td style="text-align: left;">6.94 Miles</td>
<td style="text-align: left;">852</td>
<td style="text-align: left;">9:14</td>
</tr>
<tr class="odd">
<td style="text-align: left;">03/26/2013</td>
<td style="text-align: left;">0:39:33</td>
<td style="text-align: left;">4.54 Miles</td>
<td style="text-align: left;">514</td>
<td style="text-align: left;">8:42</td>
</tr>
<tr class="even">
<td style="text-align: left;">03/24/2013</td>
<td style="text-align: left;">0:33:49</td>
<td style="text-align: left;">3.91 Miles</td>
<td style="text-align: left;">455</td>
<td style="text-align: left;">8:38</td>
</tr>
</tbody>
</table>
<h2 id="views-for-visualizations">Views for Visualizations</h2>
<p>Now that we’ve seen how to use Backbone.js views to separate data from its presentation, we can consider how to use the same approach for data visualizations. When the presentation is simple HTML markup—as in the previous section’s table—it’s easy to use templates to view a model. Templates, however, aren’t sophisticated enough to handle data visualizations. For those we’ll need to modify our approach.</p>
<p>The data from the Nike+ service offers lots of opportunity for visualizations. Each run, for example, may include a record of the user’s heart rate, instantaneous pace, and cumulative distance, recorded every 10 seconds. Runs may also include the user’s GPS coordinates captured every second. That type of data suggests both charts and maps, and in this section we’ll add both to our application.</p>
<h3 id="step-1-define-the-additional-views">Step 1: Define the Additional Views</h3>
<p>As we did in the previous section, we’ll rely on Yeoman to create the scaffolding for our additional views. One view, we’ll call it <em>Details,</em> will act as the overall view for the details of an individual run. Within that view we’ll create three additional views each showing a different aspect of the run. We can think of these views in a hierarchy.</p>
<ul>
<li>Details: a detailed view of a single run</li>
<li>Properties: the full set of properties associated with the run</li>
<li>Chart: charts showing performance during the run</li>
<li>Map: a map of the run’s route</li>
</ul>
<p>To start the development of these views, we return to the command line and execute four Yeoman commands.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash">$ <span class="kw">yo</span> backbone:view details
$ <span class="kw">yo</span> backbone:view properties
$ <span class="kw">yo</span> backbone:view charts
$ <span class="kw">yo</span> backbone:view map</code></pre></td></tr></table>
<h3 id="step-2-implement-the-details-view">Step 2: Implement the Details View</h3>
<p>The Details view is really nothing more than a container for its three children, so its implementation is about as easy as it gets. We create a new view for each of the children, render the view, and add the resulting markup to the Details. Here is the complete code for this view.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Details</span> = <span class="ot">Backbone</span>.<span class="ot">View</span>.<span class="fu">extend</span>({
    <span class="dt">render</span>: <span class="kw">function</span> () {
        <span class="kw">this</span>.<span class="ot">$el</span>.<span class="fu">html</span>(<span class="st">&quot;&quot;</span>);
        <span class="kw">this</span>.<span class="ot">$el</span>.<span class="fu">append</span>(<span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Properties</span>({<span class="dt">model</span>: <span class="kw">this</span>.<span class="fu">model</span>}).<span class="fu">render</span>().<span class="fu">el</span>);
        <span class="kw">this</span>.<span class="ot">$el</span>.<span class="fu">append</span>(<span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Charts</span>({<span class="dt">model</span>: <span class="kw">this</span>.<span class="fu">model</span>}).<span class="fu">render</span>().<span class="fu">el</span>);
        <span class="kw">this</span>.<span class="ot">$el</span>.<span class="fu">append</span>(<span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Map</span>({<span class="dt">model</span>: <span class="kw">this</span>.<span class="fu">model</span>}).<span class="fu">render</span>().<span class="fu">el</span>);
        <span class="kw">return</span> <span class="kw">this</span>;
    }
});</code></pre></td></tr></table>
<p>The structure looks a little different from the previous views we’ve created because the Details view itself doesn’t actually depend on any of the properties of the Run model. (The child views, of course, depend greatly on those properties.) The Details view, therefore, doesn’t have to listen for changes to the model, so there’s nothing to do during initialization.</p>
<p>The <code>render</code> method itself first clears out any existing content from its element. This line makes it safe to call the <code>render</code> method multiple times. The next three statements create each of the child views. Notice that all of the child views have the same model, which is the model for the Details view as well. This capability is the power of the Model/View architecture; one data object—in our case a run—can be presented in many different ways. While the <code>render</code> method creates each of these child views, it also calls their <code>render</code> methods, and it appends the resulting content (their <code>el</code> properties) into its own <code>el</code>.</p>
<h3 id="step-3-implement-the-properties-view">Step 3: Implement the Properties View</h3>
<p>For the Properties view, we want to show all of the properties that Nike+ has associated with the run. Those properties are determined by the data returned by the Nike+ service; here’s an example.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">{
    <span class="st">&quot;activityId&quot;</span>: <span class="st">&quot;2126456911&quot;</span>,
    <span class="st">&quot;activityType&quot;</span>: <span class="st">&quot;RUN&quot;</span>,
    <span class="st">&quot;startTime&quot;</span>: <span class="st">&quot;2013-04-09T10:54:33Z&quot;</span>,
    <span class="st">&quot;activityTimeZone&quot;</span>: <span class="st">&quot;GMT-04:00&quot;</span>,
    <span class="st">&quot;status&quot;</span>: <span class="st">&quot;COMPLETE&quot;</span>,
    <span class="st">&quot;deviceType&quot;</span>: <span class="st">&quot;IPOD&quot;</span>,
    <span class="st">&quot;metricSummary&quot;</span>: {
        <span class="st">&quot;calories&quot;</span>: <span class="dv">240</span>,
        <span class="st">&quot;fuel&quot;</span>: <span class="dv">790</span>,
        <span class="st">&quot;distance&quot;</span>: <span class="fl">3.7524</span>,
        <span class="st">&quot;steps&quot;</span>: <span class="dv">0</span>,
        <span class="st">&quot;duration&quot;</span>: <span class="st">&quot;0:22:39.000&quot;</span>
    },
    <span class="st">&quot;tags&quot;</span>: [
        { <span class="st">&quot;tagType&quot;</span>: <span class="st">&quot;WEATHER&quot;</span>, <span class="st">&quot;tagValue&quot;</span>: <span class="st">&quot;SUNNY&quot;</span>     },
        { <span class="st">&quot;tagType&quot;</span>: <span class="st">&quot;NOTE&quot;</span>                             },
        { <span class="st">&quot;tagType&quot;</span>: <span class="st">&quot;TERRAIN&quot;</span>, <span class="st">&quot;tagValue&quot;</span>: <span class="st">&quot;TRAIL&quot;</span>     },
        { <span class="st">&quot;tagType&quot;</span>: <span class="st">&quot;SHOES&quot;</span>,   <span class="st">&quot;tagValue&quot;</span>: <span class="st">&quot;Neo Trail&quot;</span> },
        { <span class="st">&quot;tagType&quot;</span>: <span class="st">&quot;EMOTION&quot;</span>, <span class="st">&quot;tagValue&quot;</span>: <span class="st">&quot;GREAT&quot;</span>     }
    ],
    <span class="st">&quot;metrics&quot;</span>: [
        { <span class="st">&quot;intervalMetric&quot;</span>: <span class="dv">10</span>, <span class="st">&quot;intervalUnit&quot;</span>: <span class="st">&quot;SEC&quot;</span>, <span class="st">&quot;metricType&quot;</span>: <span class="st">&quot;SPEED&quot;</span>,     <span class="st">&quot;values&quot;</span>: [<span class="co">/* Data continues... */</span>] },
        { <span class="st">&quot;intervalMetric&quot;</span>: <span class="dv">10</span>, <span class="st">&quot;intervalUnit&quot;</span>: <span class="st">&quot;SEC&quot;</span>, <span class="st">&quot;metricType&quot;</span>: <span class="st">&quot;HEARTRATE&quot;</span>, <span class="st">&quot;values&quot;</span>: [<span class="co">/* Data continues... */</span>] },
        { <span class="st">&quot;intervalMetric&quot;</span>: <span class="dv">10</span>, <span class="st">&quot;intervalUnit&quot;</span>: <span class="st">&quot;SEC&quot;</span>, <span class="st">&quot;metricType&quot;</span>: <span class="st">&quot;DISTANCE&quot;</span>,  <span class="st">&quot;values&quot;</span>: [<span class="co">/* Data continues... */</span>] },
    ],
    <span class="st">&quot;gps&quot;</span>: {
        <span class="st">&quot;elevationLoss&quot;</span>: <span class="fl">114.400024</span>,
        <span class="st">&quot;elevationGain&quot;</span>: <span class="fl">109.00003</span>,
        <span class="st">&quot;elevationMax&quot;</span>: <span class="fl">296.2</span>,
        <span class="st">&quot;elevationMin&quot;</span>: <span class="dv">257</span>,
        <span class="st">&quot;intervalMetric&quot;</span>: <span class="dv">10</span>,
        <span class="st">&quot;intervalUnit&quot;</span>: <span class="st">&quot;SEC&quot;</span>,
        <span class="st">&quot;waypoints&quot;</span>: [<span class="co">/* Data continues... */</span>]
    }
}</code></pre></td></tr></table>
<p>That data can certainly benefit from a bit of cleanup to make it more user friendly. To do that we’ll take advantage of the Underscore.string library we added to the project before. We can make sure that library is available by “mixing it into” the main Underscore.js library. We’ll do that right at the start of the JavaScript file for the Properties view.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">/*global Running, Backbone, JST, _*/</span>

<span class="ot">_</span>.<span class="fu">mixin</span>(<span class="ot">_</span>.<span class="ot">str</span>.<span class="fu">exports</span>());

<span class="ot">Running</span>.<span class="fu">Views</span> = <span class="ot">Running</span>.<span class="fu">Views</span> || {};

<span class="co">// Code continues...</span></code></pre></td></tr></table>
<p>Notice that we’ve also added the global variable for Underscore.js (<code>_</code>) to the initial comment in the file.</p>
<p>The most straightforward way to present this information in HTML is with a description list (<code>&lt;dl&gt;</code>). Each property can be an individual item in the list, with a description term (<code>&lt;dt&gt;</code>) holding the property name and the description data (<code>&lt;dd&gt;</code>) its value. To implement this, we set the <code>tagName</code> property of the view to be <code>'dl'</code>, and we create a generic list item template. Here’s the start of our Properties view code.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Properties</span> = <span class="ot">Backbone</span>.<span class="ot">View</span>.<span class="fu">extend</span>({
    <span class="dt">template</span>: JST[<span class="st">&#39;app/scripts/templates/properties.ejs&#39;</span>],
    <span class="dt">tagName</span>: <span class="st">&#39;dl&#39;</span>,
    <span class="dt">initialize</span>: <span class="kw">function</span> () {
        <span class="kw">this</span>.<span class="fu">listenTo</span>(<span class="kw">this</span>.<span class="fu">model</span>, <span class="st">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
        <span class="kw">return</span> <span class="kw">this</span>;
    },
    <span class="dt">render</span>: <span class="kw">function</span> () {
        <span class="co">// more code goes here</span>
        <span class="kw">return</span> <span class="kw">this</span>;
    }
});</code></pre></td></tr></table>
<p>And here’s the simple template that the view will use.</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="kw">&lt;dt&gt;</span><span class="er">&lt;</span>%= key %&gt;<span class="kw">&lt;/dt&gt;</span>
<span class="kw">&lt;dd&gt;</span><span class="er">&lt;</span>%= value %&gt;<span class="kw">&lt;/dd&gt;</span></code></pre></td></tr></table>
<p>A quick glance at the Nike+ data shows that it contains nested objects. The <code>metricSummary</code> property of the main object is itself an object. That suggests that recursion might be a good strategy for processing the model. To implement recursion we’ll need a function (so it can call itself), so let’s add an <code>obj2Html</code> method to our view. That function should iterate through all the properties in the input object building the HTML markup as it does. The Underscore.js <code>reduce</code> function supports exactly that operation, so we’ll use that as the core of our method.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">obj2Html: <span class="kw">function</span>(obj) {
    <span class="kw">return</span> (
        <span class="fu">_</span>(obj).<span class="fu">reduce</span>(<span class="kw">function</span>(html, value, key) {

            <span class="co">// create the markup for the current key/value pair and add it to the html variable</span>

            <span class="kw">return</span> html;

        }, <span class="st">&quot;&quot;</span>, <span class="kw">this</span>)
    );
}</code></pre></td></tr></table>
<p>As we process each property, the first thing we can do is improve the key name. For example, we’d like to replace “startTime” with “Start Time”. That’s where Underscore.string comes in. Its <code>humanize</code> function turns camelCase into separate words, and its <code>titleize</code> function ensures each word begins with an uppercase letter. We’ll use chaining to perform both operations in one statement.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">key = <span class="ot">_</span>.<span class="fu">chain</span>(key).<span class="fu">humanize</span>().<span class="fu">titleize</span>().<span class="fu">value</span>();</code></pre></td></tr></table>
<p>Now we can consider the value. If it is an array, we’ll replace it with a string that shows the array length.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">if</span> (<span class="fu">_</span>(value).<span class="fu">isArray</span>()) {
    value = <span class="st">&quot;[&quot;</span> + <span class="ot">value</span>.<span class="fu">length</span> + <span class="st">&quot; items]&quot;</span>;
}</code></pre></td></tr></table>
<p>Next we check to see if the value is an object. If it is, then we’ll call the <code>obj2Html</code> method recursively.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">if</span> (<span class="fu">_</span>(value).<span class="fu">isObject</span>()) {
    html += <span class="kw">this</span>.<span class="fu">obj2Html</span>(value);</code></pre></td></tr></table>
<p>For other types, we convert the value to a string, format it a bit with Underscore.string, and make use of our template.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">} <span class="kw">else</span> {
    value = <span class="fu">_</span>(<span class="ot">value</span>.<span class="fu">toString</span>().<span class="fu">toLowerCase</span>()).<span class="fu">titleize</span>();
    html += <span class="kw">this</span>.<span class="fu">template</span>({ <span class="dt">key</span>: key, <span class="dt">value</span>: value });
}</code></pre></td></tr></table>
<p>There are a few other minor improvements we can make to the presentation which you can find in the book’s source code. The last piece of the View is implementing the <code>render</code> method. In that method, we use <code>toJSON</code> to get an object corresponding the Run model, and then we start the <code>obj2Html</code> recursion with that object.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">render: <span class="kw">function</span> () {
    <span class="kw">this</span>.<span class="ot">$el</span>.<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">obj2Html</span>(<span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">toJSON</span>()));
    <span class="kw">return</span> <span class="kw">this</span>;
}</code></pre></td></tr></table>
<p>The result is a complete picture of the properties of the run.</p>
<dl class="dl-horizontal">
<dt>
Activity
</dt>
<dd>
2126456911
</dd>
<dt>
Activity Type
</dt>
<dd>
Run
</dd>
<dt>
Start Time
</dt>
<dd>
2013-04-09t10:54:33z
</dd>
<dt>
Activity Time Zone
</dt>
<dd>
GMT-04:00
</dd>
<dt>
Status
</dt>
<dd>
Complete
</dd>
<dt>
Device Type
</dt>
<dd>
iPod
</dd>
<dt>
Calories
</dt>
<dd>
240
</dd>
<dt>
Fuel
</dt>
<dd>
790
</dd>
<dt>
Distance
</dt>
<dd>
3.7524
</dd>
<dt>
Steps
</dt>
<dd>
0
</dd>
<dt>
Duration
</dt>
<dd>
0:22:39.000
</dd>
<dt>
Weather
</dt>
<dd>
Sunny
</dd>
<dt>
Terrain
</dt>
<dd>
Trail
</dd>
<dt>
Shoes
</dt>
<dd>
Neo Trail
</dd>
<dt>
Emotion
</dt>
<dd>
Great
</dd>
<dt>
Speed Data
</dt>
<dd>
[136 Items]
</dd>
<dt>
Heartrate Data
</dt>
<dd>
[136 Items]
</dd>
<dt>
Distance Data
</dt>
<dd>
[136 Items]
</dd>
<dt>
Elevation Loss
</dt>
<dd>
114.400024
</dd>
<dt>
Elevation Gain
</dt>
<dd>
109.00003
</dd>
<dt>
Elevation Max
</dt>
<dd>
296.2
</dd>
<dt>
Elevation Min
</dt>
<dd>
257
</dd>
<dt>
Waypoints
</dt>
<dd>
[266 Items]
</dd>
</dl>
<h3 id="step-4-implement-the-map-view">Step 4: Implement the Map View</h3>
<p>To show users maps of their runs we rely on the Leaflet library from chapter 6. Using the library will require some small modifications to the normal Backbone.js view implementation, but, as we’ll see, those same modifications will come in handy for other views as well. Leaflet builds its maps in a containing element in the page (typically a <code>&lt;div&gt;</code>), and that containing element must have an <code>id</code> attribute so that Leaflet can find it. Backbone.js will take care of adding that <code>id</code> if we include an <code>id</code> property in the view. That’s easy enough.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">    <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Map</span> = <span class="ot">Backbone</span>.<span class="ot">View</span>.<span class="fu">extend</span>({
        <span class="dt">id</span>: <span class="st">&#39;map&#39;</span>,</code></pre></td></tr></table>
<p>With <code>&lt;div id='map'&gt;&lt;/div&gt;</code> available in the page’s markup, we can create a Leaflet map with the statement</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> map = <span class="ot">L</span>.<span class="fu">map</span>(<span class="kw">this</span>.<span class="fu">id</span>);</code></pre></td></tr></table>
<p>We might be tempted to do that directly in the view’s <code>render</code> method, but there’s a problem with that approach. Adding (and removing) elements in a web page requires a lot of computation by the browser. When JavaScript code does that frequently, the performance of the page can suffer significantly. To reduce this problem, Backbone.js tries to minimize the number of times it adds (or removes) elements, and one way to do that is to add many elements at once, rather than adding each element independently. It employs that approach when it implements a view’s <code>render</code> method. Before adding any elements to the page, it lets the view finish constructing its entire markup. Only then does it add that markup to the page.</p>
<p>Perhaps you’ve detected the problem. When <code>render</code> is called the first time, there won’t (yet) be a <code>&lt;div id='map'&gt;&lt;/div&gt;</code> anywhere in the page. If we call Leaflet, it won’t be able to find the container for its map, and it will generate an error. What we need to do is defer the part of <code>render</code> that draws the map until after Backbone.js has added the map container to the page.</p>
<p>Fortunately, Underscore.js has a utility function to do just that. It even has the name <code>defer</code>. Instead of drawing the map directly in the <code>render</code> method, we’ll create a separate method. Then, in the <code>render</code> method, we’ll defer execution of that new method. Here’s what the code to do that looks like.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">render: <span class="kw">function</span> () {
    <span class="ot">_</span>.<span class="fu">defer</span>(<span class="fu">_</span>(<span class="kw">function</span>(){ <span class="kw">this</span>.<span class="fu">drawMap</span>(); }).<span class="fu">bind</span>(<span class="kw">this</span>));
},
drawMap: <span class="kw">function</span> () {
    <span class="kw">var</span> map = <span class="ot">L</span>.<span class="fu">map</span>(<span class="kw">this</span>.<span class="fu">id</span>);
    <span class="co">// Code continues...</span>
}</code></pre></td></tr></table>
<p>As you can see, we’re actually using a couple of Underscore.js function in our <code>render</code> method. In addition to <code>defer</code>, we also take advantage of <code>bind</code>. That latter function ensures that the <code>this</code> value when <code>drawMap</code> is eventually called is the same as the <code>this</code> value within the view.</p>
<p>There’s one change we can make to further improve this implementation. Although there won’t be a <code>&lt;div id='map'&gt;&lt;/div&gt;</code> in the page when <code>render</code> is first called, that element will exist in subsequent calls to <code>render</code>. In those cases we don’t need to defer the execution of <code>drawMap</code>. That leads to the following code for our <code>render</code> method.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">render: <span class="kw">function</span> () {
    <span class="kw">if</span> (<span class="ot">document</span>.<span class="fu">getElementById</span>(<span class="kw">this</span>.<span class="fu">id</span>)) {
        <span class="kw">this</span>.<span class="fu">drawMap</span>();
    } <span class="kw">else</span> {
        <span class="ot">_</span>.<span class="fu">defer</span>(<span class="fu">_</span>(<span class="kw">function</span>(){ <span class="kw">this</span>.<span class="fu">drawMap</span>(); }).<span class="fu">bind</span>(<span class="kw">this</span>));
    }
    <span class="kw">return</span> <span class="kw">this</span>;
},</code></pre></td></tr></table>
<p>As long as we’re making optimizations, let’s also change the <code>initialize</code> method slightly. The default method that Yeoman creates is</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">initialize: <span class="kw">function</span> () {
    <span class="kw">this</span>.<span class="fu">listenTo</span>(<span class="kw">this</span>.<span class="fu">model</span>, <span class="st">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
},</code></pre></td></tr></table>
<p>For the Map view, however, we don’t really care if any property of the Run model changes. The only property the view needs is the <code>gps</code> property. We can, therefore, tell Backbone.js to only bother us if that specific property changes.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">initialize: <span class="kw">function</span> () {
    <span class="kw">this</span>.<span class="fu">listenTo</span>(<span class="kw">this</span>.<span class="fu">model</span>, <span class="st">&#39;change:gps&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
    <span class="kw">return</span> <span class="kw">this</span>;
},</code></pre></td></tr></table>
<blockquote>
<p>If you’re wondering “Why would the <code>gps</code> property of the Run model ever change?” be patient. We’ll get to that when we cover the quirks of the Nike+ REST API.</p>
</blockquote>
<p>With the preliminaries out of the way, we can implement the <code>drawMap</code> function. It turns out to be a very easy implementation. The steps are</p>
<ol type="1">
<li>Make sure the model has a <code>gps</code> property and there are waypoints associated with it.</li>
<li>If an old map exists, remove it.</li>
<li>Extract the GPS coordinates from the waypoints array.</li>
<li>Create a path using those coordinates.</li>
<li>Create a map that contains that path and draw the path on the map.</li>
<li>Add the map tiles.</li>
</ol>
<p>The resulting code is a straightforward implementation of those steps.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">drawMap: <span class="kw">function</span> () {
    <span class="kw">if</span> (<span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">get</span>(<span class="st">&quot;gps&quot;</span>) &amp;&amp; <span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">get</span>(<span class="st">&quot;gps&quot;</span>).<span class="fu">waypoints</span>) {
        <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">map</span>) {
            <span class="kw">this</span>.<span class="ot">map</span>.<span class="fu">remove</span>();
        }
        <span class="kw">var</span> points = <span class="fu">_</span>(<span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">get</span>(<span class="st">&quot;gps&quot;</span>).<span class="fu">waypoints</span>).<span class="fu">map</span>(<span class="kw">function</span>(pt) {
            <span class="kw">return</span> [<span class="ot">pt</span>.<span class="fu">latitude</span>, <span class="ot">pt</span>.<span class="fu">longitude</span>];
        });
        <span class="kw">var</span> path = <span class="kw">new</span> <span class="ot">L</span>.<span class="fu">Polyline</span>(points, {<span class="dt">color</span>: <span class="st">&#39;#1788cc&#39;</span>});
        <span class="kw">this</span>.<span class="fu">map</span> = <span class="ot">L</span>.<span class="fu">map</span>(<span class="kw">this</span>.<span class="fu">id</span>).<span class="fu">fitBounds</span>(<span class="ot">path</span>.<span class="fu">getBounds</span>()).<span class="fu">addLayer</span>(path);
        <span class="kw">var</span> tiles = <span class="ot">L</span>.<span class="fu">tileLayer</span>(
            <span class="st">&#39;http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}&#39;</span>,
            {
                <span class="dt">attribution</span>: <span class="st">&#39;Tiles &amp;copy; Esri &amp;mdash; Esri, DeLorme, NAVTEQ&#39;</span>,
                <span class="dt">maxZoom</span>: <span class="dv">16</span>
            }
        );
        <span class="kw">this</span>.<span class="ot">map</span>.<span class="fu">addLayer</span>(tiles);
    }
}</code></pre></td></tr></table>
<p>As you can see from the code, we’re storing a reference to the Leaflet map object as a property of the view. From within the view, we can access that object using <code>this.map</code>.</p>
<p>The result is a nice map of the run’s route in figure <span class="nextfigure"/>.</p>
<figure style="margin-left:0;margin-right:0">
<div id="map" style="width:840px;height:600px;">

</div>
<figcaption>
A map view shows the route of a run.
</figcaption>
</figure>
<h3 id="step-5-implement-the-charts-view">Step 5: Implement the Charts View</h3>
<p>The last remaining view that we need to implement is the Charts view. This view is the most complex of any, but nearly all of the code identical to the <em>Tracking Values</em> example in chapter 2. There’s no need to repeat that material here, but the source code for the book includes the complete implementation. If you’re looking in detail at that implementation, here a few points to note.</p>
<ul>
<li>Just as Leaflet and the map container, Flot expects a container for its chart to be present in the web page. We can use the same <code>defer</code> trick to prevent Flot errors.</li>
<li>Nike+ returns at least four types of charts as metrics: distance, heart rate, speed, and GPS signal strength. We really only care about the first two. Speed isn’t present in all activities, but distance is. Because we want to graph pace, we can only count on distance to derive it. And as long as we’re getting pace from the distance graph, the speed metrics are redundant. GPS signal strength doesn’t seem useful enough to bother.</li>
<li>If GPS waypoint data is available, we can also graph elevation, but that data is in a separate attribute of the model (not the metrics attribute).</li>
<li>At least as of this writing, there’s a bit of a bug in Nike’s response for GPS data. It claims that the measurements are on the same time scale as the other metrics (every 10 seconds), but, in fact, the GPS measurements are reported on different intervals. To work around this bug, we ignore the reported interval, and calculate one ourselves. Also, we want to normalize the elevation graph to the same time scale as all the others. Doing that will give us the additional benefit of averaging the GPS elevation data; averaging is useful here because GPS elevation measurements aren’t generally very accurate.</li>
</ul>
<p>You can see the interactive result in figure <span class="nextfigure"/>.</p>
<style>
.charts-wrapper {
    position: relative;
}
.charts-marker {
    position: absolute;
    z-index: 1;
    display: none;
    width: 1px;
    border-left: 1px #000 solid;
}
.charts-graphs {
    float: left;
}
.charts-graphs .figure {
    padding: 0;
    margin: 0;
    width: 600px;
    height: 100px;
}
.charts-graphs .flot-tick-label {
    display:none;
}
.charts-graphs .x-axis {
    width: 600px;
    height: 15px;
}
.charts-graphs .x-axis .flot-tick-label {
    display: block;
}
.charts-legend {
    float: left;
}
.charts-legend p {
    margin: 0 0 0 15px;
    padding: 2px 0 2px 0;
    font-size: 15px;
    line-height: 15px;
}
.charts-legend p:first-child {
    padding-top: 14px;
}
.charts-legend p:last-child {
    padding-bottom: 14px;
}        
</style>
<figure style="margin-left:0;margin-right:0">
<div class="charts-wrapper">
<pre><code>&lt;div class=&quot;charts-marker&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;charts-graphs&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;charts-legend&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;clearfix&quot;&gt;&lt;/div&gt;</code></pre>
</div>
<figcaption>
An alternative view shows charts of the run.
</figcaption>
</figure>
<script>
contentLoaded.done(function() {



var run = {
  "activityId": "2126456911",
  "activityType": "RUN",
  "startTime": "2013-04-09T10:54:33Z",
  "activityTimeZone": "GMT-04:00",
  "status": "COMPLETE",
  "deviceType": "IPOD",
  "metricSummary": {
    "calories": 240,
    "fuel": 790,
    "distance": 3.7524,
    "steps": 0,
    "duration": "0:22:39.000"
  },
  "tags": [
    {
      "tagType": "WEATHER",
      "tagValue": "SUNNY"
    },
    {
      "tagType": "NOTE"
    },
    {
      "tagType": "TERRAIN",
      "tagValue": "TRAIL"
    },
    {
      "tagType": "SHOES",
      "tagValue": "Neo Trail"
    },
    {
      "tagType": "EMOTION",
      "tagValue": "GREAT"
    }
  ],
  "metrics": [
    {
      "intervalMetric": 10,
      "intervalUnit": "SEC",
      "metricType": "SPEED",
      "values": [
        "0.0", "4.9135", "3.2307", "5.0095", "6.0155", "6.5154", "6.7831", "7.1405", "7.5132", "7.8049",
        "7.7402", "7.9067", "8.0318", "8.2706", "8.3555", "8.386", "8.4463", "8.4236", "8.4649", "8.4926",
        "8.6085", "8.6471", "9.0973", "9.2853", "9.2844", "9.3911", "9.3469", "9.3066", "9.304", "9.2558",
        "9.3002", "9.5552", "9.478", "9.3987", "9.2454", "9.216", "9.1343", "9.1113", "9.1629", "9.2077",
        "9.1606", "9.0644", "9.1917", "9.0194", "9.1034", "8.947", "9.0625", "9.0759", "8.9977", "8.9849",
        "9.0857", "8.9276", "8.8995", "8.9162", "9.0587", "9.0453", "9.0598", "9.0965", "9.1834", "9.1012",
        "8.9835", "9.0078", "9.0594", "9.2988", "9.3044", "9.5607", "9.6065", "9.6938", "9.8038", "9.8606",
        "9.7489", "9.8001", "9.8019", "9.8791", "9.8576", "9.9681", "10.1237", "10.0901", "9.9859", "9.9119",
        "9.9398", "10.013", "10.0642", "9.9803", "9.9153", "9.9509", "9.9189", "9.8162", "9.7896", "9.779",
        "9.9002", "9.8719", "9.8701", "9.9112", "10.0053", "10.0311", "10.0641", "10.024", "10.0852",
        "10.0374", "10.0784", "10.1319", "10.0765", "10.015", "9.9827", "9.7291", "9.5821", "9.7238",
        "9.6546", "9.495", "9.3582", "9.3695", "9.4641", "9.4965", "9.4442", "9.3592", "9.4442", "9.6883",
        "9.8628", "9.8331", "13.1376", "10.123", "9.9875", "10.0217", "10.0433", "10.1553", "10.2953",
        "10.1597", "10.3634", "10.7035", "10.8371", "11.0624", "11.044", "11.2021", "11.1301", "11.2593"
      ]
    },
    {
      "intervalMetric": 10,
      "intervalUnit": "SEC",
      "metricType": "HEARTRATE",
      "values": [
        "0", "45", "51", "57", "77", "90", "105", "108", "110", "111", "113", "116", "118", "118", "116",
        "117", "113", "112", "111", "112", "110", "109", "110", "113", "117", "116", "114", "117", "117",
        "114", "111", "109", "116", "112", "113", "118", "122", "127", "132", "131", "130", "129", "127",
        "125", "122", "123", "124", "125", "128", "131", "131", "127", "124", "121", "120", "125", "128",
        "129", "129", "128", "125", "121", "122", "124", "125", "124", "121", "120", "120", "124", "129",
        "130", "129", "129", "131", "131", "132", "133", "131", "132", "134", "134", "132", "132", "129",
        "128", "126", "129", "131", "134", "134", "132", "131", "129", "127", "128", "128", "129", "133",
        "136", "138", "140", "141", "140", "138", "137", "137", "138", "138", "137", "138", "140", "139",
        "138", "136", "137", "136", "135", "134", "135", "137", "141", "144", "144", "144", "143", "140",
        "137", "138", "138", "136", "137", "135", "132", "133", "136"
      ]
    },
    {
      "intervalMetric": 10,
      "intervalUnit": "SEC",
      "metricType": "DISTANCE",
      "values": [
        "0.0", "0.0124", "0.0178", "0.0412", "0.0667", "0.0906", "0.1131", "0.1389", "0.1671", "0.1951",
        "0.215", "0.2416", "0.2677", "0.2986", "0.3249", "0.3494", "0.3754", "0.3978", "0.4232", "0.4482",
        "0.4782", "0.5061", "0.5287", "0.5567", "0.5829", "0.612", "0.6332", "0.6558", "0.6817", "0.7093",
        "0.7358", "0.769", "0.7952", "0.8194", "0.8389", "0.8615", "0.8834", "0.9051", "0.9323", "0.9594",
        "0.9859", "1.0097", "1.0376", "1.059", "1.0877", "1.1076", "1.1373", "1.1615", "1.1816", "1.2072",
        "1.239", "1.2642", "1.2904", "1.3147", "1.3427", "1.3636", "1.3896", "1.4117", "1.4419", "1.4647",
        "1.4868", "1.5093", "1.5405", "1.5747", "1.6049", "1.6408", "1.6702", "1.7003", "1.727", "1.7555",
        "1.7782", "1.809", "1.8367", "1.8647", "1.8916", "1.9217", "1.9486", "1.9722", "1.996", "2.0165",
        "2.0423", "2.0666", "2.0972", "2.127", "2.1538", "2.1899", "2.2217", "2.2457", "2.2705", "2.2992",
        "2.3293", "2.3568", "2.3854", "2.4149", "2.4477", "2.48", "2.506", "2.5292", "2.5563", "2.5815",
        "2.603", "2.6304", "2.6559", "2.6828", "2.709", "2.7297", "2.7537", "2.7859", "2.8057", "2.8264",
        "2.8489", "2.8764", "2.9104", "2.9426", "2.9719", "2.9994", "3.0302", "3.0689", "3.1037", "3.1301",
        "3.2963", "3.2963", "3.2963", "3.2963", "3.2963", "3.2963", "3.3249", "3.3533", "3.3861", "3.421",
        "3.4559", "3.4888", "3.5238", "3.5626", "3.5933", "3.6246"
      ]
    }
  ],
  "gps": {
    "elevationLoss": 114.400024,
    "elevationGain": 109.00003,
    "elevationMax": 296.2,
    "elevationMin": 257,
    "intervalMetric": 10,
    "intervalUnit": "SEC",
    "waypoints": [
      { "latitude": 34.063286, "longitude": -84.407074, "elevation": 291 },
      { "latitude": 34.063293, "longitude": -84.407074, "elevation": 291 },
      { "latitude": 34.063175, "longitude": -84.40712, "elevation": 290.6 },
      { "latitude": 34.06317, "longitude": -84.40713, "elevation": 290.6 },
      { "latitude": 34.063168, "longitude": -84.407135, "elevation": 290.6 },
      { "latitude": 34.063164, "longitude": -84.407135, "elevation": 290.6 },
      { "latitude": 34.06315, "longitude": -84.40715, "elevation": 290.6 },
      { "latitude": 34.06307, "longitude": -84.4073, "elevation": 290.2 },
      { "latitude": 34.063023, "longitude": -84.40747, "elevation": 289.6 },
      { "latitude": 34.063023, "longitude": -84.407555, "elevation": 289.6 },
      { "latitude": 34.063034, "longitude": -84.40772, "elevation": 290.6 },
      { "latitude": 34.063026, "longitude": -84.40777, "elevation": 291.2 },
      { "latitude": 34.0629, "longitude": -84.407906, "elevation": 292.6 },
      { "latitude": 34.062885, "longitude": -84.40799, "elevation": 293.6 },
      { "latitude": 34.06279, "longitude": -84.40813, "elevation": 295 },
      { "latitude": 34.062653, "longitude": -84.40824, "elevation": 295 },
      { "latitude": 34.062572, "longitude": -84.40838, "elevation": 294.6 },
      { "latitude": 34.06245, "longitude": -84.40853, "elevation": 293.6 },
      { "latitude": 34.062374, "longitude": -84.408646, "elevation": 293 },
      { "latitude": 34.062366, "longitude": -84.40867, "elevation": 293.2 },
      { "latitude": 34.062424, "longitude": -84.40882, "elevation": 293.6 },
      { "latitude": 34.06254, "longitude": -84.40887, "elevation": 295.2 },
      { "latitude": 34.06261, "longitude": -84.40895, "elevation": 296.2 },
      { "latitude": 34.06272, "longitude": -84.40913, "elevation": 296.2 },
      { "latitude": 34.062706, "longitude": -84.40932, "elevation": 295.2 },
      { "latitude": 34.062622, "longitude": -84.40942, "elevation": 293.2 },
      { "latitude": 34.062485, "longitude": -84.409515, "elevation": 292.6 },
      { "latitude": 34.06234, "longitude": -84.40957, "elevation": 292.6 },
      { "latitude": 34.06222, "longitude": -84.4096, "elevation": 293.2 },
      { "latitude": 34.06213, "longitude": -84.4096, "elevation": 293.2 },
      { "latitude": 34.062096, "longitude": -84.4097, "elevation": 292.2 },
      { "latitude": 34.06214, "longitude": -84.40987, "elevation": 290.2 },
      { "latitude": 34.062244, "longitude": -84.40987, "elevation": 289.2 },
      { "latitude": 34.062393, "longitude": -84.4098, "elevation": 288.6 },
      { "latitude": 34.062523, "longitude": -84.40973, "elevation": 288.6 },
      { "latitude": 34.06267, "longitude": -84.40968, "elevation": 288 },
      { "latitude": 34.06271, "longitude": -84.409676, "elevation": 287.6 },
      { "latitude": 34.062885, "longitude": -84.409615, "elevation": 287.6 },
      { "latitude": 34.063004, "longitude": -84.40946, "elevation": 287 },
      { "latitude": 34.06301, "longitude": -84.40945, "elevation": 287 },
      { "latitude": 34.06316, "longitude": -84.40958, "elevation": 286.6 },
      { "latitude": 34.06327, "longitude": -84.40965, "elevation": 285.6 },
      { "latitude": 34.06341, "longitude": -84.409645, "elevation": 286.2 },
      { "latitude": 34.063606, "longitude": -84.40965, "elevation": 285.6 },
      { "latitude": 34.06372, "longitude": -84.4096, "elevation": 286.2 },
      { "latitude": 34.06389, "longitude": -84.40956, "elevation": 284 },
      { "latitude": 34.063988, "longitude": -84.40947, "elevation": 283.6 },
      { "latitude": 34.064148, "longitude": -84.40945, "elevation": 283.2 },
      { "latitude": 34.064224, "longitude": -84.409424, "elevation": 283.2 },
      { "latitude": 34.064262, "longitude": -84.40932, "elevation": 284 },
      { "latitude": 34.06428, "longitude": -84.40917, "elevation": 284.2 },
      { "latitude": 34.0644, "longitude": -84.40919, "elevation": 282.6 },
      { "latitude": 34.06444, "longitude": -84.409225, "elevation": 282 },
      { "latitude": 34.064552, "longitude": -84.409355, "elevation": 280.6 },
      { "latitude": 34.06458, "longitude": -84.40936, "elevation": 280 },
      { "latitude": 34.064762, "longitude": -84.40937, "elevation": 276.6 },
      { "latitude": 34.0648, "longitude": -84.40937, "elevation": 276.2 },
      { "latitude": 34.06494, "longitude": -84.40933, "elevation": 275 },
      { "latitude": 34.0651, "longitude": -84.40931, "elevation": 272.6 },
      { "latitude": 34.065216, "longitude": -84.409325, "elevation": 271 },
      { "latitude": 34.065407, "longitude": -84.40941, "elevation": 268.6 },
      { "latitude": 34.06547, "longitude": -84.409454, "elevation": 268.2 },
      { "latitude": 34.06553, "longitude": -84.40939, "elevation": 265.6 },
      { "latitude": 34.065502, "longitude": -84.40928, "elevation": 265 },
      { "latitude": 34.065475, "longitude": -84.40925, "elevation": 264.6 },
      { "latitude": 34.065437, "longitude": -84.409195, "elevation": 265 },
      { "latitude": 34.06536, "longitude": -84.40914, "elevation": 266.6 },
      { "latitude": 34.065334, "longitude": -84.409065, "elevation": 266.6 },
      { "latitude": 34.065346, "longitude": -84.40895, "elevation": 266.2 },
      { "latitude": 34.065422, "longitude": -84.40893, "elevation": 266.2 },
      { "latitude": 34.06557, "longitude": -84.409004, "elevation": 267 },
      { "latitude": 34.06567, "longitude": -84.40905, "elevation": 269 },
      { "latitude": 34.065807, "longitude": -84.409065, "elevation": 271.6 },
      { "latitude": 34.06593, "longitude": -84.40897, "elevation": 273.6 },
      { "latitude": 34.066074, "longitude": -84.40889, "elevation": 274.2 },
      { "latitude": 34.066113, "longitude": -84.408844, "elevation": 274 },
      { "latitude": 34.06611, "longitude": -84.408646, "elevation": 274.6 },
      { "latitude": 34.066082, "longitude": -84.408485, "elevation": 275.2 },
      { "latitude": 34.066097, "longitude": -84.408424, "elevation": 274.6 },
      { "latitude": 34.066162, "longitude": -84.408325, "elevation": 274 },
      { "latitude": 34.066246, "longitude": -84.40832, "elevation": 274.2 },
      { "latitude": 34.066372, "longitude": -84.40831, "elevation": 274.2 },
      { "latitude": 34.06654, "longitude": -84.40824, "elevation": 273.2 },
      { "latitude": 34.066563, "longitude": -84.40824, "elevation": 273.2 },
      { "latitude": 34.066696, "longitude": -84.4082, "elevation": 273.2 },
      { "latitude": 34.066727, "longitude": -84.40809, "elevation": 272.2 },
      { "latitude": 34.0667, "longitude": -84.40791, "elevation": 270.6 },
      { "latitude": 34.06669, "longitude": -84.40786, "elevation": 270.6 },
      { "latitude": 34.06668, "longitude": -84.40767, "elevation": 271.2 },
      { "latitude": 34.066708, "longitude": -84.407684, "elevation": 272 },
      { "latitude": 34.066765, "longitude": -84.40776, "elevation": 271 },
      { "latitude": 34.066925, "longitude": -84.40789, "elevation": 271.2 },
      { "latitude": 34.067043, "longitude": -84.40797, "elevation": 272.6 },
      { "latitude": 34.06721, "longitude": -84.40798, "elevation": 274.2 },
      { "latitude": 34.06723, "longitude": -84.40798, "elevation": 274.6 },
      { "latitude": 34.06733, "longitude": -84.40796, "elevation": 276.6 },
      { "latitude": 34.0674, "longitude": -84.40794, "elevation": 277.2 },
      { "latitude": 34.06748, "longitude": -84.40786, "elevation": 277.2 },
      { "latitude": 34.067574, "longitude": -84.40772, "elevation": 275.2 },
      { "latitude": 34.06758, "longitude": -84.407455, "elevation": 274.2 },
      { "latitude": 34.067623, "longitude": -84.407326, "elevation": 273.2 },
      { "latitude": 34.06767, "longitude": -84.40721, "elevation": 272.2 },
      { "latitude": 34.067745, "longitude": -84.407265, "elevation": 271.2 },
      { "latitude": 34.0678, "longitude": -84.407326, "elevation": 270.2 },
      { "latitude": 34.067814, "longitude": -84.40725, "elevation": 268.2 },
      { "latitude": 34.06781, "longitude": -84.40722, "elevation": 267.6 },
      { "latitude": 34.067734, "longitude": -84.40705, "elevation": 266.2 },
      { "latitude": 34.067715, "longitude": -84.40702, "elevation": 266.2 },
      { "latitude": 34.06771, "longitude": -84.40686, "elevation": 265 },
      { "latitude": 34.06773, "longitude": -84.406784, "elevation": 265.6 },
      { "latitude": 34.067814, "longitude": -84.40677, "elevation": 267.6 },
      { "latitude": 34.067944, "longitude": -84.406815, "elevation": 269.2 },
      { "latitude": 34.067963, "longitude": -84.40684, "elevation": 269.6 },
      { "latitude": 34.068142, "longitude": -84.40682, "elevation": 269.2 },
      { "latitude": 34.068264, "longitude": -84.406784, "elevation": 268.2 },
      { "latitude": 34.068367, "longitude": -84.40677, "elevation": 268.2 },
      { "latitude": 34.068485, "longitude": -84.406654, "elevation": 269 },
      { "latitude": 34.068584, "longitude": -84.40652, "elevation": 268 },
      { "latitude": 34.068573, "longitude": -84.406334, "elevation": 268.6 },
      { "latitude": 34.068577, "longitude": -84.4063, "elevation": 268.2 },
      { "latitude": 34.06852, "longitude": -84.40625, "elevation": 267.6 },
      { "latitude": 34.06859, "longitude": -84.406204, "elevation": 265.6 },
      { "latitude": 34.068615, "longitude": -84.40621, "elevation": 265.6 },
      { "latitude": 34.068752, "longitude": -84.40619, "elevation": 264.2 },
      { "latitude": 34.068844, "longitude": -84.40602, "elevation": 264.2 },
      { "latitude": 34.06884, "longitude": -84.405754, "elevation": 264.2 },
      { "latitude": 34.06882, "longitude": -84.405624, "elevation": 265.2 },
      { "latitude": 34.068825, "longitude": -84.40553, "elevation": 266 },
      { "latitude": 34.068893, "longitude": -84.40535, "elevation": 266.6 },
      { "latitude": 34.068928, "longitude": -84.405266, "elevation": 265 },
      { "latitude": 34.068947, "longitude": -84.40511, "elevation": 263 },
      { "latitude": 34.068947, "longitude": -84.404915, "elevation": 260.6 },
      { "latitude": 34.06895, "longitude": -84.40469, "elevation": 259.6 },
      { "latitude": 34.06887, "longitude": -84.40456, "elevation": 257.2 },
      { "latitude": 34.068737, "longitude": -84.40447, "elevation": 257.2 },
      { "latitude": 34.068577, "longitude": -84.4044, "elevation": 257.6 },
      { "latitude": 34.068417, "longitude": -84.4044, "elevation": 257 },
      { "latitude": 34.06826, "longitude": -84.40444, "elevation": 257.6 },
      { "latitude": 34.06808, "longitude": -84.404465, "elevation": 258.6 },
      { "latitude": 34.067986, "longitude": -84.40453, "elevation": 260.2 },
      { "latitude": 34.067886, "longitude": -84.404655, "elevation": 261.6 },
      { "latitude": 34.067753, "longitude": -84.40475, "elevation": 262 },
      { "latitude": 34.067608, "longitude": -84.4048, "elevation": 261.2 },
      { "latitude": 34.067516, "longitude": -84.40487, "elevation": 261.6 },
      { "latitude": 34.067482, "longitude": -84.4049, "elevation": 262 },
      { "latitude": 34.067352, "longitude": -84.40503, "elevation": 263 },
      { "latitude": 34.06724, "longitude": -84.40516, "elevation": 263.6 },
      { "latitude": 34.06712, "longitude": -84.40526, "elevation": 264.6 },
      { "latitude": 34.067028, "longitude": -84.40536, "elevation": 265.6 },
      { "latitude": 34.06687, "longitude": -84.40546, "elevation": 265.2 },
      { "latitude": 34.066772, "longitude": -84.40552, "elevation": 265.6 },
      { "latitude": 34.066616, "longitude": -84.40555, "elevation": 267 },
      { "latitude": 34.06651, "longitude": -84.40559, "elevation": 268.2 },
      { "latitude": 34.06637, "longitude": -84.40558, "elevation": 266.2 },
      { "latitude": 34.066257, "longitude": -84.405495, "elevation": 263 },
      { "latitude": 34.06617, "longitude": -84.40539, "elevation": 263.2 },
      { "latitude": 34.066135, "longitude": -84.40533, "elevation": 264.2 },
      { "latitude": 34.066143, "longitude": -84.40519, "elevation": 267 },
      { "latitude": 34.066257, "longitude": -84.40513, "elevation": 267.2 },
      { "latitude": 34.06637, "longitude": -84.40503, "elevation": 268.2 },
      { "latitude": 34.066475, "longitude": -84.40493, "elevation": 268.6 },
      { "latitude": 34.06661, "longitude": -84.40487, "elevation": 267.6 },
      { "latitude": 34.06672, "longitude": -84.40483, "elevation": 267 },
      { "latitude": 34.06692, "longitude": -84.40466, "elevation": 265.2 },
      { "latitude": 34.067013, "longitude": -84.40457, "elevation": 264.2 },
      { "latitude": 34.067135, "longitude": -84.40445, "elevation": 264.2 },
      { "latitude": 34.06725, "longitude": -84.40431, "elevation": 263.6 },
      { "latitude": 34.06734, "longitude": -84.40411, "elevation": 263.2 },
      { "latitude": 34.067417, "longitude": -84.40393, "elevation": 262 },
      { "latitude": 34.067368, "longitude": -84.40378, "elevation": 262.6 },
      { "latitude": 34.06729, "longitude": -84.40368, "elevation": 264 },
      { "latitude": 34.06723, "longitude": -84.40361, "elevation": 264.6 },
      { "latitude": 34.06715, "longitude": -84.403534, "elevation": 266 },
      { "latitude": 34.067116, "longitude": -84.4035, "elevation": 266.6 },
      { "latitude": 34.066998, "longitude": -84.40337, "elevation": 266.6 },
      { "latitude": 34.06688, "longitude": -84.40326, "elevation": 267.6 },
      { "latitude": 34.06671, "longitude": -84.403175, "elevation": 268.2 },
      { "latitude": 34.06653, "longitude": -84.40312, "elevation": 267.6 },
      { "latitude": 34.066452, "longitude": -84.40306, "elevation": 267.6 },
      { "latitude": 34.06637, "longitude": -84.40293, "elevation": 267.2 },
      { "latitude": 34.066265, "longitude": -84.4028, "elevation": 266.6 },
      { "latitude": 34.066086, "longitude": -84.4027, "elevation": 267 },
      { "latitude": 34.066044, "longitude": -84.402626, "elevation": 266.6 },
      { "latitude": 34.065956, "longitude": -84.40245, "elevation": 266 },
      { "latitude": 34.065933, "longitude": -84.402374, "elevation": 265.2 },
      { "latitude": 34.065823, "longitude": -84.402214, "elevation": 263 },
      { "latitude": 34.065647, "longitude": -84.40205, "elevation": 262.6 },
      { "latitude": 34.065533, "longitude": -84.40196, "elevation": 263 },
      { "latitude": 34.065403, "longitude": -84.401794, "elevation": 264.2 },
      { "latitude": 34.06527, "longitude": -84.401764, "elevation": 266.6 },
      { "latitude": 34.06514, "longitude": -84.40169, "elevation": 268.2 },
      { "latitude": 34.065018, "longitude": -84.40153, "elevation": 270.6 },
      { "latitude": 34.064896, "longitude": -84.401436, "elevation": 272.2 },
      { "latitude": 34.06486, "longitude": -84.40141, "elevation": 273 },
      { "latitude": 34.064804, "longitude": -84.40137, "elevation": 274.2 },
      { "latitude": 34.0647, "longitude": -84.40125, "elevation": 276.2 },
      { "latitude": 34.064564, "longitude": -84.40118, "elevation": 277.6 },
      { "latitude": 34.064484, "longitude": -84.40119, "elevation": 278.6 },
      { "latitude": 34.06429, "longitude": -84.40119, "elevation": 278.6 },
      { "latitude": 34.064243, "longitude": -84.40119, "elevation": 279 },
      { "latitude": 34.064102, "longitude": -84.40116, "elevation": 277.6 },
      { "latitude": 34.06389, "longitude": -84.40117, "elevation": 277.2 },
      { "latitude": 34.063778, "longitude": -84.40116, "elevation": 278.2 },
      { "latitude": 34.063633, "longitude": -84.40111, "elevation": 279.2 },
      { "latitude": 34.06357, "longitude": -84.40111, "elevation": 279 },
      { "latitude": 34.06347, "longitude": -84.4011, "elevation": 281 },
      { "latitude": 34.063232, "longitude": -84.4011, "elevation": 281.6 },
      { "latitude": 34.06321, "longitude": -84.40112, "elevation": 281.6 },
      { "latitude": 34.063168, "longitude": -84.40116, "elevation": 281.6 },
      { "latitude": 34.063248, "longitude": -84.40121, "elevation": 282.6 },
      { "latitude": 34.063347, "longitude": -84.40126, "elevation": 281.2 },
      { "latitude": 34.06337, "longitude": -84.40124, "elevation": 281.2 },
      { "latitude": 34.063534, "longitude": -84.40126, "elevation": 281.6 },
      { "latitude": 34.06366, "longitude": -84.401306, "elevation": 284 },
      { "latitude": 34.063744, "longitude": -84.40133, "elevation": 284 },
      { "latitude": 34.06391, "longitude": -84.40136, "elevation": 283.6 },
      { "latitude": 34.06409, "longitude": -84.40141, "elevation": 284.6 },
      { "latitude": 34.064243, "longitude": -84.401436, "elevation": 285 },
      { "latitude": 34.064396, "longitude": -84.40148, "elevation": 285 },
      { "latitude": 34.064514, "longitude": -84.40156, "elevation": 283 },
      { "latitude": 34.064644, "longitude": -84.40174, "elevation": 283.2 },
      { "latitude": 34.064697, "longitude": -84.40192, "elevation": 283.6 },
      { "latitude": 34.064705, "longitude": -84.40195, "elevation": 283.2 },
      { "latitude": 34.06479, "longitude": -84.4021, "elevation": 284.6 },
      { "latitude": 34.064842, "longitude": -84.40217, "elevation": 284.2 },
      { "latitude": 34.064957, "longitude": -84.40238, "elevation": 284 },
      { "latitude": 34.064953, "longitude": -84.40265, "elevation": 284.2 },
      { "latitude": 34.064915, "longitude": -84.402855, "elevation": 284 },
      { "latitude": 34.064945, "longitude": -84.4031, "elevation": 282.6 },
      { "latitude": 34.064957, "longitude": -84.40326, "elevation": 282.2 },
      { "latitude": 34.064896, "longitude": -84.40339, "elevation": 284.6 },
      { "latitude": 34.064884, "longitude": -84.403435, "elevation": 285.6 },
      { "latitude": 34.06481, "longitude": -84.40353, "elevation": 287 },
      { "latitude": 34.06477, "longitude": -84.40355, "elevation": 287.6 },
      { "latitude": 34.064606, "longitude": -84.4036, "elevation": 289 },
      { "latitude": 34.06446, "longitude": -84.40368, "elevation": 289.6 },
      { "latitude": 34.06432, "longitude": -84.40376, "elevation": 291.2 },
      { "latitude": 34.06423, "longitude": -84.40381, "elevation": 292.2 },
      { "latitude": 34.06405, "longitude": -84.40379, "elevation": 292.2 },
      { "latitude": 34.063885, "longitude": -84.40383, "elevation": 293.2 },
      { "latitude": 34.06372, "longitude": -84.403854, "elevation": 293 },
      { "latitude": 34.063667, "longitude": -84.40396, "elevation": 294 },
      { "latitude": 34.063793, "longitude": -84.40403, "elevation": 292.6 },
      { "latitude": 34.063873, "longitude": -84.404045, "elevation": 292.2 },
      { "latitude": 34.06409, "longitude": -84.404144, "elevation": 291 },
      { "latitude": 34.06417, "longitude": -84.40425, "elevation": 290.2 },
      { "latitude": 34.064198, "longitude": -84.40441, "elevation": 290.6 },
      { "latitude": 34.06411, "longitude": -84.40461, "elevation": 292.2 },
      { "latitude": 34.064102, "longitude": -84.40463, "elevation": 292.6 },
      { "latitude": 34.064075, "longitude": -84.40487, "elevation": 292 },
      { "latitude": 34.06397, "longitude": -84.40499, "elevation": 291.2 },
      { "latitude": 34.063942, "longitude": -84.405014, "elevation": 291.2 },
      { "latitude": 34.063736, "longitude": -84.40513, "elevation": 290.6 },
      { "latitude": 34.063683, "longitude": -84.40514, "elevation": 291 },
      { "latitude": 34.063583, "longitude": -84.4052, "elevation": 291 },
      { "latitude": 34.063385, "longitude": -84.40534, "elevation": 288.2 },
      { "latitude": 34.063374, "longitude": -84.405464, "elevation": 287 },
      { "latitude": 34.06337, "longitude": -84.40568, "elevation": 285.6 },
      { "latitude": 34.06331, "longitude": -84.40574, "elevation": 285.6 },
      { "latitude": 34.063213, "longitude": -84.40595, "elevation": 284.6 },
      { "latitude": 34.06321, "longitude": -84.406204, "elevation": 284.6 },
      { "latitude": 34.063183, "longitude": -84.40638, "elevation": 286.2 },
      { "latitude": 34.06324, "longitude": -84.40648, "elevation": 286.6 },
      { "latitude": 34.063183, "longitude": -84.40676, "elevation": 286.2 },
      { "latitude": 34.063156, "longitude": -84.40697, "elevation": 285.6 },
      { "latitude": 34.063152, "longitude": -84.40699, "elevation": 285.6 }
    ]
  }
};


var points = _(run.gps.waypoints).map(function(pt) {
    return [pt.latitude, pt.longitude];
});
var path = new L.Polyline(points, {color: '#1788cc'});
var map = L.map('map').fitBounds(path.getBounds()).addLayer(path);
var tiles = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
    maxZoom: 16
});
map.addLayer(tiles);

// Smooth an array of data using an arbitrarily-weighted moving average
//   sum of weights should equal 1.0 (unless scaling is desired)
var smooth = function(data, weights) {
    // Preload the weighted values using the first value in the data set
    var weighted = Array.apply(null, new Array(weights.length-1)).map(Number.prototype.valueOf,data[0]);

    // Re-map the data to it's smoothed values
    return _(data).map(function(d) {
    
        // Calculate a smoothed value from the weighted values
        var smoothed = _(weighted).reduce(function(s, w, i) {
            // s : intermediate calculation of smoothed value
            // w : current weighted value
            // i : current index into weighted values array
            return s + weights[i+1] * w;
        }, weights[0] * d);
        
        // Add the newly calculated value to the weighted values
        weighted.unshift(smoothed);
        
        // Remove the oldest weighted value
        weighted = weighted.slice(0, -1);
        
        // Return the new smoothed value for the map result
        return smoothed;
    });
};

// Gradually ramp up a data set to eliminate noise in initial values
//   cnt: how many data points to smooth
//   rate: how fast to ramp
var ramp = function(data, cnt, rate) {
    var finalValue = data[cnt];
    for (var idx=0; idx<cnt; idx++) {
        // We're using a scaled/shifted Logistic function to ramp
        data[idx] = ((2/(1+Math.exp(-rate*idx/cnt)))-1) * finalValue;
    }
    return data;
};

// Clean noisy GPS-derived data based observed problems
//    z: maximum z-value to permit
var clean = function(data, z) {
    var deltas = _(data).map(function(d, idx, arr) {
        if (idx < arr.length-1) {
            return arr[idx+1] - d;
        } else {
            return 0;
        }
    });
    deltas.pop();
    var sum = _(deltas).reduce(function(s, d) { return s+d; }, 0);
    var mean = sum / deltas.length;
    var variance = _(deltas).reduce(function(s,d) { return s+Math.pow(d - mean, 2) }, 0) / deltas.length;
    var stdev = Math.sqrt(variance);

    for (idx=1; idx<data.length; idx++) {
        if ((data[idx] - data[idx-1]) > (z * stdev)) {
            data[idx] = data[idx-1] + z * stdev;
        }
    }
    
    return data;
}

var dist = _(run.metrics).find(function(metric) {
    return metric.metricType.toUpperCase() === "DISTANCE";
});
dist = dist && _(dist.values).map(function(value) {
    return parseFloat(value) * 0.621371;
});
dist = smooth(dist, [ 0.40, 0.30, 0.15, 0.05, 0.05, 0.05 ]);
dist = clean(dist, 5);

var interval = parseInt(run.metrics[0].intervalMetric, 10);
var time = _.range(0, interval*run.metrics[0].values.length, interval);
var maxTime = Math.max.apply(null, time);
var tickCount = Math.floor(maxTime/300);
var tickScale = Math.ceil(tickCount/8)*5;
var timeTicks = _.range(tickScale*60, Math.floor(maxTime/tickScale)*tickScale, tickScale*60);
timeTicks = _(timeTicks).map(function(t) {
    if (t < 3600) { return [t, t/60 + ":00"];}
    return [t, Math.floor(t/3600) + ":" + _((t%3600)/60).pad(2, "0") + ":00"];
});
var pace = dist && _(dist).map(function(pt, idx) {
    if (idx === 0) {
        return interval / (60* (dist[1] - dist[0]));
    } else if (idx === dist.length-1) {
        return interval / (60* (dist[idx] - dist[idx-1]));
    } else {
        return interval / (30* (dist[idx+1] - dist[idx-1]));
    }
});

pace = ramp(pace, 12, 20);

var heartrate = _(run.metrics).find(function(metric) {
    return metric.metricType.toUpperCase() === "HEARTRATE";
});
heartrate = heartrate && _(heartrate.values).map(function(value, idx) {
    return parseInt(value,10) || null;
});
var elevation = run.gps && run.gps.waypoints &&
  _(run.gps.waypoints)
      .chain()
      .pluck("elevation")
      .map(function(pt) {
          return 3.28084*parseFloat(pt);
      })
      .value();
var gps_ratio = elevation && (elevation.length / time.length);
elevation = elevation && _(time).map(function(pt, idx){
    var range = _.range(
        Math.round(Math.max(gps_ratio*idx-gps_ratio/2, 0)),
        Math.round(Math.min(gps_ratio*idx+gps_ratio/2, elevation.length))
    );
    return _(range).reduce(function(avg,idx,cnt){
        return ((avg*cnt + elevation[idx]) / (cnt+1));
    }, 0);
});
var plots = [];
var plot;
var options = {
    legend: {show: false},
    series: {lines: {fill: false, lineWidth: 2}, shadowSize: 1},
    xaxis:  {show: true, min: 0, max: Math.max.apply(null, time), ticks: timeTicks, labelHeight: 0, autoscaleMargin: 0, tickFormatter: function() {return "";}},
    yaxis:  {show: false},
    grid:   {show: true, margin: 0, borderWidth: 0, borderColor: null, margin: 0, labelMargin: 0, axisMargin: 0, minBorderMargin: 0, hoverable: true, autoHighlight: false},
};
var clean, min, max, mean, div;
if (pace) {
    plot = {};
    plot.placeholder = $("<div>").addClass("figure");
    $(".charts-graphs").append(plot.placeholder);
    plot.data = _.zip(time, pace);
    plot.options = _({}).extend(options,{
        yaxis:  {show: false, min: 0, max: 1.2*Math.max.apply(null, pace)},
        series: {lines: {fill: true, fillColor: "#9fceea", lineWidth: 1}, shadowSize: 0},
        colors: ["#1788cc"],
    });
    plot.format = function(val) {
        if (!_(val).isFinite()) { return ""; }
        return Math.floor(val)  + ":" + _(Math.round((val  % Math.floor(val))*60)).pad(2, "0");
    };
    plots.push(plot);
    clean = _(pace).chain()
        .filter(function(pt) {return _(pt).isFinite();})
        .reject(function(pt) {return pt === 0;})
        .value();
    min = Math.min.apply(null, clean);
    max = Math.max.apply(null, clean);
    mean = _(clean).reduce(function(sum, pt) {return sum+pt;}, 0)/clean.length;
    div = $("<div>")
        .append($("<p>").html("<strong>Pace</strong>"))
        .append($("<p>").text("Slowest: " + plot.format(max)  + " per Mile"))
        .append($("<p>").text("Average: " + plot.format(mean) + " per Mile"))
        .append($("<p>").text("Fastest: " + plot.format(min)  + " per Mile"));
    $(".charts-legend").append(div);
}
if (heartrate) {
    plot = {};
    plot.placeholder = $("<div>").addClass("figure");
    $(".charts-graphs").append(plot.placeholder);
    plot.data = _.zip(time, heartrate);
    plot.options = _({}).extend(options,{
        yaxis:  {show: false, min: 0, max: 1.2*Math.max.apply(null, heartrate)},
        series: {lines: {fill: true, fillColor: "#eaaa9f", lineWidth: 1}, shadowSize: 0},
        colors: ["#cc3217"],
    });
    plot.format = function(val) {
        if (!_(val).isFinite() || (val === 0)) { return ""; }
        return Math.round(val);
    };
    plots.push(plot);
    clean = _(heartrate).chain()
        .filter(function(pt) {return _(pt).isFinite();})
        .reject(function(pt) {return pt === 0;})
        .value();
    min = Math.min.apply(null, clean);
    max = Math.max.apply(null, clean);
    mean = _(clean).reduce(function(sum, pt) {return sum+pt;}, 0)/clean.length;
    div = $("<div>")
        .append($("<p>").html("<strong>Heart Rate</strong>"))
        .append($("<p>").text("Minimum: " + plot.format(min)  + " bpm"))
        .append($("<p>").text("Average: " + plot.format(mean) + " bpm"))
        .append($("<p>").text("Maximum: " + plot.format(max)  + " bpm"));
    $(".charts-legend").append(div);
}
if (elevation) {
    plot = {};
    plot.placeholder = $("<div>").addClass("figure");
    $(".charts-graphs").append(plot.placeholder);
    plot.data = _.zip(time, elevation);
    var min = Math.min.apply(null,elevation);
    var max = Math.max.apply(null,elevation);
    var range = max - min;
    min -= 0.2*range;
    max += 0.2*range;
    plot.options = _({}).extend(options,{
        yaxis:  {show: false, min: min, max: max},
        series: {lines: {fill: true, fillColor: "#ead19f", lineWidth: 1}, shadowSize: 0},
        colors: ["#cc9117"],
    });
    plot.format = function(val) {
        if (!_(val).isFinite()) { return ""; }
        return Math.round(val);
    };
    plots.push(plot);
    min = Math.min.apply(null, elevation);
    max = Math.max.apply(null, elevation);
    mean = _(elevation).reduce(function(sum, pt) {return sum+pt;}, 0)/elevation.length;
    div = $("<div>")
        .append($("<p>").html("<strong>Elevation</strong>"))
        .append($("<p>").text("Minimum: " + plot.format(min)  + " ft"))
        .append($("<p>").text("Average: " + plot.format(mean) + " ft"))
        .append($("<p>").text("Maximum: " + plot.format(max)  + " ft"));
    $(".charts-legend").append(div);
}
plot = {};
plot.placeholder = $("<div>").addClass("x-axis");
$(".charts-graphs").append(plot.placeholder);
plot.data = _(time).map(function(t) { return [t, null];});
plot.options = _({}).extend(options,{
    xaxis:  {
        show: true,
        min: 0,
        max: Math.max.apply(null, time),
        ticks: timeTicks,
        labelHeight: 12,
        autoscaleMargin: 0,
    },
    yaxis:  {show: false, min: 100, max: 200},
    grid:   {show: true, margin: 0, borderWidth: 0, margin: 0, labelMargin: 0, axisMargin: 0, minBorderMargin: 0},
});
plot.format = function(val) {return ""; };
plots.push(plot);

_(plots).each(function(plot) {
    plot.plot = $.plot(plot.placeholder, [plot.data], plot.options);
    plot.value = $("<div>").css({
        'position':  "absolute",
        'top':       plot.placeholder.position().top + "px",
        'display':   "none",
        'z-index':   1,
        'font-size': "11px",
        'color':     "black"
    });
    $(".charts-wrapper").append(plot.value);
}, this);

$(".charts-graphs").on("plothover", function(ev, pos) {
    var xvalue = Math.round(pos.x/10);
    var left = _(plots).last().plot.pointOffset(pos).left;
    var height = $(".charts-graphs").height() - 15;
    $(".charts-marker").css({
        'top':    0,
        'left':   left,
        'width':  "1px",
        'height': height
    }).show();
    _(plots).each(function(plot){
        if ((xvalue >= 0) && (xvalue < plot.data.length)) {
            $(plot.value).text(plot.format(plot.data[xvalue][1])).css("left", (left+4)+"px").show();
        }
    });
}).on("mouseout", function(ev) {
    if (ev.relatedTarget.className !== "charts-marker") {
        $(".charts-marker").hide();
        _(plots).each(function(plot) { plot.value.hide(); });
    }
});
$(".charts-marker").on("mouseout", function(ev) {
    $(".charts-marker").hide();
    _(plots).each(function(plot) { plot.value.hide(); });
});






});
</script>
<h2 id="connecting-with-the-nike-service">Connecting with the Nike+ Service</h2>
<p>Although our example application relies on the Nike+ service for its data, we haven’t looked at the details of that service’s interface. We have seen hints Nike+ doesn’t quite conform to common REST API conventions that application libraries such as Backbone.js expect. That’s true, but it isn’t all that unusual. There really isn’t a true <em>standard</em> for REST APIs, and many other services take approaches similar to Nike+. Fortunately Backbone.js anticipates this variation. As we’ll see in the following steps, extending Backbone.js to support REST API variations isn’t all that difficult.</p>
<h3 id="step-1-user-authorization">Step 1: User Authorization</h3>
<p>As you might expect, Nike+ doesn’t allow anyone on the internet to retrieve details for any user’s runs. Users expect at least some level of privacy for that information. Before our app can retrieve any running information, therefore, it will need the user’s permission. We won’t go into the details of that process here, but it’s result will be an <code>authorization_token</code>. This object is an arbitrary string that our app will have to include with every Nike+ request. If the token is missing or invalid, Nike+ will deny our app access to the data.</p>
<p>Up until now we’ve left all of the details of the REST API to Backbone.js, and you might think it would be tricky to modify how Backbone.js constructs its AJAX calls. In fact,though, it’s not. All we need to do is add a <code>sync</code> method to our Runs collection. When a <code>sync</code> method is present in a collection, Backbone.js calls it whenever it makes an AJAX request. (If there is no such method for a collection, Backbone.js calls its primary <code>Backbone.sync</code> method.) We’ll define the new method directly in the collection.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span> = <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="fu">extend</span>({

    <span class="dt">sync</span>: <span class="kw">function</span>(method, collection, options) {
        <span class="co">// Handle the AJAX request</span>
    }</code></pre></td></tr></table>
<p>As you can see, <code>sync</code> is passed a <code>method</code> (<code>GET</code>, <code>POST</code>, etc.), the collection in questions, and an object containing options for the request. To send the authorization token to Nike+, we can add it as a parameter using this <code>options</code> object.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">sync: <span class="kw">function</span>(method, collection, options) {
    options = options || {};
    <span class="fu">_</span>(options).<span class="fu">extend</span>({
        <span class="dt">data</span>: { <span class="dt">authorization_token</span>: <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">authorization_token</span> }
    });

    <span class="co">// Code continues...</span>
}</code></pre></td></tr></table>
<p>The first line in the method makes sure that the <code>options</code> parameter exists. If the caller doesn’t provide a value, we set it to an empty object (<code>{}</code>). The rest of the code adds a <code>data</code> property to the <code>options</code> object by extending that object. We’re taking advantage of one of the Underscore.js utilities that we saw in the previous chapter.</p>
<p>Before we see how to supply the <code>this.settings.authorization_token</code>, let’s finish up the <code>sync</code> method by actually making the AJAX request. Now that we’ve added the token, our request is a standard AJAX request so we can let Backbone.js take it from here. Here’s the resulting <code>sync</code> method in full.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">sync: <span class="kw">function</span>(method, collection, options) {
    options = options || {};
    <span class="fu">_</span>(options).<span class="fu">extend</span>({
        <span class="dt">data</span>: { <span class="dt">authorization_token</span>: <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">authorization_token</span> }
    });
    <span class="ot">Backbone</span>.<span class="fu">sync</span>(method, collection, options);
}</code></pre></td></tr></table>
<p>Now we can turn our attention to the <code>settings</code> object. We’re using that object to hold properties related to the collection as a whole. It’s the collection’s equivalent of a model’s attributes. Backbone.js doesn’t create this object for us automatically, but it’s easy enough to do it ourselves. We’ll do it in the collection’s <code>initialize</code> method. That method accepts two parameters, an array of models for the collection and any collection options.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span> = <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="fu">extend</span>({

    <span class="dt">initialize</span>: <span class="kw">function</span>(models, options) {
        <span class="kw">this</span>.<span class="fu">settings</span> = { <span class="dt">authorization_token</span>: <span class="st">&quot;&quot;</span> };
        options = options || {};
        <span class="fu">_</span>(<span class="kw">this</span>.<span class="fu">settings</span>).<span class="fu">extend</span>(<span class="fu">_</span>(options)
            .<span class="fu">pick</span>(<span class="fu">_</span>(<span class="kw">this</span>.<span class="fu">settings</span>).<span class="fu">keys</span>()));
    },</code></pre></td></tr></table>
<p>The first statement in the <code>initialize</code> method defines a <code>settings</code> object for the collection, and it establishes default values for that object. Since there isn’t an appropriate default value for the authorization token, we’ll use an empty string.</p>
<p>The next statement makes sure that the <code>options</code> object exists. If none is passed as a parameter, we’ll at least have an empty object.</p>
<p>The final statement uses a few Underscore.js utilities. It extracts all the keys in the settings, finds any values in the <code>options</code> object with the same keys, and updates the <code>settings</code> object by extending it with those new key values.</p>
<p>When we first create the Runs collection, we can pass the authorization token as a parameter. We supply an empty array as the first parameter because we don’t have any models for the collection. Those will come from Nike+.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">var</span> runs = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span>([], {<span class="dt">authorization_token</span>: <span class="st">&quot;authorize me&quot;</span>});</code></pre></td></tr></table>
<p>With just a small bit of extra code we’ve added the authorization token to our AJAX requests to Nike+.</p>
<h3 id="step-2-accepting-the-nike-response">Step 2: Accepting the Nike+ Response</h3>
<p>When our collection queries Nike+ for a list of user activities, Backbone.js is prepared for a response in a particular format. More specifically, Backbone.js expects the response to be a simple array of models.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">[
  { <span class="st">&quot;activityId&quot;</span>: <span class="st">&quot;2126456911&quot;</span>, <span class="co">/* Data continues... */</span> },
  { <span class="st">&quot;activityId&quot;</span>: <span class="st">&quot;2125290225&quot;</span>, <span class="co">/* Data continues... */</span> },
  { <span class="st">&quot;activityId&quot;</span>: <span class="st">&quot;2124784253&quot;</span>, <span class="co">/* Data continues... */</span> },
  <span class="co">// Data set continues...</span>
]</code></pre></td></tr></table>
<p>In fact, however, Nike+ returns its response as an object. The array of activities is one property of the object.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">{
  <span class="st">&quot;data&quot;</span>: [
    { <span class="st">&quot;activityId&quot;</span>: <span class="st">&quot;2126456911&quot;</span>, <span class="co">/* Data continues... */</span> },
    { <span class="st">&quot;activityId&quot;</span>: <span class="st">&quot;2125290225&quot;</span>, <span class="co">/* Data continues... */</span> },
    { <span class="st">&quot;activityId&quot;</span>: <span class="st">&quot;2124784253&quot;</span>, <span class="co">/* Data continues... */</span> },
    <span class="co">// Data set continues...</span>
  ],
  <span class="co">// Response continues...</span>
}</code></pre></td></tr></table>
<p>To help Backbone.js cope with this response we add a <code>parse</code> method to our collection. The job of that function is to take the response that the server provides and return the response that Backbone.js expects. In our case that’s very easy to do. We just return the <code>data</code> property of the response.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span> = <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="fu">extend</span>({

    <span class="dt">parse</span>: <span class="kw">function</span>(response) {
        <span class="kw">return</span> <span class="ot">response</span>.<span class="fu">data</span>;
    },</code></pre></td></tr></table>
<h3 id="step-3-paging-the-collection">Step 3: Paging the Collection</h3>
<p>The next aspect of the Nike+ API we’ll tackle is its paging. When we request the activities for a user, the service doesn’t normally return <em>all</em> of them. Users may have thousands of activities stored in Nike+, and returning all of them at once might overwhelm the app. It can certainly add a noticeable delay as the app would have to wait for the entire response before it could process it. To avoid this problem, Nike+ divides user activities into pages, and it responds with one page of activities at a time. We’ll have to adjust our app for that behavior, but we’ll gain the benefit of a more responsive user experience when we do.</p>
<p>The first adjustment we’ll make is in our request. We can add parameters to that request to indicate how many activities we’re prepared to accept in the response. The two parameters are <code>offset</code> and <code>count</code>. The <code>offset</code> tells Nike+ which activity we want to be first in the response, while <code>count</code> indicates how many activities Nike+ should return. If we wanted the first 20 activities, for example, we can set <code>offset</code> to <code>1</code> and <code>count</code> to <code>20</code>. Then, to get the next 20 activities, we’d set <code>offset</code> to <code>21</code> (and keep <code>count</code> at <code>20</code>).</p>
<p>We add these parameters to our request the same way we added the authorization token, in the <code>sync</code> method.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">sync: <span class="kw">function</span>(method, collection, options) {
    options = options || {};
    <span class="fu">_</span>(options).<span class="fu">extend</span>({
        <span class="dt">data</span>: {
            <span class="dt">authorization_token</span>: <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">authorization_token</span>,
            <span class="dt">count</span>: <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">count</span>,
            <span class="dt">offset</span>: <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">offset</span>
        }
    });
    <span class="ot">Backbone</span>.<span class="fu">sync</span>(method, collection, options);
}</code></pre></td></tr></table>
<p>We will also have to provide default values for those settings during initialization.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">initialize: <span class="kw">function</span>(models, options) {
    <span class="kw">this</span>.<span class="fu">settings</span> = { 
        <span class="dt">authorization_token</span>: <span class="st">&quot;&quot;</span>,
        <span class="dt">count</span>: <span class="dv">25</span>,
        <span class="dt">offset</span>: <span class="dv">1</span>
    };</code></pre></td></tr></table>
<p>Those values will get the first 25 activities, but that’s only a start. Our users will probably want to see all of their runs, not just the first 25. To get the additional activities we’ll have to make more requests to the server. Once we get the first 25 activities we can request the next 25. And once those arrive we can ask for 25 more. We’ll keep at this until we either reach some reasonable limit or the server runs out of activities.</p>
<p>First we define a reasonable limit as another settings value. In the code below we’re using <code>10000</code> as that limit.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">initialize: <span class="kw">function</span>(models, options) {
    <span class="kw">this</span>.<span class="fu">settings</span> = { 
        <span class="dt">authorization_token</span>: <span class="st">&quot;&quot;</span>,
        <span class="dt">count</span>: <span class="dv">25</span>,
        <span class="dt">offset</span>: <span class="dv">1</span>,
        <span class="dt">max</span>: <span class="dv">10000</span>
    };</code></pre></td></tr></table>
<p>Next we need to modify the <code>fetch</code> method for our collection since the standard Backbone.js <code>fetch</code> can’t handle paging. We’re going to do three things in our implementation of the method.</p>
<ol type="1">
<li>Save a copy of whatever options Backbone.js is using for the request.</li>
<li>Extend those options by adding a callback function when the request succeeds.</li>
<li>Pass control to the normal Backbone.js <code>fetch</code> method for collections.</li>
</ol>
<p>Each of those steps is a line in the implementation below. The last one might seem a little tricky, but it makes sense if you take it one step at a time. The expression <code>Backbone.Collection.prototype.fetch</code> refers to the normal <code>fetch</code> method of a Backbone.js collection. We execute this method using <code>.call()</code> so that we can set the context for the method to be our collection. That’s the first <code>this</code> parameter of <code>call</code>. The second parameter holds the options for <code>fetch</code>, which are just the extended options we created in step 2.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span> = <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="fu">extend</span>({

    <span class="dt">fetch</span>: <span class="kw">function</span>(options) {
        <span class="kw">this</span>.<span class="fu">fetchoptions</span> = options = options || {};
        <span class="fu">_</span>(<span class="kw">this</span>.<span class="fu">fetchoptions</span>).<span class="fu">extend</span>({ <span class="dt">success</span>: <span class="kw">this</span>.<span class="fu">fetchMore</span> });
        <span class="kw">return</span> <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="ot">prototype</span>.<span class="ot">fetch</span>.<span class="fu">call</span>(<span class="kw">this</span>, <span class="kw">this</span>.<span class="fu">fetchoptions</span>);
    },</code></pre></td></tr></table>
<p>By adding a <code>success</code> callback to the AJAX request, we’re asking to be notified when the request completes. In fact, we’ve said that we want the <code>this.fetchMore</code> function to be called. It’s time to write that function; it too is a method of the Runs collection. This function checks to see if there are more activities left. If so, it executes another call to Backbone.js’s regular collection <code>fetch</code> just as above.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">fetchMore: <span class="kw">function</span>() {
    <span class="kw">if</span> (<span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">offset</span> &lt; <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">max</span>) {
        <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="ot">prototype</span>.<span class="ot">fetch</span>.<span class="fu">call</span>(<span class="kw">this</span>, <span class="kw">this</span>.<span class="fu">fetchoptions</span>);
    }
}</code></pre></td></tr></table>
<p>Since <code>fetchMore</code> is looking at the settings to decide when to stop, we’ll need to update those values. Because we already have a <code>parse</code> method, and because Backbone calls this method with each response, that’s a convenient place for the update. Let’s add a bit of code before the return statement. If the number of activities that the server returns is less than the number we asked for, then we’ve exhausted the list of activities. We’ll set the <code>offset</code> to the <code>max</code> so <code>fetchMore</code> knows to stop. Otherwise, we increment <code>offset</code> by the number of activities.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">parse: <span class="kw">function</span>(response) {
    <span class="kw">if</span> (<span class="ot">response</span>.<span class="ot">data</span>.<span class="fu">length</span> &lt; <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">count</span>) {
        <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">offset</span> = <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">max</span>;
    } <span class="kw">else</span> {
        <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">offset</span> += <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">count</span>;
    }
    <span class="kw">return</span> <span class="ot">response</span>.<span class="fu">data</span>;
}</code></pre></td></tr></table>
<p>The code we’ve written so far is almost complete, but it has a problem. When Backbone.js fetches a collection, it assumes that it’s fetching the whole collection. By default, therefore, each fetched response replaces the models already in the collection with those in the response. That behavior is fine the first time we call <code>fetch</code>, but it’s definitely not okay once we’re fetching more activities. Instead, we want Backbone.js to add to the collection instead of replacing it. Fortunately, there’s a simple option that tells Backbone.js to do what we want. That’s the <code>remove</code> option.</p>
<p>In our <code>fetch</code> method we set that option to <code>true</code> so Backbone.js will start a new collection.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">fetch: <span class="kw">function</span>(options) {
    <span class="kw">this</span>.<span class="fu">fetchoptions</span> = options = options || {};
    <span class="fu">_</span>(<span class="kw">this</span>.<span class="fu">fetchoptions</span>).<span class="fu">extend</span>({ 
        <span class="dt">success</span>: <span class="kw">this</span>.<span class="fu">fetchMore</span>,
        <span class="dt">remove</span>: <span class="kw">true</span>
     });
    <span class="kw">return</span> <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="ot">prototype</span>.<span class="ot">fetch</span>.<span class="fu">call</span>(<span class="kw">this</span>, <span class="kw">this</span>.<span class="fu">fetchoptions</span>);
}</code></pre></td></tr></table>
<p>Now, in the <code>fetchMore</code> method we can reset this option to <code>false</code>, and Backbone.js will add to instead of replace models in the collection.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">fetchMore: <span class="kw">function</span>() {
    <span class="kw">this</span>.<span class="ot">fetchoptions</span>.<span class="fu">remove</span> = <span class="kw">false</span>;
    <span class="kw">if</span> (<span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">offset</span> &lt; <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">max</span>) {
        <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="ot">prototype</span>.<span class="ot">fetch</span>.<span class="fu">call</span>(<span class="kw">this</span>, <span class="kw">this</span>.<span class="fu">fetchoptions</span>);
    }
}</code></pre></td></tr></table>
<p>There is still a small problem with the <code>fetchMore</code> method. That code references properties of the collection (<code>this.fetchoptions</code> and <code>this.settings</code>) but the method will be called asynchronously when the AJAX request completes. When that occurs, the collection won’t be in context, so <code>this</code> won’t be set to the collection. To fix that, we can bind <code>fetchMore</code> to the collection during initialization. Once again an Underscore.js utility function comes in handy.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">initialize: <span class="kw">function</span>(models, options) {
    <span class="ot">_</span>.<span class="fu">bindAll</span>(<span class="kw">this</span>, <span class="st">&quot;fetchMore&quot;</span>);</code></pre></td></tr></table>
<p>For the final part of this step we can make our collection a little more friendly to code that uses it. In order to keep fetching additional pages, we’ve set the <code>success</code> callback for the <code>fetch</code> options. What happens if the code that uses our collection had its own callback? Unfortunately, we’ve erased that callback to substitute our own. It would be better to simply set aside an existing callback function and then restore it once we’ve finished fetching the entire collection. We’ll do that first in our <code>fetch</code> method. Here’s the full code for the method.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">fetch: <span class="kw">function</span>(options) {
    <span class="kw">this</span>.<span class="fu">fetchoptions</span> = options = options || {};
    <span class="kw">this</span>.<span class="fu">fetchsuccess</span> = <span class="ot">options</span>.<span class="fu">success</span>;
    <span class="fu">_</span>(<span class="kw">this</span>.<span class="fu">fetchoptions</span>).<span class="fu">extend</span>({
        <span class="dt">success</span>: <span class="kw">this</span>.<span class="fu">fetchMore</span>,
        <span class="dt">remove</span>: <span class="kw">true</span>
        });
    <span class="kw">return</span> <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="ot">prototype</span>.<span class="ot">fetch</span>.<span class="fu">call</span>(<span class="kw">this</span>, <span class="kw">this</span>.<span class="fu">fetchoptions</span>);
}</code></pre></td></tr></table>
<p>Now we can execute that callback in <code>fetchMore</code> when we’ve exhausted the server’s list.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">fetchMore: <span class="kw">function</span>() {
    <span class="kw">this</span>.<span class="ot">fetchoptions</span>.<span class="fu">remove</span> = <span class="kw">false</span>;
    <span class="kw">if</span> (<span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">offset</span> &lt; <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">max</span>) {
        <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="ot">prototype</span>.<span class="ot">fetch</span>.<span class="fu">call</span>(<span class="kw">this</span>, <span class="kw">this</span>.<span class="fu">fetchoptions</span>);
    } <span class="kw">else</span> <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">fetchsuccess</span>) {
        <span class="kw">this</span>.<span class="fu">fetchsuccess</span>();
    }
}</code></pre></td></tr></table>
<h3 id="step-4-dynamically-updating-the-view">Step 4: Dynamically Updating the View</h3>
<p>By fetching the collection of runs in pages we’ve made our application much more responsive. We can start displaying summary data for the first 25 runs even while we’re waiting to retrieve the rest of the user’s runs from the server. To do that effectively, though, we need to make a small change to our Summary view. As it stands now, our view is listening for any changes to the collection. When a change occurs, it renders the view from scratch.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">initialize: <span class="kw">function</span> () {
    <span class="kw">this</span>.<span class="fu">listenTo</span>(<span class="kw">this</span>.<span class="fu">collection</span>, <span class="st">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
    <span class="kw">return</span> <span class="kw">this</span>;
}</code></pre></td></tr></table>
<p>Every time we fetch a new page of runs, the collection will change and our code will re-render the entire view. That’s almost certainly going to be annoying to our users, as each fetched page will cause the browser to temporarily blank the page and then refill it. What we would really like to do instead is only render views for the newly added models, leaving existing model views alone. To do that, we can listen for an <code>'add'</code> event instead of a <code>'change'</code> event. And when this event triggers, we can just render the view for that model. We’ve already implemented the code to create and render a view for a single Run model; it’s the <code>renderRun</code> method. Our Summary view, therefore, can be modified as below.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">initialize: <span class="kw">function</span> () {
    <span class="kw">this</span>.<span class="fu">listenTo</span>(<span class="kw">this</span>.<span class="fu">collection</span>, <span class="st">&#39;add&#39;</span>, <span class="kw">this</span>.<span class="fu">renderRun</span>);
    <span class="kw">return</span> <span class="kw">this</span>;
}</code></pre></td></tr></table>
<p>Now as our collection fetches new Run models from the server, they’ll be added to the collection, triggering an <code>'add'</code> event, which our view captures. The view then renders each Run on the page.</p>
<h3 id="step-5-filtering-the-collection">Step 5: Filtering the Collection</h3>
<p>Although our app is only interested in running, the Nike+ service supports a variety of athletic activities. When our collection fetches from the service, the response will include those other activities as well. To avoid including them in our app, we can filter them from the response.</p>
<p>We could filter the response manually, checking every activity and removing those that weren’t runs. That’s a bit of work, however, and Backbone.js gives us an easier approach. To take advantage of Backbone.js, we’ll first add a <code>validate</code> method to our Run model. This method takes as parameters the attributes of a potential model as well as any options used when creating or modifying it. In our case we only care about the attributes. We’ll check to make sure the <code>activityType</code> equals <code>&quot;RUN&quot;</code>.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span> = <span class="ot">Backbone</span>.<span class="ot">Model</span>.<span class="fu">extend</span>({
    <span class="dt">validate</span>: <span class="kw">function</span>(attributes, options) {
        <span class="kw">if</span> (<span class="ot">attributes</span>.<span class="ot">activityType</span>.<span class="fu">toUpperCase</span>() !== <span class="st">&quot;RUN&quot;</span>) {
            <span class="kw">return</span> <span class="st">&quot;Not a run&quot;</span>;
        }
    },</code></pre></td></tr></table>
<p>You can see from the code above how <code>validate</code> functions should behave. If there is an error in the model, then <code>validate</code> returns a value. The specifics of the value don’t matter as long as JavaScript considers it true. If there is no error, then <code>validate</code> doesn’t need to return anything at all.</p>
<p>Now that our model has a <code>validate</code> method, we need to make sure Backbone.js calls it. Backbone.js automatically checks with <code>validate</code> whenever a model is created or modified by the code, but it doesn’t normally validate responses from the server. In our case, however, we do want to validate the server responses. That requires that we set the <code>validate</code> property in the <code>fetch</code> options for our Runs collection. Here’s the full <code>fetch</code> method with this change included.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span> = <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="fu">extend</span>({
    <span class="dt">fetch</span>: <span class="kw">function</span>(options) {
        <span class="kw">this</span>.<span class="fu">fetchoptions</span> = options = options || {};
        <span class="kw">this</span>.<span class="fu">fetchsuccess</span> = <span class="ot">options</span>.<span class="fu">success</span>;
        <span class="fu">_</span>(<span class="kw">this</span>.<span class="fu">fetchoptions</span>).<span class="fu">extend</span>({
            <span class="dt">success</span>: <span class="kw">this</span>.<span class="fu">fetchMore</span>,
            <span class="dt">remove</span>: <span class="kw">true</span>,
            <span class="dt">validate</span>: <span class="kw">true</span>
          });
        <span class="kw">return</span> <span class="ot">Backbone</span>.<span class="ot">Collection</span>.<span class="ot">prototype</span>.<span class="ot">fetch</span>.<span class="fu">call</span>(<span class="kw">this</span>, <span class="kw">this</span>.<span class="fu">fetchoptions</span>);
    },</code></pre></td></tr></table>
<p>Now when Backbone.js receives server responses, it passes all of the models in those responses through the model’s <code>validate</code> method. Any model that fails validation is removed from the collection, and our app never has to bother with activities that aren’t runs.</p>
<h3 id="step-6-parsing-the-response">Step 6: Parsing the Response</h3>
<p>As long as we’re adding code to the Run model, there’s another change that will make Backbone.js happy. Backbone.js requires models to have an attribute that makes each object unique. It can use this attribute to distinguish one Run from any other. By default Backbone.js expects models to have an <code>id</code> attribute for this purpose, as that’s a common convention. Nike+, however, doesn’t have an <code>id</code> attribute for its runs. Instead, the service uses the <code>activityId</code> attribute. We can tell Backbone.js about this with an extra property in the model.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span> = <span class="ot">Backbone</span>.<span class="ot">Model</span>.<span class="fu">extend</span>({
    <span class="dt">idAttribute</span>: <span class="st">&#39;activityId&#39;</span>,</code></pre></td></tr></table>
<p>This property lets Backbone.js know that for our Runs, the <code>activityId</code> property is the unique identifier.</p>
<h3 id="step-7-retrieving-details">Step 7: Retrieving Details</h3>
<p>The last change that Nike+ requires of our Backbone.js app lets us retrieve all the details for a run. So far we’ve been relying on the collection’s fetch method to get running data. That method retrieves a list of runs from the server. When Nike+ returns a list of activities, however, it doesn’t include the full details of each activity. It does return summary information, but it omits the detailed metrics arrays and any GPS data. Getting that information requires additional requests.</p>
<p>We’ll first request the detailed metrics on which our Charts view bases its graphs. When the Runs collection fetches its list of runs from the server, each Run model will initially have an empty <code>metrics</code> array. To get the details for this array, we must make another request to the server. The request takes the same form as the request for the list, but it adds the activity identifier to the URL. More specifically, if the URL to get a list of runs is <code>https://api.nike.com/v1/me/sport/activities</code>, then the URL to get the details for a specific run, including its metrics, is <code>https://api.nike.com/v1/me/sport/activities/2126456911</code>. The number <code>2126456911</code> at the end of that URL is the run’s <code>activityId</code>.</p>
<p>Because of the steps we’ve taken earlier in this section, Backbone.js makes it easy to get these details. All we have to do is <code>fetch</code> the model.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">run</span>.<span class="fu">fetch</span>();</code></pre></td></tr></table>
<p>Backbone.js knows the root of the URL because we set that in the Runs collection (and our model is a member of that collection). Backbone.js also knows that the unique identifier for each run is the <code>activityId</code> because we set that property in the previous step. And, fortunately for us, Backbone.js is smart enough to combine those bits of information and make the request.</p>
<p>We will have to help Backbone.js in one respect, though. The Nike+ requires an authorization token for all requests, and so far we’ve only added code for that token to the collection. We have to add the same code to the model. The code below is almost identical to the code from step 1 in this section. We first make sure that the <code>options</code> object exists, then we extend it by adding the authorization token. Finally, we defer to the regular Backbone.js <code>sync</code> method. As you can see, we’re getting the value for the token directly from the collection. When a model is part of a collection, Backbone.js sets the <code>collection</code> property of the model to reference that collection. We use that property to get the collection’s settings, specifically the authorization token.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span> = <span class="ot">Backbone</span>.<span class="ot">Model</span>.<span class="fu">extend</span>({
    <span class="dt">sync</span>: <span class="kw">function</span>(method, model, options) {
        options = options || {};
        <span class="fu">_</span>(options).<span class="fu">extend</span>({
            <span class="dt">data</span>: { <span class="dt">authorization_token</span>: <span class="kw">this</span>.<span class="ot">collection</span>.<span class="ot">settings</span>.<span class="fu">authorization_token</span> }
        });
        <span class="ot">Backbone</span>.<span class="fu">sync</span>(method, model, options);
    },</code></pre></td></tr></table>
<p>Now we have to decide when and where to call a model’s <code>fetch</code> method. We don’t actually need the metrics details for the summary view on the main page of our app; we only need the information if we’re creating a Details view. That suggests, therefore, that we should only bother getting the data when we create a Details view. We can conveniently do that in the view’s <code>initialize</code> method.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Details</span> = <span class="ot">Backbone</span>.<span class="ot">View</span>.<span class="fu">extend</span>({
    <span class="dt">initialize</span>: <span class="kw">function</span> () {
        <span class="kw">if</span> (!<span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">get</span>(<span class="st">&quot;metrics&quot;</span>) || <span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">get</span>(<span class="st">&quot;metrics&quot;</span>).<span class="fu">length</span> === <span class="dv">0</span>) {
            <span class="kw">this</span>.<span class="ot">model</span>.<span class="fu">fetch</span>();
        }            
    },</code></pre></td></tr></table>
<p>You might think that the asynchronous nature of the request could cause problems for our view. After all, aren’t we trying to draw the charts when we render the newly created view? And might that happen before the server has responded, in which case there won’t be any data for the charts? The answer to both questions is “Yes.” In fact, it’s almost guaranteed that our view will be trying to draw its charts before the data is available. Nonetheless, because of the way we’ve structured our views, there is no problem.</p>
<p>The magic is a single statement in the <code>initialize</code> method of our Charts view.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Charts</span> = <span class="ot">Backbone</span>.<span class="ot">View</span>.<span class="fu">extend</span>({
    <span class="dt">initialize</span>: <span class="kw">function</span> () {
        <span class="kw">this</span>.<span class="fu">listenTo</span>(<span class="kw">this</span>.<span class="fu">model</span>, <span class="st">&#39;change:metrics change:gps&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
        <span class="co">// Code continues...</span></code></pre></td></tr></table>
<p>That statement tells Backbone.js that our view wants to know whenever the <code>metrics</code> (or <code>gps</code>) property of the associated model changes. When such a change takes place, Backbone.js calls the view’s <code>render</code> method and it will try (again) to draw the charts. Backbone.js can tell that the server’s response to the model’s <code>fetch</code> updates the <code>metrics</code> property, so it triggers the view’s <code>render</code> method which successfully draw the charts.</p>
<p>There’s quite a lot going on in this process, so it may help to look at it one step at a time.</p>
<ol type="1">
<li>The application calls the <code>fetch</code> method of a Runs collection.</li>
<li>Backbone.js sends a request to the server for a list of activities.</li>
<li>The server’s response includes summary information for each activity, which Backbone.js uses to create the initial Run models.</li>
<li>The application creates a Details view for a specific Run model.</li>
<li>The <code>initialize</code> method of this view calls the <code>fetch</code> method of the particular model.</li>
<li>Backbone.js sends a request to the server for that activity’s details.</li>
<li>Meanwhile, the application renders the Details view it just created.</li>
<li>The Details view creates a Charts view and renders that view.</li>
<li>Because there is no data for any charts, the Charts view doesn’t actually add anything to the page, but it is waiting to hear of any relevant changes to the model.</li>
<li>Eventually the server responds to the request in step 6 with details for the activity.</li>
<li>Backbone.js updates the model with the new details and notices that, as a result, the <code>metrics</code> property has changed.</li>
<li>Backbone.js triggers the change event for which the Charts view has been listening.</li>
<li>The Charts view receives the event trigger and again renders itself.</li>
<li>Because chart data is now available, the <code>render</code> method is able to create the charts and add them to the page.</li>
</ol>
<p>Whew! It’s a good thing that Backbone.js takes care of all that complexity.</p>
<p>At this point we’ve managed to retrieve the detailed metrics for a run, but we haven’t yet added any GPS data. Nike+ requires an additional request for that data, so we’ll use a similar process. In this case, though, we can’t rely on Backbone.js because the URL for the GPS request is unique to Nike+. That URL is formed by taking the individual activity’s URL and appending <code>/gps</code>. A complete example would be <code>https://api.nike.com/v1/me/sport/activities/2126456911/gps</code>.</p>
<p>To make the additional request we can add some code to the regular <code>fetch</code> method. We’ll request the GPS data at the same time Backbone.js asks for the metrics details. The basic approach, which the code fragment below illustrates, is simple. We’ll first see if the activity even has any GPS data. We can do that by checking the <code>isGpsActivity</code> property which the server provides on activity summaries. If it does, then we can request it. In either case we also want to execute the normal <code>fetch</code> process for the model. We do that by getting a reference to the standard <code>fetch</code> method for the model (<code>Backbone.Model.prototype.fetch</code>) and then calling that method. We pass is the same <code>options</code> passed to us.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span> = <span class="ot">Backbone</span>.<span class="ot">Model</span>.<span class="fu">extend</span>({
    <span class="dt">fetch</span>: <span class="kw">function</span>(options) {
        <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">get</span>(<span class="st">&quot;isGpsActivity&quot;</span>)) {
            <span class="co">// request GPS details from the server</span>
        }
        <span class="kw">return</span> <span class="ot">Backbone</span>.<span class="ot">Model</span>.<span class="ot">prototype</span>.<span class="ot">fetch</span>.<span class="fu">call</span>(<span class="kw">this</span>, options);
    },</code></pre></td></tr></table>
<p>To make the request to Nike+ we can use jQuery’s AJAX function. Since we’re asking for Javascipt objects (JSON data), the <code>$.getJSON</code> function is the most appropriate. First we set aside a reference to the run by assigning <code>this</code> to the local variable <code>model</code>. We’ll need that variable because <code>this</code> won’t reference the model when jQuery executes our callback. Then we call <code>$.getJSON</code> with three parameters. First is the URL for the request. We get that from Backbone.js by calling the <code>url</code> method for the model and appending the trailing <code>/gps</code>. The second parameter are data values to be included with the request. As always we need to include an authorization token. Just as we did aboe, we can get that token’s value from the collection. The final parameter is a callback function that JQuery executes when it receives the server’s response. In our case the function simply sets the <code>gps</code> property of the model to the response data.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">get</span>(<span class="st">&quot;isGpsActivity&quot;</span>)) {
    <span class="kw">var</span> model = <span class="kw">this</span>;
    <span class="ot">$</span>.<span class="fu">getJSON</span>(
        <span class="kw">this</span>.<span class="fu">url</span>() + <span class="st">&quot;/gps&quot;</span>,
        { <span class="dt">authorization_token</span>: <span class="kw">this</span>.<span class="ot">collection</span>.<span class="ot">settings</span>.<span class="fu">authorization_token</span> },
        <span class="kw">function</span>(data) { <span class="ot">model</span>.<span class="fu">set</span>(<span class="st">&quot;gps&quot;</span>, data); }
    );
}</code></pre></td></tr></table>
<p>Not surprisingly, the process of retrieving GPS data works the same way as retrieving the detailed metrics. Initially our Map view won’t have the data it needs to create a map for the run. Because it’s listening to changes to the <code>gps</code> property of the model, however, it will be notified when that data is available. At that point it can complete the <code>render</code> function and the user will be able to view a nice map of the run.</p>
<h2 id="putting-it-all-together">Putting it All Together</h2>
<p>At this point in the chapter we have all the pieces for a simple data-driven web application. Now we’ll take those pieces and assemble them into the app. At the end of this section we’ll have a complete application. Users start the app by visiting a web page, and our JavaScript code takes it from there. The result is a <em>single page application,</em> or SPA. SPAs have become popular because JavaScript code can respond to user interaction immediately in the browser, which is much quicker than traditional web sites communicating with a server located halfway across the internet. Users are often pleased with the snappy and responsive result.</p>
<p>Even though our app is executing in a single web page, our users still expect certain behaviors from their web browsers. They expect to be able to bookmark a page, share it with friends, or navigate using the browser’s forward and back buttons. Traditional web sites can rely on the browser to support all of those behaviors, but a single page application can’t. As we’ll see in the steps that follow, we have to write some additional code to give our users the behavior they expect.</p>
<h3 id="step-1-create-a-backbone.js-router">Step 1: Create a Backbone.js Router</h3>
<p>So far we’ve looked at three Backbone.js components, Models, Collections, and Views, all of which may be helpful in any JavaScript application. The fourth component, the <em>Router,</em> is especially helpful for single page applications. You won’t be surprised to learn that we can use Yeoman to create the scaffolding for a Router.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash">$ <span class="kw">yo</span> backbone:router app 
   <span class="kw">create</span> app/scripts/routes/app.js
   <span class="kw">invoke</span>   backbone-mocha:router
   <span class="kw">create</span>     test/routers/app.spec.js</code></pre></td></tr></table>
<p>Notice that we’ve named our router <code>app</code>. As you might expect from this name, we’re using this router as the main controller for our application. That approach has pros and cons. Some developers feel that a router should be limited strictly to routing, while others view the router as the natural place to coordinate the overall application. For a simple example such as our’s, there isn’t really any harm in adding a bit of extra code to the router to control the app. In complex applications, however, it might be better to separate routing from application control. One of the nice things about Backbone.js is that it’s happy to support either approach.</p>
<p>With the scaffolding in place, we can start adding our router code to the <code>app.js</code> file. The first property we’ll define are the <code>routes</code>. This property is an object whose keys are URL fragments and whose values are methods of the router. Here’s our starting point.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Routers</span>.<span class="fu">App</span> = <span class="ot">Backbone</span>.<span class="ot">Router</span>.<span class="fu">extend</span>({
    <span class="dt">routes</span>: {
        <span class="st">&#39;&#39;</span>:         <span class="st">&#39;summary&#39;</span>,
        <span class="st">&#39;runs/:id&#39;</span>: <span class="st">&#39;details&#39;</span>
    },
});</code></pre></td></tr></table>
<p>The first route has an empty URL fragment (<code>''</code>). When a user visits our page without specifying a path, the Router will call its <code>summary</code> method. If, for example, we were hosting our app using the <code>greatrunningapp.com</code> domain name, then users entering <code>http://greatrunningapp.com</code> in their browsers would trigger that route. Before we look at the second route, let’s see what the <code>summary</code> method does.</p>
<p>The code is exactly what we’ve seen before. The <code>summary</code> method creates a new Runs Collection, fetches that collection, creates a Summary View of the collection, and renders that view onto the page. Users visiting the home page for our app will see a summary of their runs on the page.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">summary: <span class="kw">function</span>() {
    <span class="kw">this</span>.<span class="fu">runs</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span>([], {<span class="dt">authorizationToken</span>: <span class="st">&#39;authorize me&#39;</span>});
    <span class="kw">this</span>.<span class="ot">runs</span>.<span class="fu">fetch</span>();
    <span class="kw">this</span>.<span class="fu">summaryView</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Summary</span>({<span class="dt">collection</span>: <span class="kw">this</span>.<span class="fu">runs</span>});
    <span class="fu">$</span>(<span class="st">&#39;body&#39;</span>).<span class="fu">html</span>(<span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="fu">render</span>().<span class="fu">el</span>);
},</code></pre></td></tr></table>
<p>Now we can consider our second route. It has a URL fragment of <code>runs/:id</code>. The <code>runs/</code> part is a standard URL path while <code>:id</code> is how Backbone.js identifies an arbitrary variable. With this route we’re telling Backbone.js to look for a URL that starts out as <code>http://greatrunningapp.com/runs/</code> and to consider whatever follows as the value for the <code>id</code> parameter. We’ll use that parameter in the router’s <code>details</code> method. Here’s how we’ll start the development of that method.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">details: <span class="kw">function</span>(id) {
    <span class="kw">this</span>.<span class="fu">run</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span>();
    <span class="kw">this</span>.<span class="ot">run</span>.<span class="fu">id</span> = id;
    <span class="kw">this</span>.<span class="ot">run</span>.<span class="fu">fetch</span>();
    <span class="kw">this</span>.<span class="fu">detailsView</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Details</span>({<span class="dt">model</span>: <span class="kw">this</span>.<span class="fu">run</span>});
    <span class="fu">$</span>(<span class="st">&#39;body&#39;</span>).<span class="fu">html</span>(<span class="kw">this</span>.<span class="ot">detailsView</span>.<span class="fu">render</span>().<span class="fu">el</span>);
    },</code></pre></td></tr></table>
<p>As you can see, the code is almost the same as the summary method, except we’re only showing a single run instead of the whole collection. We create a new Run model, set its <code>id</code> to the value in the URL, fetch the model from the server, create a Details view, and render that view on the page.</p>
<p>The router lets users go straight to an individual run by using the appropriate URL. A URL of <code>http://greatrunningapp.com/runs/2126456911</code>, for example, will fetch and display the details for the run that has an <code>activityId</code> equal <code>2126456911</code>. Notice that the router doesn’t have to worry about what specific attribute defines the model’s unique identifier. It uses the generic <code>id</code> property. Only the model itself needs to know the actual property name that the server uses.</p>
<p>With the router in place, our single page application can support multiple URLs. One shows a summary of all runs while others show the details of a specific run. Because the URLs are distinct, our users can treat them just like different web pages. They can bookmark them; they can email them, or they can share them on social networks. And whenever they or their friends return to a URL, it will show the same contents as before. That’s exactly how users expect the web to behave.</p>
<p>There is another behavior that users expect, though, that we haven’t yet supported. Users expect to use their browser’s back and forward buttons to navigate through their browsing histories. Fortunately, Backbone.js has a utility that takes care of that functionality. It’s the <em>history</em> feature, and we can enable it during the app Router’s initialization.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Routers</span>.<span class="fu">App</span> = <span class="ot">Backbone</span>.<span class="ot">Router</span>.<span class="fu">extend</span>({
    <span class="dt">initialize</span>: <span class="kw">function</span>() {
        <span class="ot">Backbone</span>.<span class="ot">history</span>.<span class="fu">start</span>({<span class="dt">pushState</span>: <span class="kw">true</span>});
    },</code></pre></td></tr></table>
<p>For our simple app, that’s all we have to do to handle browsing histories. Backbone.js takes care of everything else.</p>
<blockquote>
<p>Support for multiple URLs will probably require some configuration of your web server. More specifically, you’ll want the server to map all URLs to the same <code>index.html</code> file. The details of this configuration depend on the web server technology. With open source apache servers, the <code>.htaccess</code> file can define the mapping.</p>
</blockquote>
<h3 id="step-2-support-run-models-outside-of-any-collection">Step 2: Support Run Models Outside of Any Collection</h3>
<p>Unfortunately, if we try to use the code above with our existing Run model, we’ll run into some problems. First among them is the fact that our Run model relies on its parent collection. It finds the authorization token, for example, using <code>this.collection.settings.authorization_token</code>. When the browser goes directly to the URL for a specific run, however, there won’t be a collection. We can fix by providing the token to the Run model when we create it. We can also make its value an option passed to the router on creation. Here’s the code that results.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Routers</span>.<span class="fu">App</span> = <span class="ot">Backbone</span>.<span class="ot">Router</span>.<span class="fu">extend</span>({
    <span class="dt">routes</span>: {
        <span class="st">&#39;&#39;</span>:         <span class="st">&#39;summary&#39;</span>,
        <span class="st">&#39;runs/:id&#39;</span>: <span class="st">&#39;details&#39;</span>
    },
    <span class="dt">initialize</span>: <span class="kw">function</span>(options) {
        <span class="kw">this</span>.<span class="fu">options</span> = options;
        <span class="ot">Backbone</span>.<span class="ot">history</span>.<span class="fu">start</span>({<span class="dt">pushState</span>: <span class="kw">true</span>});
    },
    <span class="dt">summary</span>: <span class="kw">function</span>() {
        <span class="kw">this</span>.<span class="fu">runs</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span>([], {<span class="dt">authorizationToken</span>: <span class="kw">this</span>.<span class="ot">options</span>.<span class="fu">token</span>});
        <span class="kw">this</span>.<span class="ot">runs</span>.<span class="fu">fetch</span>();
        <span class="kw">this</span>.<span class="fu">summaryView</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Summary</span>({<span class="dt">collection</span>: <span class="kw">this</span>.<span class="fu">runs</span>});
        <span class="fu">$</span>(<span class="st">&#39;body&#39;</span>).<span class="fu">html</span>(<span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="fu">render</span>().<span class="fu">el</span>);
    },
    <span class="dt">details</span>: <span class="kw">function</span>(id) {
        <span class="kw">this</span>.<span class="fu">run</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span>({}, {<span class="dt">authorizationToken</span>: <span class="kw">this</span>.<span class="ot">options</span>.<span class="fu">token</span>});
        <span class="kw">this</span>.<span class="ot">run</span>.<span class="fu">id</span> = id;
        <span class="kw">this</span>.<span class="ot">run</span>.<span class="fu">fetch</span>();
        <span class="kw">this</span>.<span class="fu">detailsView</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Details</span>({<span class="dt">model</span>: <span class="kw">this</span>.<span class="fu">run</span>});
        <span class="fu">$</span>(<span class="st">&#39;body&#39;</span>).<span class="fu">html</span>(<span class="kw">this</span>.<span class="ot">detailsView</span>.<span class="fu">render</span>().<span class="fu">el</span>);
});</code></pre></td></tr></table>
<p>Now we need to modify the Run model to use this new parameter. We’ll handle the token the same way we do in the Runs collection. We start by defining default values for all the settings. Unlike the collection, the only setting our model needs is the <code>authorization_token</code>. Next we make sure that we have an <code>options</code> object. If none was provided, we create an empty one. For the third step we check to see if the model is part of a collection. We can do that by looking at <code>this.collection</code>. If that property exists, then we grab any settings from the collection and override our defaults. The final step overrides the result with any settings passed to our constructor as options. When, as in the code above, our router provides an <code>authorization_token</code> value, that’s the value our model will use. When the model is part of a collection, there is no specific token associated with the model. In that case we fall back to the collection’s token.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span> = <span class="ot">Backbone</span>.<span class="ot">Model</span>.<span class="fu">extend</span>({
    <span class="dt">initialize</span>: <span class="kw">function</span>(attrs, options) {
        <span class="kw">this</span>.<span class="fu">settings</span> = {  <span class="dt">authorization_token</span>: <span class="st">&#39;&#39;</span> };
        options = options || {};
        <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">collection</span>) {
            <span class="fu">_</span>(<span class="kw">this</span>.<span class="fu">settings</span>).<span class="fu">extend</span>(<span class="fu">_</span>(<span class="kw">this</span>.<span class="ot">collection</span>.<span class="fu">settings</span>)
                .<span class="fu">pick</span>(<span class="fu">_</span>(<span class="kw">this</span>.<span class="fu">settings</span>).<span class="fu">keys</span>()));
        }
        <span class="fu">_</span>(<span class="kw">this</span>.<span class="fu">settings</span>).<span class="fu">extend</span>(<span class="fu">_</span>(options)
            .<span class="fu">pick</span>(<span class="fu">_</span>(<span class="kw">this</span>.<span class="fu">settings</span>).<span class="fu">keys</span>()));
    },</code></pre></td></tr></table>
<p>Now that we have an authorization token, we can add it to the model’s AJAX requests. The code is again pretty much the same as our code in the Runs collection. We’ll need a property that specifies the URL for the REST service, and we’ll need to override the regular <code>sync</code> method to add the token to any requests.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">urlRoot: <span class="st">&#39;https://api.nike.com/v1/me/sport/activities&#39;</span>,

sync: <span class="kw">function</span>(method, model, options) {
    options = options || {};
    <span class="fu">_</span>(options).<span class="fu">extend</span>({
        <span class="dt">data</span>: { <span class="dt">authorization_token</span>: <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">authorization_token</span> }
    });
    <span class="ot">Backbone</span>.<span class="fu">sync</span>(method, model, options);
},</code></pre></td></tr></table>
<p>This extra code takes care of the authorization, but there’s still a problem with our model. In the previous section Run models only existed as part of a Runs collection, and the act of fetching that collection populated each of its models with summary attributes including, for example, <code>isGpsActivity</code>. The model could safely check that property whenever we tried to fetch the model details and, if appropriate, simultaneously initiate a request for the GPS data. Now, however, we’re creating a Run model on its own without the benefit of a collection. When we fetch the model, the only property we’ll know is the unique identifier. We can’t decide whether or not to request GPS data, therefore until after the server responds to the fetch.</p>
<p>To separate the request for GPS data from the general fetch we can move that request to its own method. The code is the same as before (except, of course, we get the authorization token from local settings).</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">fetchGps: <span class="kw">function</span>() {
    <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">get</span>(<span class="st">&#39;isGpsActivity&#39;</span>) &amp;&amp; !<span class="kw">this</span>.<span class="fu">get</span>(<span class="st">&#39;gps&#39;</span>)) {
        <span class="kw">var</span> model = <span class="kw">this</span>;
        <span class="ot">$</span>.<span class="fu">getJSON</span>(
            <span class="kw">this</span>.<span class="fu">url</span>() + <span class="st">&#39;/gps&#39;</span>,
            { <span class="dt">authorization_token</span>: <span class="kw">this</span>.<span class="ot">settings</span>.<span class="fu">authorization_token</span> },
            <span class="kw">function</span>(data) { <span class="ot">model</span>.<span class="fu">set</span>(<span class="st">&#39;gps&#39;</span>, data); }
        );
    }
}</code></pre></td></tr></table>
<p>To trigger this method, we can add one more statement to the model’s initialization. We’ll tell Backbone.js that whenever the model changes, call the <code>fetchGps</code> method. Backbone.js will detect just such a change when the <code>fetch</code> response arrives and populates the model, at which time our code can safely check <code>isGpsActivity</code> and make the additional request.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">initialize: <span class="kw">function</span>(attrs, options) {
    <span class="kw">this</span>.<span class="fu">on</span>(<span class="st">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">fetchGps</span>, <span class="kw">this</span>);</code></pre></td></tr></table>
<h3 id="step-3-let-users-change-views">Step 3: Let Users Change Views</h3>
<p>Now that our app can correctly display two different views, it’s time to let our users in on the fun. For this step, we’ll give them an easy way to change back and forth between the views. Let’s first consider the summary view. It would be nice if a user could click on any run that appears in the table and be instantly taken to the detailed view for that run.</p>
<p>Our first decision is where to put the code that listens for clicks. At first thought, it might seem like the SummaryRow view is a natural place for that code. That view is responsible for rendering the row, so it seems logical to let that view handle events related to the row. If we wanted to do that, Backbone.js makes it very simple. All we need is an extra property and an extra method in the view. They could look like the following.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">SummaryRow</span> = <span class="ot">Backbone</span>.<span class="ot">View</span>.<span class="fu">extend</span>({
    <span class="dt">events</span>: {
        <span class="st">&#39;click&#39;</span>: <span class="st">&#39;clicked&#39;</span>
    },
    <span class="dt">clicked</span>: <span class="kw">function</span>() {
        <span class="co">// Do something to show the Details view for this.model</span>
    },</code></pre></td></tr></table>
<p>The <code>events</code> property is an object that lists the events of interest to our view. In this case there’s only one, and it is the <code>click</code> event. The value, in this case <code>clicked</code> identifies the method that Backbone.js should call when the event occurs. We’ve skipped the details of that method for now.</p>
<p>There is nothing technically wrong with this approach, and if we were to continue the implementation it would probably work just fine. It is, however, very inefficient. Consider a user that has hundreds of runs stored on Nike+. Their summary table would have hundreds of rows, and each row would have its own function listening for <code>click</code> events. Those event handlers can use up a lot of memory and other resources in the browser and make our app sluggish. Fortunately there’s a different approach that’s far less stressful to the browser.</p>
<p>Instead of having potentially hundreds of event handlers each listening for clicks on a single row, we’d be better off with one event handler listening for clicks on all of the table rows. Since the Summary view is responsible for all of those rows, it’s the natural place to add that handler. We can still take advantage of Backbone.js to make its implementation easy by adding an <code>events</code> object to our view. In this case we can do even better, though. We don’t care about <code>click</code> events on the table header; only the rows in the table body matter. By adding a jQuery-style selector after the event name we can restrict our handler to elements that match that selector.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Summary</span> = <span class="ot">Backbone</span>.<span class="ot">View</span>.<span class="fu">extend</span>({
    <span class="dt">events</span>: {
        <span class="st">&#39;click tbody&#39;</span>: <span class="st">&#39;clicked&#39;</span>
    },</code></pre></td></tr></table>
<p>The code above asks Backbone.js to watch for <code>click</code> events within the <code>&lt;tbody&gt;</code> element of our view. When an event occurs, Backbone.js will call the <code>clicked</code> method of our view.</p>
<p>Before we develop any code for that <code>clicked</code> method, we’re going to need a way for it to figure out which specific run model the user has selected. The event handler will be able to tell which row the user clicked, but how will it know which model that row represents? To make the answer easy for the handler, we can embed the necessary information directly in the markup for the row. That requires a few small adjustments to the <code>renderRun</code> method we created earlier.</p>
<p>The revised method still creates a SummaryRow view for each model, renders that view, and appends the result to the table body. Now, though, we’ll add one extra step just before the row is added to the page. We add a special attribute, <code>data-id</code>, to the row and set its value equal to the model’s unique identifier. We use <code>data-id</code> because the HTML5 standard allows any attribute with a name that begins <code>data-</code>. Custom attributes in this form won’t violate the standard and won’t cause browser errors.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">renderRun: <span class="kw">function</span> (run) {
    <span class="kw">var</span> row = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">SummaryRow</span>({ <span class="dt">model</span>: run });
    <span class="ot">row</span>.<span class="fu">render</span>();
    <span class="ot">row</span>.<span class="ot">$el</span>.<span class="fu">attr</span>(<span class="st">&#39;data-id&#39;</span>, <span class="ot">run</span>.<span class="fu">id</span>);
    <span class="kw">this</span>.<span class="fu">$</span>(<span class="st">&#39;tbody&#39;</span>).<span class="fu">append</span>(<span class="ot">row</span>.<span class="fu">$el</span>);
},</code></pre></td></tr></table>
<p>The resulting markup for a run with an identifier of <code>2126456911</code> would look like the following example.</p>
<table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="kw">&lt;tr</span><span class="ot"> data-id=</span><span class="st">&quot;2126456911&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;td&gt;</span>04/09/2013<span class="kw">&lt;/td&gt;</span>
    <span class="kw">&lt;td&gt;</span>0:22:39<span class="kw">&lt;/td&gt;</span>
    <span class="kw">&lt;td&gt;</span>2.33 Miles<span class="kw">&lt;/td&gt;</span>
    <span class="kw">&lt;td&gt;</span>240<span class="kw">&lt;/td&gt;</span>
    <span class="kw">&lt;td&gt;</span>9:43<span class="kw">&lt;/td&gt;</span>
<span class="kw">&lt;/tr&gt;</span></code></pre></td></tr></table>
<p>Once we’ve made sure that the markup in the page has a reference back to the run models, we can take advantage of that markup in our <code>clicked</code> event handler. When Backbone.js calls the handler, it passes it an event object. From that object we can find the target of the event. In the case of a <code>click</code> event, the target is the HTML element on which the user clicked.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">clicked: <span class="kw">function</span> (ev) {
    <span class="kw">var</span> $target = <span class="fu">$</span>(<span class="ot">ev</span>.<span class="fu">target</span>)</code></pre></td></tr></table>
<p>From the markup shown above, it’s clear that most of the table row is made up of table cells (<code>&lt;td&gt;</code> elements), and so a table cell will be the likely target of the click event. We can use the jQuery <code>parents</code> function to find the table row that is the parent of the click target. Once we’ve found that row, it’s an easy matter to extract the <code>data-id</code> attribute value. To be on the safe side we’ll also handle the case in which the user somehow manages to click on the table row itself rather than an individual table cell.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">clicked: <span class="kw">function</span> (ev) {
    <span class="kw">var</span> $target = <span class="fu">$</span>(<span class="ot">ev</span>.<span class="fu">target</span>)
    <span class="kw">var</span> id = <span class="ot">$target</span>.<span class="fu">attr</span>(<span class="st">&#39;data-id&#39;</span>) || <span class="ot">$target</span>.<span class="fu">parents</span>(<span class="st">&#39;[data-id]&#39;</span>).<span class="fu">attr</span>(<span class="st">&#39;data-id&#39;</span>);</code></pre></td></tr></table>
<p>After retrieving the attribute value our view knows which run the user selected; now it has to do something with the information. Though it might be tempting to have the Summary view directly render the Details view for the run, that action would not be appropriate. A Backbone.js view should only take responsibility for itself and any child views that it contains. That approach allows the view to be safely re-used in a variety of contexts. Our Summary view, for example, might well be used in a context in which the Details view wasn’t even available. In that case trying to switch directly to the Details view would, at best, generate an error.</p>
<p>Because the Summary view cannot itself respond to the user clicking on a table row, it should instead follow the hierarchy of the application and, in effect, pass the information “up the chain of command.” Backbone.js provides a convenient mechanism for this type of communication: custom events. Instead of responding directly to the user click, the Summary view triggers a custom event. Other parts can listen for this event and respond appropriately. If no other code is listening for the event, then nothing happens, but at least the Summary view can say that it’s done its job.</p>
<p>Here’s how we can generate a custom event in our view. We’re calling the event <code>select</code> to indicate that the user has selected a specific run, and we’re passing the identifier of that run as a parameter associated with the event. At this point the Summary view is complete.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">clicked: <span class="kw">function</span> (ev) {
    <span class="kw">var</span> $target = <span class="fu">$</span>(<span class="ot">ev</span>.<span class="fu">target</span>)
    <span class="kw">var</span> id = <span class="ot">$target</span>.<span class="fu">attr</span>(<span class="st">&#39;data-id&#39;</span>) || <span class="ot">$target</span>.<span class="fu">parents</span>(<span class="st">&#39;[data-id]&#39;</span>).<span class="fu">attr</span>(<span class="st">&#39;data-id&#39;</span>);
    <span class="kw">this</span>.<span class="fu">trigger</span>(<span class="st">&#39;select&#39;</span>, id);
}</code></pre></td></tr></table>
<p>The component that should respond to this custom event is the same component that created the Summary view in the first place; that’s our app router. We’ll first need to listen for the event. We can do that right after we create it in the <code>summary</code> method.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Routers</span>.<span class="fu">App</span> = <span class="ot">Backbone</span>.<span class="ot">Router</span>.<span class="fu">extend</span>({
    <span class="dt">summary</span>: <span class="kw">function</span>() {
        <span class="kw">this</span>.<span class="fu">runs</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span>([], {<span class="dt">authorizationToken</span>: <span class="kw">this</span>.<span class="ot">options</span>.<span class="fu">token</span>});
        <span class="kw">this</span>.<span class="ot">runs</span>.<span class="fu">fetch</span>();
        <span class="kw">this</span>.<span class="fu">summaryView</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Summary</span>({<span class="dt">collection</span>: <span class="kw">this</span>.<span class="fu">runs</span>});
        <span class="fu">$</span>(<span class="st">&#39;body&#39;</span>).<span class="fu">html</span>(<span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="fu">render</span>().<span class="fu">el</span>);
        <span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="fu">on</span>(<span class="st">&#39;select&#39;</span>, <span class="kw">this</span>.<span class="fu">selected</span>, <span class="kw">this</span>);
    },</code></pre></td></tr></table>
<p>When the user selects a specific run from the summary view, Backbone.js calls our router’s <code>selected</code> method. That method will receive any event data as parameters. In our case the event data is the unique identifier, so that becomes the method’s parameter.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Routers</span>.<span class="fu">App</span> = <span class="ot">Backbone</span>.<span class="ot">Router</span>.<span class="fu">extend</span>({
    <span class="dt">selected</span>: <span class="kw">function</span>(id) {
        <span class="kw">this</span>.<span class="fu">navigate</span>(<span class="st">&#39;runs/&#39;</span> + id, { <span class="dt">trigger</span>: <span class="kw">true</span> });
    }</code></pre></td></tr></table>
<p>As you can see, the event handler code is quite simple. It constructs a URL that corresponds to the Details view (<code>'runs/' + id</code>) and passes that URL to the router’s own <code>navigate</code> method. That method updates the browser’s navigation history. The second parameter (<code>{ trigger: true }</code>) tells Backbone.js to also act as if the user had actually navigated to the URL. Because we’ve set up the <code>details</code> method to respond to URLs of the form <code>runs/:id</code>, Backbone.js will call <code>details</code> and our router will show the details for the selected run.</p>
<p>When users are looking at a Detailed view, we’d also like to let them easily navigate to the Summary view. A button in details template will serve for this demonstration. As with the Summary view, we can add an event handler for the button and trigger a custom event when a user clicks it.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Details</span> = <span class="ot">Backbone</span>.<span class="ot">View</span>.<span class="fu">extend</span>({
    <span class="dt">events</span>: {
        <span class="st">&#39;click button&#39;</span>: <span class="st">&#39;clicked&#39;</span>
    },
    <span class="dt">clicked</span>: <span class="kw">function</span> () {
        <span class="kw">this</span>.<span class="fu">trigger</span>(<span class="st">&#39;summarize&#39;</span>);
    }</code></pre></td></tr></table>
<p>And, of course, we need to listen for that custom event in our router.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Routers</span>.<span class="fu">App</span> = <span class="ot">Backbone</span>.<span class="ot">Router</span>.<span class="fu">extend</span>({
    <span class="dt">details</span>: <span class="kw">function</span>(id) {
        <span class="co">// Set up the Details view</span>
        <span class="co">// Code continues...</span>
        <span class="kw">this</span>.<span class="ot">detailsView</span>.<span class="fu">on</span>(<span class="st">&#39;summarize&#39;</span>, <span class="kw">this</span>.<span class="fu">summarize</span>, <span class="kw">this</span>);
    },
    <span class="dt">summarize</span>: <span class="kw">function</span>() {
        <span class="kw">this</span>.<span class="fu">navigate</span>(<span class="st">&#39;&#39;</span>, { <span class="dt">trigger</span>: <span class="kw">true</span> });
    },</code></pre></td></tr></table>
<p>Once again we respond to the user by constructing an appropriate URL and triggering a navigation to it.</p>
<p>You might be wondering why we have to explicitly trigger the navigation change. Shouldn’t that be the default behavior? Although that may seem reasonable in most cases it wouldn’t be appropriate. Our application is simple enough that triggering the route works fine. More complex applications, however, probably want to take different actions depending on whether the user performs an action within the app or navigates directly to a particular URL. It’s better to have different code handling each of those cases. In the first case the app would still want to update the browser’s history, but it wouldn’t want to trigger a full navigation action.</p>
<h3 id="step-4-fine-tuning-the-application">Step 4: Fine-Tuning the Application</h3>
<p>At this point our app is completely functional. Our users can view their summaries, bookmark and share details of specific runs, and navigate the app using the browser’s back and forward buttons. Before we can call it complete, however, there’s one last bit of housekeeping for us. The app’s performance isn’t optimal, and, even more critically, it <em>leaks</em> memory, using small amounts of the browser’s memory without ever releasing them.</p>
<p>The most obvious problem is in the router’s <code>summary</code> method, reproduced below.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="ot">Running</span>.<span class="ot">Routers</span>.<span class="fu">App</span> = <span class="ot">Backbone</span>.<span class="ot">Router</span>.<span class="fu">extend</span>({
    <span class="dt">summary</span>: <span class="kw">function</span>() {
        <span class="kw">this</span>.<span class="fu">runs</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span>([], {<span class="dt">authorizationToken</span>: <span class="kw">this</span>.<span class="ot">options</span>.<span class="fu">token</span>});
        <span class="kw">this</span>.<span class="ot">runs</span>.<span class="fu">fetch</span>();
        <span class="kw">this</span>.<span class="fu">summaryView</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Summary</span>({<span class="dt">collection</span>: <span class="kw">this</span>.<span class="fu">runs</span>});
        <span class="fu">$</span>(<span class="st">&#39;body&#39;</span>).<span class="fu">html</span>(<span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="fu">render</span>().<span class="fu">el</span>);
        <span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="fu">on</span>(<span class="st">&#39;select&#39;</span>, <span class="kw">this</span>.<span class="fu">selected</span>, <span class="kw">this</span>);
    },</code></pre></td></tr></table>
<p>Every time this method executes it creates a new collection, fetches that collection, and renders a Summary view for the collection. Clearly we have to go through those steps the first time the method executes, but there is no need to repeat them later. Neither the collection nor its view will have changed if the user selects a specific run and then returns to the summary. Let’s add a check to the method so that we only take those steps if the view doesn’t already exist.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">summary: <span class="kw">function</span>() {
    <span class="kw">if</span> (!<span class="kw">this</span>.<span class="fu">summaryView</span>) {
        <span class="kw">this</span>.<span class="fu">runs</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span>([], {<span class="dt">authorizationToken</span>: <span class="kw">this</span>.<span class="ot">options</span>.<span class="fu">token</span>});
        <span class="kw">this</span>.<span class="ot">runs</span>.<span class="fu">fetch</span>();
        <span class="kw">this</span>.<span class="fu">summaryView</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Summary</span>({<span class="dt">collection</span>: <span class="kw">this</span>.<span class="fu">runs</span>});
        <span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="fu">render</span>();
        <span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="fu">on</span>(<span class="st">&#39;select&#39;</span>, <span class="kw">this</span>.<span class="fu">selected</span>, <span class="kw">this</span>);
    }
    <span class="fu">$</span>(<span class="st">&#39;body&#39;</span>).<span class="fu">html</span>(<span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="fu">el</span>);
},</code></pre></td></tr></table>
<p>We can also add a check in the <code>details</code> method. When that method executes and a Summary view is present, we can “set aside” the summary view’s markup using jQuery’s <code>detach</code> function. That will keep the markup and its event handlers ready for a quick re-insertion onto the page should the user return to the summary.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">details: <span class="kw">function</span>(id) {
    <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">summaryView</span>) {
        <span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="ot">$el</span>.<span class="fu">detach</span>();
    }
    <span class="kw">this</span>.<span class="fu">run</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span>({}, {<span class="dt">authorizationToken</span>: <span class="kw">this</span>.<span class="ot">options</span>.<span class="fu">token</span>});
    <span class="kw">this</span>.<span class="ot">run</span>.<span class="fu">id</span> = id;
    <span class="kw">this</span>.<span class="ot">run</span>.<span class="fu">fetch</span>();
    <span class="fu">$</span>(<span class="st">&#39;body&#39;</span>).<span class="fu">html</span>(<span class="kw">this</span>.<span class="ot">detailsView</span>.<span class="fu">render</span>().<span class="fu">el</span>);
    <span class="kw">this</span>.<span class="ot">detailsView</span>.<span class="fu">on</span>(<span class="st">&#39;summarize&#39;</span>, <span class="kw">this</span>.<span class="fu">summarize</span>, <span class="kw">this</span>);
},</code></pre></td></tr></table>
<p>Those changes make switching to and from the summary view more efficient. We can also make some similar changes for the details view. In the <code>details</code> method we don’t have to fetch the run if it’s already present in the collection. We can add a check and, if the data for the run is already available, we won’t bother with the fetch.</p>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">details: <span class="kw">function</span>(id) {
    <span class="kw">if</span> (!<span class="kw">this</span>.<span class="fu">runs</span> || !(<span class="kw">this</span>.<span class="fu">run</span> = <span class="kw">this</span>.<span class="ot">runs</span>.<span class="fu">get</span>(id))) {
        <span class="kw">this</span>.<span class="fu">run</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Models</span>.<span class="fu">Run</span>({}, {<span class="dt">authorizationToken</span>: <span class="kw">this</span>.<span class="ot">options</span>.<span class="fu">token</span>});
        <span class="kw">this</span>.<span class="ot">run</span>.<span class="fu">id</span> = id;
        <span class="kw">this</span>.<span class="ot">run</span>.<span class="fu">fetch</span>();
    }
    <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">summaryView</span>) {
        <span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="ot">$el</span>.<span class="fu">detach</span>();
    }
    <span class="kw">this</span>.<span class="fu">detailsView</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Details</span>({<span class="dt">model</span>: <span class="kw">this</span>.<span class="fu">run</span>});
    <span class="fu">$</span>(<span class="st">&#39;body&#39;</span>).<span class="fu">html</span>(<span class="kw">this</span>.<span class="ot">detailsView</span>.<span class="fu">render</span>().<span class="fu">el</span>);
    <span class="kw">this</span>.<span class="ot">detailsView</span>.<span class="fu">on</span>(<span class="st">&#39;summarize&#39;</span>, <span class="kw">this</span>.<span class="fu">summarize</span>, <span class="kw">this</span>);
},</code></pre></td></tr></table>
<p>In the <code>summary</code> method we don’t want to simply set aside the details view as we did for the summary view. That’s because there may be hundreds of detail views hanging around if a user starts looking at all of runs available. Instead, we want to cleanly delete the details view. That lets the browser know that it can release any memory that the view is consuming. As you can see from the code below, we’ll do that in three steps.</p>
<ol type="1">
<li>Remove the event handler we added to the details view to catch <code>summarize</code> events.</li>
<li>Call the view’s <code>remove</code> method so it releases any memory it’s holding internally.</li>
<li>Set <code>this.detailsView</code> to <code>null</code> to indicate that the view no longer exists.</li>
</ol>
<table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">summary: <span class="kw">function</span>() {
    <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">detailsView</span>) {
        <span class="kw">this</span>.<span class="ot">detailsView</span>.<span class="fu">off</span>(<span class="st">&#39;summarize&#39;</span>);
        <span class="kw">this</span>.<span class="ot">detailsView</span>.<span class="fu">remove</span>();
        <span class="kw">this</span>.<span class="fu">detailsView</span> = <span class="kw">null</span>;
    }
    <span class="kw">if</span> (!<span class="kw">this</span>.<span class="fu">summaryView</span>) {
        <span class="kw">this</span>.<span class="fu">runs</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Collections</span>.<span class="fu">Runs</span>([], {<span class="dt">authorizationToken</span>: <span class="kw">this</span>.<span class="ot">options</span>.<span class="fu">token</span>});
        <span class="kw">this</span>.<span class="ot">runs</span>.<span class="fu">fetch</span>();
        <span class="kw">this</span>.<span class="fu">summaryView</span> = <span class="kw">new</span> <span class="ot">Running</span>.<span class="ot">Views</span>.<span class="fu">Summary</span>({<span class="dt">collection</span>: <span class="kw">this</span>.<span class="fu">runs</span>});
        <span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="fu">render</span>();
        <span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="fu">on</span>(<span class="st">&#39;select&#39;</span>, <span class="kw">this</span>.<span class="fu">selected</span>, <span class="kw">this</span>);
    }
    <span class="fu">$</span>(<span class="st">&#39;body&#39;</span>).<span class="fu">html</span>(<span class="kw">this</span>.<span class="ot">summaryView</span>.<span class="fu">el</span>);
},</code></pre></td></tr></table>
<p>And with that change our application is complete. You can take a look at the complete result in the book’s source code.## Summing Up</p>
<p>In this chapter we’ve seen how to build an entire web application based on data and data visualizations. To help organize and coordinate our application we based it on the Backbone.js library, and we relied on the Yeoman tool to create the application’s scaffolding and boilerplate code and templates. Backbone.js lets us separate our application into models and views so that the code responsible for managing the data doesn’t have to worry about how that data is presented (and vice versa). It also gives us the flexibility to interact with REST APIs that don’t quite follow the normal conventions. The final Backbone.js component that we considered, the router, provided the support we needed to make sure our single page application behaves like a full web site so that our users can interact with it just as they would expect.</p>
        </main>
        <footer>
            <small>Copyright © 2012-2014 by Stephen A. Thomas. All Rights Reserved.</small>
        </footer>
    <script src="js/scripts.min.js"></script>
   </body>
</html>